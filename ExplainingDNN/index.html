<!DOCTYPE html>
<html lang="en"><head>
<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/tabby.min.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-html.min.css" rel="stylesheet" data-mode="light">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="index_files/libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="index_files/libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.5.55">

  <meta name="author" content="Brian Cervantes Alvarez">
  <title>LeNet-Driven CNN Explainability through ExcitationBP Heat-Maps and Sparse Concepts using XNN + SRAE</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="index_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="index_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="index_files/libs/revealjs/dist/theme/quarto.css">
  <link href="index_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">

  .callout {
    margin-top: 1em;
    margin-bottom: 1em;  
    border-radius: .25rem;
  }

  .callout.callout-style-simple { 
    padding: 0em 0.5em;
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
    display: flex;
  }

  .callout.callout-style-default {
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
  }

  .callout .callout-body-container {
    flex-grow: 1;
  }

  .callout.callout-style-simple .callout-body {
    font-size: 1rem;
    font-weight: 400;
  }

  .callout.callout-style-default .callout-body {
    font-size: 0.9rem;
    font-weight: 400;
  }

  .callout.callout-titled.callout-style-simple .callout-body {
    margin-top: 0.2em;
  }

  .callout:not(.callout-titled) .callout-body {
      display: flex;
  }

  .callout:not(.no-icon).callout-titled.callout-style-simple .callout-content {
    padding-left: 1.6em;
  }

  .callout.callout-titled .callout-header {
    padding-top: 0.2em;
    margin-bottom: -0.2em;
  }

  .callout.callout-titled .callout-title  p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
    
  .callout.callout-titled.callout-style-simple .callout-content  p {
    margin-top: 0;
  }

  .callout.callout-titled.callout-style-default .callout-content  p {
    margin-top: 0.7em;
  }

  .callout.callout-style-simple div.callout-title {
    border-bottom: none;
    font-size: .9rem;
    font-weight: 600;
    opacity: 75%;
  }

  .callout.callout-style-default  div.callout-title {
    border-bottom: none;
    font-weight: 600;
    opacity: 85%;
    font-size: 0.9rem;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-default div.callout-content {
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-simple .callout-icon::before {
    height: 1rem;
    width: 1rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .callout.callout-style-default .callout-icon::before {
    height: 0.9rem;
    width: 0.9rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 0.9rem 0.9rem;
  }

  .callout-title {
    display: flex
  }
    
  .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  .callout.no-icon::before {
    display: none !important;
  }

  .callout.callout-titled .callout-body > .callout-content > :last-child {
    padding-bottom: 0.5rem;
    margin-bottom: 0;
  }

  .callout.callout-titled .callout-icon::before {
    margin-top: .5rem;
    padding-right: .5rem;
  }

  .callout:not(.callout-titled) .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  /* Callout Types */

  div.callout-note {
    border-left-color: #4582ec !important;
  }

  div.callout-note .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEU0lEQVRYCcVXTWhcVRQ+586kSUMMxkyaElstCto2SIhitS5Ek8xUKV2poatCcVHtUlFQk8mbaaziwpWgglJwVaquitBOfhQXFlqlzSJpFSpIYyXNjBNiTCck7x2/8/LeNDOZxDuEkgOXe++553zfefee+/OYLOXFk3+1LLrRdiO81yNqZ6K9cG0P3MeFaMIQjXssE8Z1JzLO9ls20MBZX7oG8w9GxB0goaPrW5aNMp1yOZIa7Wv6o2ykpLtmAPs/vrG14Z+6d4jpbSKuhdcSyq9wGMPXjonwmESXrriLzFGOdDBLB8Y6MNYBu0dRokSygMA/mrun8MGFN3behm6VVAwg4WR3i6FvYK1T7MHo9BK7ydH+1uurECoouk5MPRyVSBrBHMYwVobG2aOXM07sWrn5qgB60rc6mcwIDJtQrnrEr44kmy+UO9r0u9O5/YbkS9juQckLed3DyW2XV/qWBBB3ptvI8EUY3I9p/67OW+g967TNr3Sotn3IuVlfMLVnsBwH4fsnebJvyGm5GeIUA3jljERmrv49SizPYuq+z7c2H/jlGC+Ghhupn/hcapqmcudB9jwJ/3jvnvu6vu5lVzF1fXyZuZZ7U8nRmVzytvT+H3kilYvH09mLWrQdwFSsFEsxFVs5fK7A0g8gMZjbif4ACpKbjv7gNGaD8bUrlk8x+KRflttr22JEMRUbTUwwDQScyzPgedQHZT0xnx7ujw2jfVfExwYHwOsDTjLdJ2ebmeQIlJ7neo41s/DrsL3kl+W2lWvAga0tR3zueGr6GL78M3ifH0rGXrBC2aAR8uYcIA5gwV8zIE8onoh8u0Fca/ciF7j1uOzEnqcIm59sEXoGc0+z6+H45V1CvAvHcD7THztu669cnp+L0okAeIc6zjbM/24LgGM1gZk7jnRu1aQWoU9sfUOuhrmtaPIO3YY1KLLWZaEO5TKUbMY5zx8W9UJ6elpLwKXbsaZ4EFl7B4bMtDv0iRipKoDQT2sNQI9b1utXFdYisi+wzZ/ri/1m7QfDgEuvgUUEIJPq3DhX/5DWNqIXDOweC2wvIR90Oq3lDpdMIgD2r0dXvGdsEW5H6x6HLRJYU7C69VefO1x8Gde1ZFSJLfWS1jbCnhtOPxmpfv2LXOA2Xk2tvnwKKPFuZ/oRmwBwqRQDcKNeVQkYcOjtWVBuM/JuYw5b6isojIkYxyYAFn5K7ZBF10fea52y8QltAg6jnMqNHFBmGkQ1j+U43HMi2xMar1Nv0zGsf1s8nUsmUtPOOrbFIR8bHFDMB5zL13Gmr/kGlCkUzedTzzmzsaJXhYawnA3UmARpiYj5ooJZiUoxFRtK3X6pgNPv+IZVPcnwbOl6f+aBaO1CNvPW9n9LmCp01nuSaTRF2YxHqZ8DYQT6WsXT+RD6eUztwYLZ8rM+rcPxamv1VQzFUkzFXvkiVrySGQgJNvXHJAxiU3/NwiC03rSf05VBaPtu/Z7/B8Yn/w7eguloAAAAAElFTkSuQmCC');
  }

  div.callout-note.callout-style-default .callout-title {
    background-color: #dae6fb
  }

  div.callout-important {
    border-left-color: #d9534f !important;
  }

  div.callout-important .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEKklEQVRYCcVXTWhcVRS+575MJym48A+hSRFr00ySRQhURRfd2HYjk2SSTokuBCkU2o0LoSKKraKIBTcuFCoidGFD08nkBzdREbpQ1EDNIv8qSGMFUboImMSZd4/f9zJv8ibJMC8xJQfO3HPPPef7zrvvvnvviIkpC9nsw0UttFunbUhpFzFtarSd6WJkStVMw5xyVqYTvkwfzuf/5FgtkVoB0729j1rjXwThS7Vio+Mo6DNnvLfahoZ+i/o32lULuJ3NNiz7q6+pyAUkJaFF6JwaM2lUJlV0MlnQn5aTRbEu0SEqHUa0A4AdiGuB1kFXRfVyg5d87+Dg4DL6m2TLAub60ilj7A1Ec4odSAc8X95sHh7+ZRPCFo6Fnp7HfU/fBng/hi10CjCnWnJjsxvDNxWw0NfV6Rv5GgP3I3jGWXumdTD/3cbEOP2ZbOZp69yniG3FQ9z1jD7bnBu9Fc2tKGC2q+uAJOQHBDRiZX1x36o7fWBs7J9ownbtO+n0/qWkvW7UPIfc37WgT6ZGR++EOJyeQDSb9UB+DZ1G6DdLDzyS+b/kBCYGsYgJbSQHuThGKRcw5xdeQf8YdNHsc6ePXrlSYMBuSIAFTGAtQo+VuALo4BX83N190NWZWbynBjhOHsmNfFWLeL6v+ynsA58zDvvAC8j5PkbOcXCMg2PZFk3q8MjI7WAG/Dp9AwP7jdGBOOQkAvlFUB+irtm16I1Zw9YBcpGTGXYmk3kQIC/Cds55l+iMI3jqhjAuaoe+am2Jw5GT3Nbz3CkE12NavmzN5+erJW7046n/CH1RO/RVa8lBLozXk9uqykkGAyRXLWlLv5jyp4RFsG5vGVzpDLnIjTWgnRy2Rr+tDKvRc7Y8AyZq10jj8DqXdnIRNtFZb+t/ZRtXcDiVnzpqx8mPcDWxgARUqx0W1QB9MeUZiNrV4qP+Ehc+BpNgATsTX8ozYKL2NtFYAHc84fG7ndxUPr+AR/iQSns7uSUufAymwDOb2+NjK27lEFocm/EE2WpyIy/Hi66MWuMKJn8RvxIcj87IM5Vh9663ziW36kR0HNenXuxmfaD8JC7tfKbrhFr7LiZCrMjrzTeGx+PmkosrkNzW94ObzwocJ7A1HokLolY+AvkTiD/q1H0cN48c5EL8Crkttsa/AXQVDmutfyku0E7jShx49XqV3MFK8IryDhYVbj7Sj2P2eBxwcXoe8T8idsKKPRcnZw1b+slFTubwUwhktrfnAt7J++jwQtLZcm3sr9LQrjRzz6cfMv9aLvgmnAGvpoaGLxM4mAEaLV7iAzQ3oU0IvD5x9ix3yF2RAAuYAOO2f7PEFWCXZ4C9Pb2UsgDeVnFSpbFK7/IWu7TPTvBqzbGdCHOJQSxiEjt6IyZmxQyEJHv6xyQsYk//moVFsN2zP6fRImjfq7/n/wFDguUQFNEwugAAAABJRU5ErkJggg==');
  }

  div.callout-important.callout-style-default .callout-title {
    background-color: #f7dddc
  }

  div.callout-warning {
    border-left-color: #f0ad4e !important;
  }

  div.callout-warning .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAETklEQVRYCeVWW2gcVRg+58yaTUnizqbipZeX4uWhBEniBaoUX1Ioze52t7sRq6APio9V9MEaoWlVsFasRq0gltaAPuxms8lu0gcviE/FFOstVbSIxgcv6SU7EZqmdc7v9+9mJtNks51NTUH84ed889/PP+cmxP+d5FIbMJmNbpREu4WUkiTtCicKny0l1pIKmBzovF2S+hIJHX8iEu3hZJ5lNZGqyRrGSIQpq15AzF28jgpeY6yk6GVdrfFqdrD6Iw+QlB8g0YS2g7dyQmXM/IDhBhT0UCiRf59lfqmmDvzRt6kByV/m4JjtzuaujMUM2c5Z2d6JdKrRb3K2q6mA+oYVz8JnDdKPmmNthzkAk/lN63sYPgevrguc72aZX/L9C6x09GYyxBgCX4NlvyGUHOKELlm5rXeR1kchuChJt4SSwyddZRXgvwMGvYo4QSlk3/zkHD8UHxwVJA6zjZZqP8v8kK8OWLnIZtLyCAJagYC4rTGW/9Pqj92N/c+LUaAj27movwbi19tk/whRCIE7Q9vyI6yvRpftAKVTdUjOW40X3h5OXsKCdmFcx0xlLJoSuQngnrJe7Kcjm4OMq9FlC7CMmScQANuNvjfP3PjGXDBaUQmbp296S5L4DrpbrHN1T87ZVEZVCzg1FF0Ft+dKrlLukI+/c9ENo+TvlTDbYFvuKPtQ9+l052rXrgKoWkDAFnvh0wTOmYn8R5f4k/jN/fZiCM1tQx9jQQ4ANhqG4hiL0qIFTGViG9DKB7GYzgubnpofgYRwO+DFjh0Zin2m4b/97EDkXkc+f6xYAPX0KK2I/7fUQuwzuwo/L3AkcjugPNixC8cHf0FyPjWlItmLxWw4Ou9YsQCr5fijMGoD/zpdRy95HRysyXA74MWOnscpO4j2y3HAVisw85hX5+AFBRSHt4ShfLFkIMXTqyKFc46xdzQM6XbAi702a7sy04J0+feReMFKp5q9esYLCqAZYw/k14E/xcLLsFElaornTuJB0svMuJINy8xkIYuL+xPAlWRceH6+HX7THJ0djLUom46zREu7tTkxwmf/FdOZ/sh6Q8qvEAiHpm4PJ4a/doJe0gH1t+aHRgCzOvBvJedEK5OFE5jpm4AGP2a8Dxe3gGJ/pAutug9Gp6he92CsSsWBaEcxGx0FHytmIpuqGkOpldqNYQK8cSoXvd+xLxXADw0kf6UkJNFtdo5MOgaLjiQOQHcn+A6h5NuL2s0qsC2LOM75PcF3yr5STuBSAcGG+meA14K/CI21HcS4LBT6tv0QAh8Dr5l93AhZzG5ZJ4VxAqdZUEl9z7WJ4aN+svMvwHHL21UKTd1mqvChH7/Za5xzXBBKrUcB0TQ+Ulgkfbi/H/YT5EptrGzsEK7tR1B7ln9BBwckYfMiuSqklSznIuoIIOM42MQO+QnduCoFCI0bpkzjCjddHPN/F+2Yu+sd9bKNpVwHhbS3LluK/0zgfwD0xYI5dXuzlQAAAABJRU5ErkJggg==');
  }

  div.callout-warning.callout-style-default .callout-title {
    background-color: #fcefdc
  }

  div.callout-tip {
    border-left-color: #02b875 !important;
  }

  div.callout-tip .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAADr0lEQVRYCe1XTWgTQRj9ZjZV8a9SPIkKgj8I1bMHsUWrqYLVg4Ue6v9BwZOxSYsIerFao7UiUryIqJcqgtpimhbBXoSCVxUFe9CTiogUrUp2Pt+3aUI2u5vdNh4dmMzOzHvvezuz8xNFM0mjnbXaNu1MvFWRXkXEyE6aYOYJpdW4IXuA4r0fo8qqSMDBU0v1HJUgVieAXxzCsdE/YJTdFcVIZQNMyhruOMJKXYFoLfIfIvVIMWdsrd+Rpd86ZmyzzjJmLStqRn0v8lzkb4rVIXvnpScOJuAn2ACC65FkPzEdEy4TPWRLJ2h7z4cArXzzaOdKlbOvKKX25Wl00jSnrwVxAg3o4dRxhO13RBSdNvH0xSARv3adTXbBdTf64IWO2vH0LT+cv4GR1DJt+DUItaQogeBX/chhbTBxEiZ6gftlDNXTrvT7co4ub5A6gp9HIcHvzTa46OS5fBeP87Qm0fQkr4FsYgVQ7Qg+ZayaDg9jhg1GkWj8RG6lkeSacrrHgDaxdoBiZPg+NXV/KifMuB6//JmYH4CntVEHy/keA6x4h4CU5oFy8GzrBS18cLJMXcljAKB6INjWsRcuZBWVaS3GDrqB7rdapVIeA+isQ57Eev9eCqzqOa81CY05VLd6SamW2wA2H3SiTbnbSxmzfp7WtKZkqy4mdyAlGx7ennghYf8voqp9cLSgKdqNfa6RdRsAAkPwRuJZNbpByn+RrJi1RXTwdi8RQF6ymDwGMAtZ6TVE+4uoKh+MYkcLsT0Hk8eAienbiGdjJHZTpmNjlbFJNKDVAp2fJlYju6IreQxQ08UJDNYdoLSl6AadO+fFuCQqVMB1NJwPm69T04Wv5WhfcWyfXQB+wXRs1pt+nCknRa0LVzSA/2B+a9+zQJadb7IyyV24YAxKp2Jqs3emZTuNnKxsah+uabKbMk7CbTgJx/zIgQYErIeTKRQ9yD9wxVof5YolPHqaWo7TD6tJlh7jQnK5z2n3+fGdggIOx2kaa2YI9QWarc5Ce1ipNWMKeSG4DysFF52KBmTNMmn5HqCFkwy34rDg05gDwgH3bBi+sgFhN/e8QvRn8kbamCOhgrZ9GJhFDgfcMHzFb6BAtjKpFhzTjwv1KCVuxHvCbsSiEz4CANnj84cwHdFXAbAOJ4LTSAawGWFn5tDhLMYz6nWeU2wJfIhmIJBefcd/A5FWQWGgrWzyORZ3Q6HuV+Jf0Bj+BTX69fm1zWgK7By1YTXchFDORywnfQ7GpzOo6S+qECrsx2ifVQAAAABJRU5ErkJggg==');
  }

  div.callout-tip.callout-style-default .callout-title {
    background-color: #ccf1e3
  }

  div.callout-caution {
    border-left-color: #fd7e14 !important;
  }

  div.callout-caution .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAACV0lEQVRYCdVWzWoUQRCuqp2ICBLJXgITZL1EfQDBW/bkzUMUD7klD+ATSHBEfAIfQO+iXsWDxJsHL96EHAwhgzlkg8nBg25XWb0zIb0zs9muYYWkoKeru+vn664fBqElyZNuyh167NXJ8Ut8McjbmEraKHkd7uAnAFku+VWdb3reSmRV8PKSLfZ0Gjn3a6Xlcq9YGb6tADjn+lUfTXtVmaZ1KwBIvFI11rRXlWlatwIAAv2asaa9mlB9wwygiDX26qaw1yYPzFXg2N1GgG0FMF8Oj+VIx7E/03lHx8UhvYyNZLN7BwSPgekXXLribw7w5/c8EF+DBK5idvDVYtEEwMeYefjjLAdEyQ3M9nfOkgnPTEkYU+sxMq0BxNR6jExrAI31H1rzvLEfRIdgcv1XEdj6QTQAS2wtstEALLG1yEZ3QhH6oDX7ExBSFEkFINXH98NTrme5IOaaA7kIfiu2L8A3qhH9zRbukdCqdsA98TdElyeMe5BI8Rs2xHRIsoTSSVFfCFCWGPn9XHb4cdobRIWABNf0add9jakDjQJpJ1bTXOJXnnRXHRf+dNL1ZV1MBRCXhMbaHqGI1JkKIL7+i8uffuP6wVQAzO7+qVEbF6NbS0LJureYcWXUUhH66nLR5rYmva+2tjRFtojkM2aD76HEGAD3tPtKM309FJg5j/K682ywcWJ3PASCcycH/22u+Bh7Aa0ehM2Fu4z0SAE81HF9RkB21c5bEn4Dzw+/qNOyXr3DCTQDMBOdhi4nAgiFDGCinIa2owCEChUwD8qzd03PG+qdW/4fDzjUMcE1ZpIAAAAASUVORK5CYII=');
  }

  div.callout-caution.callout-style-default .callout-title {
    background-color: #ffe5d0
  }

  </style>
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">LeNet-Driven CNN Explainability through ExcitationBP Heat-Maps and Sparse Concepts using XNN + SRAE</h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Brian Cervantes Alvarez 
</div>
</div>
</div>

  <p class="date">Friday, June 6, 2025</p>
</section>
<section id="agenda" class="slide level2 smaller scrollable" data-background-color="#D73F09">
<h2>Agenda</h2>
<ol type="1">
<li><em>Motivation and risk</em>—Why care about explanations?</li>
<li><strong>Convolutional neural network (CNN) architecture</strong> overview<br>
</li>
<li><strong>XNN + SRAE</strong>—concept extraction</li>
<li><strong>Results</strong></li>
<li><strong>Ethical considerations &amp; Future research</strong></li>
<li><strong>Questions and discussion</strong></li>
</ol>
</section>
<section id="motivation-and-risk-why-care-about-explanations" class="slide level2 smaller">
<h2>1. Motivation and Risk — Why Care About Explanations?</h2>
<ul>
<li><strong>Safety-critical decisions</strong>
<ul>
<li>Autonomous vehicles: distinguish a <strong>red traffic light</strong> from a red billboard<br>
</li>
<li>Medical diagnostics: pathologists must identify the specific cells that trigger a cancer flag<br>
</li>
</ul></li>
<li><strong>Legal and ethical compliance</strong>
<ul>
<li>EU AI Act, FDA SaMD guidelines require interpretability<br>
</li>
</ul></li>
<li><strong>Model debugging and improvement</strong>
<ul>
<li>Detect shortcut learning (e.g., background colour in bird identification)<br>
</li>
<li>Reveal dataset bias and temporal drift</li>
</ul></li>
</ul>
<p>Opaque decision pathways can introduce risk, undermine confidence, and complicate audits.</p>
</section>
<section>
<section id="cnn-architecture-refresher" class="title-slide slide level1 center" data-background-color="#D73F09">
<h1>2. CNN Architecture Refresher</h1>

</section>
<section id="building-blocks-of-a-cnn" class="slide level2 smaller scrollable">
<h2>Building Blocks of a CNN</h2>
<div class="columns">
<div class="column" style="width:40%;">
<ol type="1">
<li><strong>Convolution</strong> (+ ReLU)<br>
</li>
<li><strong>Stride / Padding</strong><br>
</li>
<li><strong>Pooling</strong> (max &amp; average)<br>
</li>
<li><strong>Normalization</strong> (batch / layer)<br>
</li>
<li><strong>Residual connections</strong><br>
</li>
<li><strong>Flatten → dense head</strong><br>
</li>
<li><strong>Regularization</strong> (dropout)</li>
</ol>
</div><div class="column" style="width:60%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/article-hero-cnn.webp" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure 1. High-level CNN pipeline"><img data-src="images/article-hero-cnn.webp" alt="Figure 1. High-level CNN pipeline"></a></p>
<figcaption>Figure 1. High-level CNN pipeline</figcaption>
</figure>
</div>
</div></div>
</section>
<section id="convolution-kernels" class="slide level2 smaller">
<h2>Convolution Kernels</h2>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/kernel_filter.webp" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure 2. Kernel illustration"><img data-src="images/kernel_filter.webp" alt="Figure 2. Kernel illustration"></a></p>
<figcaption>Figure 2. Kernel illustration</figcaption>
</figure>
</div>
<ul>
<li>A <strong>kernel</strong> (or filter) is a small square that moves over the image, checking a tiny patch at a time.</li>
<li>As it slides, it multiplies and adds pixel values to find patterns like edges or color changes.</li>
<li>The result is a new, smaller image that shows where those patterns appear.</li>
</ul>
<p>Output spatial size: <span class="math inline">\(\bigl[i - k\bigr] + 1\)</span></p>
</section>
<section id="stride-padding" class="slide level2 smaller">
<h2>Stride &amp; Padding</h2>
<div class="columns">
<div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/stride.webp" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure 3. Stride illustration"><img data-src="images/stride.webp" alt="Figure 3. Stride illustration"></a></p>
<figcaption>Figure 3. Stride illustration</figcaption>
</figure>
</div>
<ul>
<li><strong>Stride</strong> is how many pixels the kernel jumps each step.</li>
<li>A bigger stride makes the output smaller faster, but might skip details.</li>
</ul>
<p>Stride <span class="math inline">\(s\)</span> controls down-sampling:<br>
<span class="math inline">\(\bigl[i - k\bigr] / s + 1\)</span></p>
</div><div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/padding.webp" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure 4. Padding illustration"><img data-src="images/padding.webp" alt="Figure 4. Padding illustration"></a></p>
<figcaption>Figure 4. Padding illustration</figcaption>
</figure>
</div>
<ul>
<li><strong>Padding</strong> adds extra pixels (usually zeros) around the image edges.</li>
<li>This lets the kernel cover border areas so we don’t lose information at the edges.</li>
</ul>
<p>Zero-padding <span class="math inline">\(p\)</span> preserves border context:<br>
<span class="math inline">\(\bigl[i - k + 2p\bigr] / s + 1\)</span></p>
</div></div>
</section>
<section id="pooling-layers" class="slide level2 smaller">
<h2>Pooling Layers</h2>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/pooling.webp" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure 5. Max vs average pooling"><img data-src="images/pooling.webp" alt="Figure 5. Max vs average pooling"></a></p>
<figcaption>Figure 5. Max vs average pooling</figcaption>
</figure>
</div>
<ul>
<li><strong>Max pooling</strong> looks at a small patch and keeps only the strongest (highest) value—this highlights important features like edges.</li>
<li><strong>Average pooling</strong> takes the average of a patch—this smooths out details, giving a simpler view.</li>
</ul>
<p>Both make the image smaller and help the network focus on big-picture features.</p>
</section>
<section id="normalization-in-cnns" class="slide level2 smaller">
<h2>Normalization in CNNs</h2>
<p>After each convolution, the distribution of activations can shift (“internal covariate shift”), slowing learning. Normalization keeps activations on a stable scale so the network converges faster. For each channel and each mini-batch:</p>
<div class="columns">
<div class="column" style="width:33.3%;">
<p>Compute the batch mean<br>
<span class="math display">\[
\mu = \frac{1}{m}\sum_{i=1}^m x_i
\]</span></p>
</div><div class="column" style="width:33.3%;">
<p>Compute the batch variance<br>
<span class="math display">\[
\sigma^2 = \frac{1}{m}\sum_{i=1}^m (x_i - \mu)^2
\]</span></p>
</div><div class="column" style="width:33.3%;">
<p>Standardize and re‐scale<br>
<span class="math display">\[
\hat{x}_i = \frac{x_i - \mu}{\sqrt{\sigma^2 + \epsilon}}, \quad
y_i = \gamma\,\hat{x}_i + \beta
\]</span></p>
</div></div>
<p><span class="math inline">\(\epsilon\)</span> avoids division by zero &amp; <span class="math inline">\(\gamma,\beta\)</span> are learnable scale and shift.</p>
<ul>
<li><strong>Faster convergence:</strong> gradients stay well‐scaled<br>
</li>
<li><strong>Milder sensitivity</strong> to initialization and learning rate<br>
</li>
<li><strong>Regularization effect:</strong> slight noise from batch estimates helps generalization</li>
</ul>
</section>
<section id="residual-connections-resnets" class="slide level2 smaller">
<h2>Residual Connections (ResNets)</h2>
<p>Very deep networks can suffer from vanishing gradients—adding more layers can actually hurt accuracy. A <strong>residual connection</strong> (shortcut) lets a block learn only the “difference” from its input:</p>
<p><span class="math display">\[
\mathbf{y} = \mathcal{F}(\mathbf{x}) + \mathbf{x},
\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(\mathbf{x}\)</span> is the block’s input,</li>
<li><span class="math inline">\(\mathcal{F}(\mathbf{x})\)</span> is a small function (e.g., Conv → ReLU → Conv).</li>
</ul>
<p><strong>Why it helps:</strong></p>
<ul>
<li>Gradients can flow directly through <span class="math inline">\(\mathbf{x}\)</span>, avoiding vanishing signals.</li>
<li>The block only has to learn <span class="math inline">\(\mathcal{F}(\mathbf{x})\)</span>, a small correction, rather than a full mapping.</li>
<li>Empirically allows training of very deep networks (hundreds of layers) without degradation.</li>
</ul>
</section>
<section id="flatten-fully-connected-layers" class="slide level2 smaller">
<h2>Flatten &amp; Fully Connected Layers</h2>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/flatten.webp" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure 6. Flatten illustration"><img data-src="images/flatten.webp" alt="Figure 6. Flatten illustration"></a></p>
<figcaption>Figure 6. Flatten illustration</figcaption>
</figure>
</div>
<ul>
<li>After several convolutions and poolings, we obtain a 3D block of numbers (height × width × channels).</li>
<li><strong>Flatten</strong> turns that block into a 1D vector <span class="math inline">\(Z\)</span>, which is the feature map fed into XNN.</li>
<li>This vector <span class="math inline">\(Z\)</span> then goes into <strong>fully connected</strong> layers to mix all features and produce the final class probabilities via softmax.</li>
</ul>
</section>
<section id="regularization-dropout" class="slide level2 smaller">
<h2>Regularization: Dropout</h2>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/dropout.webp" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure 7. Dropout mask"><img data-src="images/dropout.webp" alt="Figure 7. Dropout mask"></a></p>
<figcaption>Figure 7. Dropout mask</figcaption>
</figure>
</div>
<ul>
<li><strong>Dropout</strong> randomly turns off some neurons during training, like giving them a “nap.”</li>
<li>This prevents the network from relying too much on any single neuron.</li>
<li>As a result, the model generalizes better and avoids overfitting (memorizing the training data).</li>
</ul>
</section></section>
<section>
<section id="from-cnn-architecture-to-xnn-explanation" class="title-slide slide level1 center" data-background-color="#D73F09">
<h1>3. From CNN Architecture to XNN Explanation</h1>

</section>
<section id="what-is-xnn" class="slide level2 smaller scrollable">
<h2>What is XNN?</h2>
<ul>
<li><strong>XNN</strong> = e<strong>X</strong>planation <strong>N</strong>eural <strong>N</strong>etwork<br>
</li>
<li>A compact network <strong>attached</strong> to a frozen, pre-trained CNN<br>
</li>
<li><strong>Encoder</strong> <span class="math inline">\(E_\theta\)</span>: compresses the CNN’s feature vector<br>
<span class="math inline">\(\displaystyle \mathbf{z}\in\mathbb{R}^D \;\longmapsto\; \mathbf{e}=E_\theta(\mathbf{z})\in\mathbb{R}^L\)</span><br>
</li>
<li><strong>Projection</strong> <span class="math inline">\(v\)</span>: lifts <span class="math inline">\(\mathbf{e}\)</span> back to the original output space<br>
<span class="math inline">\(\displaystyle \hat{\mathbf{y}}=v^\top\mathbf{e}\)</span><br>
</li>
<li>Trained with three losses to enforce:
<ol type="1">
<li><strong>Faithfulness</strong> (match original predictions)<br>
</li>
<li><strong>Sparsity</strong> (keep concepts concise)<br>
</li>
<li><strong>Orthogonality</strong> (make concepts distinct)<br>
<strong>Gives us:</strong> sparse, stable, and interpretable “concept activations” you can visualize and audit</li>
</ol></li>
</ul>
</section>
<section id="what-is-xnn-1" class="slide level2 smaller">
<h2>What is XNN?</h2>
<div class="columns">
<div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/mainPaper1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Figure 8."><img data-src="images/mainPaper1.png" style="width:80.0%" alt="Figure 8."></a></p>
<figcaption>Figure 8.</figcaption>
</figure>
</div>
<ul>
<li>The explanation network takes <span class="math inline">\(Z\)</span>, squeezes it down to just a few important “concept” numbers (the low-dimensional <span class="math inline">\(E\)</span>), and uses those to reproduce the same prediction—so we can see which few concepts the CNN really cares about.</li>
</ul>
</div><div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/mainPaper2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="Figure 9."><img data-src="images/mainPaper2.png" style="width:80.0%" alt="Figure 9."></a></p>
<figcaption>Figure 9.</figcaption>
</figure>
</div>
<ul>
<li>First, the explanation network uses a small “encoder” to turn the long feature vector <span class="math inline">\(Z\)</span> into a short concept vector <span class="math inline">\(E\)</span>.</li>
<li>Then a “decoder” tries to rebuild only the key parts of <span class="math inline">\(Z\)</span> (so we stay focused on a few features), a penalty makes sure each concept is different from the others, and finally a simple linear layer <span class="math inline">\(v\)</span> uses those concepts to exactly match the CNN’s original output.</li>
</ul>
</div></div>
</section>
<section id="xnn-srae-loss-components" class="slide level2 smaller scrollable">
<h2>XNN + SRAE Loss Components</h2>
<p>For a batch of <span class="math inline">\(M\)</span> inputs, we train the explanation network by minimizing the composite loss function:</p>
<p><span class="math display">\[
\boxed{
\mathcal{L} \;=\; L_{\mathrm{faith}} \;+\; L_{\mathrm{SR}} \;+\; L_{\mathrm{PT}}
}
\]</span></p>
<p>balancing</p>
<ol type="1">
<li><strong>Faithfulness</strong> <span class="math inline">\(\;L_{\mathrm{faith}}\)</span><br>
</li>
<li><strong>Sparse-Reconstruction</strong> <span class="math inline">\(\;L_{\mathrm{SR}}\)</span><br>
</li>
<li><strong>Orthogonality (Pull-Away Term)</strong> <span class="math inline">\(\;L_{\mathrm{PT}}\)</span></li>
</ol>
</section>
<section id="understanding-the-xnn-srae-total-loss" class="slide level2">
<h2>Understanding the XNN + SRAE Total Loss</h2>
<p><span class="math display">\[
\mathcal{L} \;=\; L_{\mathrm{faith}} \;+\; L_{\mathrm{SR}} \;+\; L_{\mathrm{PT}}
\]</span></p>
<p>The total loss combines <strong>three goals</strong>: it makes the explanation network’s output match the original CNN’s predictions (faithfulness), forces it to use only a few key internal features (sparsity), and ensures each learned “concept” is different from the others (orthogonality). By minimizing this combined score, we get a small set of simple, distinct concepts that still predict as accurately as the original model.</p>
</section>
<section id="faithfulness-loss-l_mathrmfaith" class="slide level2 smaller">
<h2>(1) Faithfulness Loss <span class="math inline">\(L_{\mathrm{faith}}\)</span></h2>
<p><span class="math display">\[
L_{\mathrm{faith}}
\;=\;
\underbrace{\frac{1}{M}\sum_{i=1}^{M}\sum_{c=1}^{C}
\Bigl(\bar y_{i,c} \;-\;\hat y_{i,c}\Bigr)^{2}}_{\substack{\text{average of how far apart}\\\text{the two sets of scores are}}}
\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(\bar y_{i,c}\)</span> is the <strong>backbone’s</strong> output score (the CNN’s own number) for class <span class="math inline">\(c\)</span> on image <span class="math inline">\(i\)</span>.</li>
<li><span class="math inline">\(\hat y_{i,c} = v^\top E_\theta\bigl(Z^{(i)}\bigr)\)</span> is the explanation network’s score for class <span class="math inline">\(c\)</span> (the small network’s prediction).</li>
</ul>
<p>This loss measures, on average, how different the explanation network’s scores are from the CNN’s scores. By making this number small, we force the small network to copy the CNN’s predictions closely.</p>
</section>
<section id="faithfulness-loss-l_mathrmfaith-1" class="slide level2">
<h2>(1) Faithfulness Loss <span class="math inline">\(\;L_{\mathrm{faith}}\)</span></h2>
<p>By passing <span class="math inline">\(Z\)</span> through the five-dimensional encoder and then using <span class="math inline">\(v\)</span> to predict <span class="math inline">\(\hat{y}\)</span>, we ensure the five concepts can recreate the CNN’s original output. In practice, <span class="math inline">\(\hat{y}\)</span> should match the softmax scores from LeNet-5’s final layer almost exactly.</p>
<blockquote>
<p><strong>Faithfulness</strong> should converge toward 0 (perfect matching of the CNN’s logits).</p>
</blockquote>
</section>
<section id="sparse-reconstruction-loss-l_mathrmsr" class="slide level2 smaller">
<h2>(2) Sparse-Reconstruction Loss <span class="math inline">\(\;L_{\mathrm{SR}}\)</span></h2>
<p><span class="math display">\[
L_{\mathrm{SR}}
\;=\;
\underbrace{\frac{\beta}{D_z}}_{\substack{\text{trade-off}\\\text{weight}}}
\underbrace{\sum_{k=1}^{D_z}
\log\!\Biggl(
1 \;+\;
q \;\underbrace{\frac{1}{M}\sum_{i=1}^{M}
\bigl(\,\tilde Z^{(i)}_{k} - Z^{(i)}_{k}\bigr)^{2}}_{\substack{\text{average squared}\\\text{reconstruction error}}}
\Biggr)}_{\substack{\text{encourages using only}\\\text{a few important features}}}
\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(Z^{(i)}_{k}\)</span> is the <span class="math inline">\(k\)</span>th coordinate of the backbone activation for image <span class="math inline">\(i\)</span>.</li>
<li><span class="math inline">\(\tilde Z^{(i)}_{k}\)</span> is that same coordinate rebuilt by the decoder.</li>
<li><span class="math inline">\(\beta\)</span> controls how strongly we force sparsity (fewer features).</li>
<li><span class="math inline">\(q\)</span> makes the penalty jump quickly if reconstruction errors get big.</li>
<li><span class="math inline">\(D_z\)</span> is the total number of coordinates in the backbone’s activation.</li>
</ul>
<p>By taking <span class="math inline">\(\log\bigl(1 + q \times \text{MSE}\bigr)\)</span>, we give a small penalty for small errors and a larger penalty for big errors. This makes the explanation network focus on only a <strong>few</strong> key coordinates of <span class="math inline">\(Z\)</span>, so most coordinates stay zero.</p>
</section>
<section id="sparse-reconstruction-loss-l_mathrmsr-1" class="slide level2">
<h2>(2) Sparse-Reconstruction Loss <span class="math inline">\(\;L_{\mathrm{SR}}\)</span></h2>
<p>The decoder <span class="math inline">\(\tilde{\theta}\)</span> is trained to reconstruct only a small subset of the 128 features (with a log‐penalty), forcing each of the five concepts to focus on a few truly important patterns (e.g., “vertical bar” or “curved loop”).</p>
<blockquote>
<p><strong>Sparsity</strong> should converge toward 0 (only a few features used, making explanations very concise).</p>
</blockquote>
</section>
<section id="pull-away-orthogonality-loss-l_mathrmpt" class="slide level2 smaller">
<h2>(3) Pull-Away (Orthogonality) Loss <span class="math inline">\(L_{\mathrm{PT}}\)</span></h2>
<p><span class="math display">\[
L_{\mathrm{PT}}
\;=\;
\underbrace{\frac{\eta}{L(L-1)}}_{\substack{\text{strength of}\\\text{orthogonality}}}
\underbrace{\sum_{\substack{l,l'=1\\l\neq l'}}^{L}
\Bigl(\tfrac{h_{l}^{\top}h_{l'}}{\|h_{l}\|\;\|h_{l'}\|}\Bigr)^{2}}_{\substack{\text{encourages each concept}\\\text{to be distinct (non-overlapping)}}}
\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(h_{\ell}\in\mathbb{R}^M\)</span> is the vector of activations for concept <span class="math inline">\(\ell\)</span> across the batch.</li>
<li><span class="math inline">\(L\)</span> is the total number of concepts (explanation dimensionality).</li>
<li><span class="math inline">\(\eta\)</span> controls how strongly we discourage concepts that fire together.</li>
</ul>
<p>By penalizing squared cosine similarities between every pair of concept activations, we force each concept to occupy its own “direction” in activation space, yielding a set of distinct, non-redundant explanations.</p>
</section>
<section id="pull-away-orthogonality-loss-l_mathrmpt-1" class="slide level2">
<h2>(3) Pull-Away (Orthogonality) Loss <span class="math inline">\(\;L_{\mathrm{PT}}\)</span></h2>
<p>A pull-away term makes sure each of the five concept activations is different from the others, so you end up with five distinct “reasons” that the CNN used to identify a digit.</p>
<blockquote>
<p><strong>Orthogonality</strong> should converge toward 0 (each concept is completely distinct from the others).</p>
</blockquote>
</section>
<section id="how-xnn-srae-works" class="slide level2 smaller scrollable">
<h2>How XNN + SRAE Works</h2>
<ol type="1">
<li><strong>Freeze the CNN</strong>
<ul>
<li>We keep all CNN weights fixed (no more training).<br>
</li>
<li>The CNN now acts as a “feature extractor” that outputs a vector <span class="math inline">\(\mathbf{z}\in\mathbb{R}^D\)</span>.</li>
</ul></li>
<li><strong>Compress to Explanation Space</strong>
<ul>
<li>Pass <span class="math inline">\(\mathbf{z}\)</span> through a small encoder <span class="math inline">\(E_\theta\)</span> to get <span class="math inline">\(\mathbf{e}\in\mathbb{R}^L\)</span>.<br>
</li>
<li>Here, <span class="math inline">\(L\)</span> is small (e.g., 5), so <span class="math inline">\(\mathbf{e}\)</span> is easy to inspect.</li>
</ul></li>
<li><strong>Reconstruct Key Features</strong>
<ul>
<li>From <span class="math inline">\(\mathbf{e}\)</span>, a tiny decoder <span class="math inline">\(\tilde\theta\)</span> tries to rebuild <strong>only</strong> the important parts of <span class="math inline">\(\mathbf{z}\)</span>.<br>
</li>
<li>By penalizing reconstruction error with a logarithmic penalty, we force <span class="math inline">\(\mathbf{e}\)</span> to attend to just a <strong>few coordinates</strong> of <span class="math inline">\(\mathbf{z}\)</span>.</li>
</ul></li>
<li><strong>Match the CNN’s Output</strong>
<ul>
<li>Use a simple linear layer <span class="math inline">\(v\)</span> on <span class="math inline">\(\mathbf{e}\)</span> to recreate the CNN’s logits.<br>
</li>
<li>Training adjusts <span class="math inline">\(E_\theta\)</span>, <span class="math inline">\(\tilde\theta\)</span>, and <span class="math inline">\(v\)</span> so that the final prediction <span class="math inline">\(\hat{\mathbf{y}}_{\text{XNN}}\)</span> is as close as possible to the original <span class="math inline">\(\bar{\mathbf{y}}\)</span>.</li>
</ul></li>
<li><strong>Enforce Orthogonality</strong>
<ul>
<li>While learning, we add a penalty that makes each of the <span class="math inline">\(L\)</span> concept dimensions in <span class="math inline">\(\mathbf{e}\)</span> point in a different direction (no overlap).<br>
</li>
<li>This ensures each concept is unique—e.g., one concept might capture “vertical stroke,” another “curved loop,” etc.</li>
</ul></li>
<li><strong>Result: Explainable Concepts</strong>
<ul>
<li>After training, each dimension of <span class="math inline">\(\mathbf{e}\)</span> is a <strong>human-interpretable “concept.”</strong><br>
</li>
<li>We can visualize, for example, where in the image the “vertical-stroke” concept fires, or how strongly the “loop” concept activates.<br>
</li>
<li>Because <span class="math inline">\(\mathbf{e}\)</span> is low-dimensional and each dimension is sparse, it’s far easier to understand than the original <span class="math inline">\(\mathbf{z}\)</span>.</li>
</ul></li>
</ol>
</section></section>
<section>
<section id="from-theory-to-practice" class="title-slide slide level1 center" data-background-color="#D73F09">
<h1>From Theory to Practice!</h1>

</section>
<section id="implementing-xnn-srae-for-mnist-dataset" class="slide level2 smaller">
<h2>Implementing XNN + SRAE for MNIST Dataset</h2>
<blockquote>
<p><strong>LeNet-5 backbone</strong>: Its 128-dimensional feature layer is compact enough for exhaustive hyper-parameter sweeps yet still achieves ≈99 % accuracy, allowing a fully connected surrogate to produce sharper, more faithful heat-maps than a convolution-only XNN.</p>
</blockquote>
<p><strong>Testing concept stability</strong>: We attach a five-dimensional SRAE head to LeNet-5, freeze the CNN, and train only the explanation network with our three-term loss, verifying that high-level concepts remain consistent under small input changes.</p>
</section></section>
<section>
<section id="results-mnist-case-study" class="title-slide slide level1 center" data-background-color="#D73F09">
<h1>4. Results: MNIST Case Study</h1>

</section>
<section id="cnn-performance" class="slide level2">
<h2>CNN Performance</h2>
<p>The frozen backbone (LeNet-5) reaches a test accuracy of <strong>99.01 %</strong>, with validation loss plateauing early—indicating stable generalization.</p>
</section>
<section id="hyper-parameter-sweep" class="slide level2 smaller">
<h2>Hyper-Parameter Sweep</h2>
<h4 id="table-1-hyper-parameter-sweep">Table 1 — Hyper-parameter Sweep</h4>
<table class="caption-top">
<colgroup>
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 10%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Run</th>
<th style="text-align: center;">β</th>
<th style="text-align: center;">q</th>
<th style="text-align: center;">η</th>
<th style="text-align: center;"><span class="math inline">\(F_{\text{MSE}}\)</span></th>
<th style="text-align: center;"><span class="math inline">\(F_{\text{MAE}}\)</span></th>
<th style="text-align: center;">Accuracy</th>
<th style="text-align: center;"><span class="math inline">\(Sparse_{\text{Loss}}\)</span></th>
<th style="text-align: center;"><span class="math inline">\(Ortho_{\text{Loss}}\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">0.1</td>
<td style="text-align: center;">9.2875</td>
<td style="text-align: center;">2.4538</td>
<td style="text-align: center;">0.9841</td>
<td style="text-align: center;">0.7721</td>
<td style="text-align: center;">0.0028</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">0.5</td>
<td style="text-align: center;">9.2945</td>
<td style="text-align: center;">2.4546</td>
<td style="text-align: center;">0.9842</td>
<td style="text-align: center;">0.7721</td>
<td style="text-align: center;">0.0031</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">9.2914</td>
<td style="text-align: center;">2.4544</td>
<td style="text-align: center;">0.9846</td>
<td style="text-align: center;">0.7722</td>
<td style="text-align: center;">0.0029</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">5.0</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">9.2936</td>
<td style="text-align: center;">2.4541</td>
<td style="text-align: center;">0.9842</td>
<td style="text-align: center;">1.7464</td>
<td style="text-align: center;">0.0028</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">0.1</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">9.2865</td>
<td style="text-align: center;">2.4497</td>
<td style="text-align: center;">0.9840</td>
<td style="text-align: center;">0.1253</td>
<td style="text-align: center;">0.0029</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>6</strong></td>
<td style="text-align: center;"><strong>1.0</strong></td>
<td style="text-align: center;"><strong>0.01</strong></td>
<td style="text-align: center;"><strong>1.0</strong></td>
<td style="text-align: center;"><strong>9.2945</strong></td>
<td style="text-align: center;"><strong>2.4468</strong></td>
<td style="text-align: center;"><strong>0.9836</strong></td>
<td style="text-align: center;"><strong>0.0136</strong></td>
<td style="text-align: center;"><strong>0.0027</strong></td>
</tr>
<tr class="odd">
<td style="text-align: center;">7</td>
<td style="text-align: center;">1.5</td>
<td style="text-align: center;">0.1</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">9.2832</td>
<td style="text-align: center;">2.4494</td>
<td style="text-align: center;">0.9838</td>
<td style="text-align: center;">0.1253</td>
<td style="text-align: center;">0.0026</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Run 6</strong> (β = 1.0, q = 0.01, η = 1.0) strikes the best balance:
<ul>
<li>Sparse‐reconstruction loss drops to <strong>0.0136</strong> (two orders of magnitude lower)<br>
</li>
<li>Faithfulness (<span class="math inline">\(F_{\text{MSE}}\)</span>, <span class="math inline">\(F_{\text{MAE}}\)</span>) and orthogonality remain virtually unchanged</li>
</ul></li>
<li>Faithfulness errors vary little across settings, whereas sparsity depends strongly on <span class="math inline">\(q\)</span>.<br>
</li>
<li>Orthogonality loss stays in the <span class="math inline">\(10^{-3}\)</span> range, indicating robust concept separation.</li>
</ul>
<blockquote>
<p><strong><span class="math inline">\(F_{\text{MSE}}\)</span></strong> comes from summing <span class="math inline">\((\bar y - \hat y)^2\)</span> over all classes and examples.</p>
<p><strong><span class="math inline">\(F_{\text{MAE}}\)</span></strong> would come from summing <span class="math inline">\(\lvert \bar y - \hat y\rvert\)</span> instead, with the same <span class="math inline">\(1/M\)</span> averaging.</p>
</blockquote>
</section>
<section id="concept-specialization" class="slide level2 smaller">
<h2>Concept Specialization</h2>
<h4 id="table-2-concept-specialization-for-run-6">Table 2 — Concept Specialization for Run 6</h4>
<table class="caption-top">
<colgroup>
<col style="width: 8%">
<col style="width: 17%">
<col style="width: 21%">
<col style="width: 51%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Digit</th>
<th style="text-align: center;">Top Feature</th>
<th style="text-align: center;">Mean Activation</th>
<th style="text-align: left;">Captured Pattern</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">X3</td>
<td style="text-align: center;">11.757</td>
<td style="text-align: left;">Closed circular stroke</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">X1</td>
<td style="text-align: center;">−10.213</td>
<td style="text-align: left;">Pure vertical line</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">X4</td>
<td style="text-align: center;">13.674</td>
<td style="text-align: left;">Bottom curve with base</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">X3</td>
<td style="text-align: center;">−11.276</td>
<td style="text-align: left;">Open double curve</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">X1</td>
<td style="text-align: center;">−13.920</td>
<td style="text-align: left;">Vertical–horizontal junction</td>
</tr>
<tr class="even">
<td style="text-align: center;">5</td>
<td style="text-align: center;">X3</td>
<td style="text-align: center;">−13.256</td>
<td style="text-align: left;">Top bar plus lower curve</td>
</tr>
<tr class="odd">
<td style="text-align: center;">6</td>
<td style="text-align: center;">X4</td>
<td style="text-align: center;">−10.469</td>
<td style="text-align: left;">Hook-like bottom curve</td>
</tr>
<tr class="even">
<td style="text-align: center;">7</td>
<td style="text-align: center;">X4</td>
<td style="text-align: center;">8.930</td>
<td style="text-align: left;">Horizontal top bar</td>
</tr>
<tr class="odd">
<td style="text-align: center;">8</td>
<td style="text-align: center;">X5</td>
<td style="text-align: center;">12.522</td>
<td style="text-align: left;">Dual-loop structure</td>
</tr>
<tr class="even">
<td style="text-align: center;">9</td>
<td style="text-align: center;">X2</td>
<td style="text-align: center;">12.821</td>
<td style="text-align: left;">Curved top with tail</td>
</tr>
</tbody>
</table>
<ul>
<li>A single concept dominates each digit.<br>
</li>
<li><strong>Sign</strong> of activation encodes polarity:
<ul>
<li>X3 fires <strong>positively</strong> on closed loops (digit 0) but <strong>negatively</strong> on open curves (digits 3, 5).<br>
</li>
<li>X1 focuses on vertical strokes; X4 and X5 capture increasingly complex curve–line combinations.</li>
</ul></li>
</ul>
</section>
<section id="concept-diversity" class="slide level2 smaller">
<h2>Concept Diversity</h2>
<h4 id="table-3-diversity-versus-specialization">Table 3 — Diversity versus Specialization</h4>
<table class="caption-top">
<colgroup>
<col style="width: 8%">
<col style="width: 15%">
<col style="width: 8%">
<col style="width: 25%">
<col style="width: 41%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Feature</th>
<th style="text-align: center;">Primary Digit</th>
<th style="text-align: center;">Score</th>
<th style="text-align: center;">Diversity (<span class="math inline">\(\sigma/\mu\)</span>)</th>
<th style="text-align: left;">Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">X1</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">13.920</td>
<td style="text-align: center;">0.504</td>
<td style="text-align: left;">Tightly tuned to vertical intersections</td>
</tr>
<tr class="even">
<td style="text-align: center;">X2</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">12.821</td>
<td style="text-align: center;">0.543</td>
<td style="text-align: left;">Targets curved-to-vertical transitions</td>
</tr>
<tr class="odd">
<td style="text-align: center;">X3</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">13.256</td>
<td style="text-align: center;">0.794</td>
<td style="text-align: left;">Broadly active on multiple curved shapes</td>
</tr>
<tr class="even">
<td style="text-align: center;">X4</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">13.674</td>
<td style="text-align: center;">0.426</td>
<td style="text-align: left;">Highly specific to bottom-curve motifs</td>
</tr>
<tr class="odd">
<td style="text-align: center;">X5</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">12.522</td>
<td style="text-align: center;">0.658</td>
<td style="text-align: left;">Reserved for complex dual loops</td>
</tr>
</tbody>
</table>
<ul>
<li>Diversity ratio <span class="math inline">\(\sigma/\mu\)</span> measures how evenly a concept activates across digits.<br>
</li>
<li><strong>Lower</strong> values imply stronger focus on the primary digit (e.g., X4).<br>
</li>
<li><strong>Higher</strong> ratio (X3) reflects versatility across multiple curved shapes.</li>
</ul>
</section>
<section id="excitationbp-heat-maps" class="slide level2 smaller">
<h2>ExcitationBP Heat-maps</h2>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/plot_a_first_fives_4s.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Figure 10: Variants of “4” and their top-5 concept activations"><img data-src="images/plot_a_first_fives_4s.png" style="width:60.0%" alt="Figure 10: Variants of “4” and their top-5 concept activations"></a></p>
<figcaption>Figure 10: Variants of “4” and their top-5 concept activations</figcaption>
</figure>
</div>
<ul>
<li>Concept X3 (vertical strokes) and X5 (mid-bar) appear consistently across five “4” variants</li>
<li>Concept X1 stays negative, confirming vertical lines are handled by X3.</li>
</ul>
</section>
<section id="excitationbp-heat-maps-1" class="slide level2 smaller">
<h2>ExcitationBP Heat-maps</h2>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/plot_b_digits_236789.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Figure 11: Top-5 concepts for digits 2, 3, 6, 7, 8, 9"><img data-src="images/plot_b_digits_236789.png" style="width:60.0%" alt="Figure 11: Top-5 concepts for digits 2, 3, 6, 7, 8, 9"></a></p>
<figcaption>Figure 11: Top-5 concepts for digits 2, 3, 6, 7, 8, 9</figcaption>
</figure>
</div>
<ul>
<li>Concept X4 highlights bottom curves for 2 &amp; 6</li>
<li>Concept X2 fires on the hook of 9; X5 activates on dual loops of 8</li>
<li>Concept X1 remains mostly dormant on curved digits.</li>
</ul>
</section>
<section id="original-study-heat-maps" class="slide level2 smaller">
<h2>Original Study Heat-maps</h2>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/studyFig10.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Figure 12: Fig 10 - Reproduced ExcitationBP from Chen et al.&nbsp;for digit 4 (positives and negatives)"><img data-src="images/studyFig10.png" style="width:60.0%" alt="Figure 12: Fig 10 - Reproduced ExcitationBP from Chen et al.&nbsp;for digit 4 (positives and negatives)"></a></p>
<figcaption>Figure 12: Fig 10 - Reproduced ExcitationBP from Chen et al.&nbsp;for digit 4 (positives and negatives)</figcaption>
</figure>
</div>
<p>These heat-maps are less visually crisp and exhibit more off-stroke activation. Our improvement comes from a fully connected surrogate and stronger regularization.</p>
</section>
<section id="excitationbp-heat-maps-2" class="slide level2 smaller">
<h2>ExcitationBP Heat-maps</h2>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/plot_digit_5_first5.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13" title="Figure 13: Digit 5: ExcitationBP for X1–X5"><img data-src="images/plot_digit_5_first5.png" style="width:60.0%" alt="Figure 13: Digit 5: ExcitationBP for X1–X5"></a></p>
<figcaption>Figure 13: Digit 5: ExcitationBP for X1–X5</figcaption>
</figure>
</div>
<p>Digit 5 shows negative X3 on the open top curve and positive X4 on bottom hook; X2 weakly attends to the upper hook, revealing potential confusion with 9.</p>
</section>
<section id="excitationbp-heat-maps-3" class="slide level2 smaller">
<h2>ExcitationBP Heat-maps</h2>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="images/average_cmwp_per_digit_wide.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14" title="Figure 14: Average c-MWP Heat-Maps per Digit (X1–X5)"><img data-src="images/average_cmwp_per_digit_wide.png" style="height:60.0%" alt="Figure 14: Average c-MWP Heat-Maps per Digit (X1–X5)"></a></p>
<figcaption>Figure 14: Average c-MWP Heat-Maps per Digit (X1–X5)</figcaption>
</figure>
</div>
<p>Column-wise separation confirms each concept is specialized and orthogonal:</p>
<ul>
<li>X1 → vertical edges (1, 4)<br>
</li>
<li>X2 → hook (9)<br>
</li>
<li>X3 → closed vs open curves (0 vs 3, 5)<br>
</li>
<li>X4 → bottom curves (2, 6, 7)<br>
</li>
<li>X5 → dual loops (8)</li>
</ul>
</section>
<section id="discussion" class="slide level2 smaller scrollable">
<h2>Discussion</h2>
<ol type="1">
<li>When we made the “q” parameter smaller, the explanation network used far fewer of the CNN’s internal features without losing accuracy in copying its outputs.</li>
<li>Because of this, each digit only activated one or two “concepts” strongly—making it clear which part of the image mattered most.</li>
<li>The concepts stayed very separate from each other (orthogonal), so no two concepts overlapped in what they detected.</li>
<li>One concept (X3) even flipped its response: it lit up positively for closed loops (like the “0”) and negatively for open curves (like the “5”), showing it truly understood shape differences.</li>
<li>The heat-maps are much sharper and cleaner than the original study’s, proving that a small, simple explanation network can still match the big CNN’s accuracy and give clear, easy-to-read visual explanations.</li>
</ol>
</section>
<section id="limitations" class="slide level2">
<h2>Limitations</h2>
<ul>
<li>Experiments are confined to MNIST; more complex datasets (e.g., CIFAR-10) require larger concept sets (<span class="math inline">\(L\approx10\)</span>–20) and aggressive dimensionality reduction.<br>
</li>
<li>Faithfulness on convolution-only surrogates remains unexplored in our implementation.<br>
</li>
<li>The revived ExcitationBP code is outdated, lacking many quality-of-life features of modern attribution libraries (e.g., Grad-CAM++).</li>
</ul>
</section>
<section id="ethical-considerations" class="slide level2 smaller">
<h2>Ethical Considerations</h2>
<ul>
<li><p><strong>Transparency &amp; Trust</strong> By exposing a small set of human-readable “concepts,” stakeholders (clinicians, regulators, end users) can see exactly which features drove each decision. This reduces blind faith in black‐box models and builds confidence that the CNN isn’t relying on spurious cues.</p></li>
<li><p><strong>Bias Detection &amp; Mitigation</strong> Because each concept highlights specific patterns (e.g., “vertical bar,” “curved loop”), it becomes easier to spot and correct cases where a concept might latch onto an unintended correlate—such as background textures or digit‐style biases—before deployment.</p></li>
<li><p><strong>Safety in High-Stakes Settings</strong> In domains like medical imaging or autonomous driving, knowing why a model flagged a sample (e.g., which “cell shapes” triggered a cancer warning) is crucial. The five concise concepts let experts verify that the network is focusing on medically relevant features rather than noise.</p></li>
<li><p><strong>Accountability &amp; Compliance</strong> Regulations (EU AI Act, FDA guidelines) increasingly demand interpretability. A sparse, orthogonal explanation network satisfies these requirements by providing clear, auditable justifications for every prediction.</p></li>
</ul>
<blockquote>
<p>By combining faithfulness (matching the CNN), sparsity (only a few key features), and orthogonality (distinct explanations), XNN + SRAE represents a meaningful step toward responsible AI—balancing accuracy with human‐centered transparency, bias control, and regulatory compliance.</p>
</blockquote>
</section>
<section id="further-study" class="slide level2 smaller">
<h2>Further Study</h2>
<ul>
<li><strong>Refactor visualization</strong><br>
Modernize or replace ExcitationBP with a contemporary alternative (e.g., Grad-CAM++) to improve c-MWP averaging and injection into PyTorch hooks.<br>
</li>
<li><strong>Scale-up experiments</strong><br>
Apply XNN + SRAE to Fashion-MNIST or CIFAR-10, increasing <span class="math inline">\(L\)</span> and benchmarking run-time versus faithfulness.<br>
</li>
<li><strong>Automate concept selection</strong><br>
Incorporate sparsity-controlled pruning or Bayesian non-parametrics so that <span class="math inline">\(L\)</span> is chosen adaptively rather than manually.<br>
</li>
<li><strong>Deploy in real time</strong><br>
Optimize the decoder and attribution pipeline for GPU inference so that concept heat-maps accompany live predictions in practical applications.</li>
</ul>
</section>
<section id="references" class="slide level2 smaller scrollable">
<h2>References</h2>
<ol type="1">
<li>Li, F., Qi, Z., Khorram, S., <em>et al.</em> (2021). <em>From heatmaps to structured explanations of image classifiers</em>. arXiv preprint arXiv:2109.06365.<br>
</li>
<li>Zhang, Q., Nian Wu, Y., &amp; Zhu, S. C. (2018). <em>Interpretable convolutional neural networks</em>. Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition.<br>
</li>
<li>Doshi-Velez, F., &amp; Kim, B. (2017). <em>Towards a Rigorous Science of Interpretable Machine Learning</em>. arXiv preprint arXiv:1702.08608.<br>
</li>
<li>Adebayo, J., Gilmer, J., Muelly, M., Goodfellow, I., Hardt, M., &amp; Kim, B. (2018). <em>Sanity Checks for Saliency Maps</em>. Advances in Neural Information Processing Systems 31.<br>
</li>
<li>LeCun, Y., Bengio, Y., &amp; Hinton, G. (2015). <em>Deep Learning</em>. <em>Nature</em>, 521(7553), 436-444.<br>
</li>
<li>Chattopadhay, A., Sarkar, A., Howlader, P., &amp; Routray, A. (2018). <em>Grad-CAM++: Generalized Gradient-based Visual Explanations for Deep Convolutional Networks</em>. Proceedings of the IEEE Winter Conference on Applications of Computer Vision (WACV), 839-847.<br>
</li>
<li>Kokhlikyan, N., Miglani, V., Martin, C., Wang, E., Alsallakh, B., Reynolds, J., Melnikov, A., &amp; Reblitz-Richardson, O. (2020). <em>Captum: A Unified and Generic Model Interpretability Library for PyTorch</em>. arXiv preprint arXiv:2009.07896.<br>
</li>
<li>Greydanus, S. (2019). <em>excitationbp: Visualizing how deep networks make decisions</em> (Version 0.1) [Computer software]. GitHub. https://github.com/greydanus/excitationbp<br>
</li>
<li>Allaire, J., &amp; Tang, Y. (2024). tensorflow: R Interface to ‘TensorFlow’. R package version 2.16.0. https://CRAN.R-project.org/package=tensorflow<br>
</li>
<li>Allaire, J., &amp; Chollet, F. (2024). keras: R Interface to ‘Keras’. R package version 2.15.0. https://CRAN.R-project.org/package=keras<br>
</li>
<li>Ushey, K., Allaire, J., &amp; Tang, Y. (2024). reticulate: Interface to ‘Python’. R package version 1.38.0. https://CRAN.R-project.org/package=reticulate<br>
</li>
<li>Wickham, H. (2016). ggplot2: Elegant Graphics for Data Analysis. Springer-Verlag New York. ISBN 978-3-319-24277-4. https://ggplot2.tidyverse.org<br>
</li>
<li>Wickham, H., François, R., Henry, L., Müller, K., &amp; Vaughan, D. (2023). dplyr: A Grammar of Data Manipulation. R package version 1.1.4. https://CRAN.R-project.org/package=dplyr<br>
</li>
<li>Auguie, B. (2017). gridExtra: Miscellaneous Functions for “Grid” Graphics. R package version 2.3. https://CRAN.R-project.org/package=gridExtra</li>
</ol>
</section></section>
<section id="questions" class="title-slide slide level1 smaller center" data-background-color="#D73F09">
<h1>Questions?</h1>

</section>

<section>
<section id="appendix" class="title-slide slide level1 center">
<h1>Appendix</h1>

</section>
<section id="source-code-r" class="slide level2">
<h2>Source code (R)</h2>
<p>The complete R implementation for training and evaluating the CNN+XNN pipeline is available in the supplementary materials. Key components include:</p>
<ul>
<li><code>create_base_cnn()</code>: LeNet-5 architecture definition</li>
<li><code>create_srae()</code>: SRAE explanation head construction<br>
</li>
<li><code>srae_loss()</code>: Composite loss function implementation</li>
<li><code>train_srae()</code>: Custom training loop with three-loss optimization</li>
<li><code>analyze_digit_features()</code>: Concept activation analysis</li>
<li><code>evaluate_faithfulness()</code>: Faithfulness metric computation</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><a href=""></a><span class="co">---</span></span>
<span id="cb1-2"><a href=""></a><span class="an">title:</span><span class="co"> "XNN_SRAE_Implementation"</span></span>
<span id="cb1-3"><a href=""></a><span class="an">author:</span><span class="co"> "Brian Cervantes Alvarez"</span></span>
<span id="cb1-4"><a href=""></a><span class="an">date:</span><span class="co"> "06-02-2025"</span></span>
<span id="cb1-5"><a href=""></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb1-6"><a href=""></a><span class="co">---</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="setup-and-dependencies">1. Setup and Dependencies</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href=""></a><span class="co"># Install required packages if not already installed</span></span>
<span id="cb2-2"><a href=""></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(tensorflow)) <span class="fu">install.packages</span>(<span class="st">"tensorflow"</span>)</span>
<span id="cb2-3"><a href=""></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(keras)) <span class="fu">install.packages</span>(<span class="st">"keras"</span>)</span>
<span id="cb2-4"><a href=""></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(reticulate)) <span class="fu">install.packages</span>(<span class="st">"reticulate"</span>)</span>
<span id="cb2-5"><a href=""></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(ggplot2)) <span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb2-6"><a href=""></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(dplyr)) <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb2-7"><a href=""></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(gridExtra)) <span class="fu">install.packages</span>(<span class="st">"gridExtra"</span>)</span>
<span id="cb2-8"><a href=""></a></span>
<span id="cb2-9"><a href=""></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb2-10"><a href=""></a><span class="fu">library</span>(keras)</span>
<span id="cb2-11"><a href=""></a><span class="fu">library</span>(reticulate)</span>
<span id="cb2-12"><a href=""></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-13"><a href=""></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-14"><a href=""></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb2-15"><a href=""></a></span>
<span id="cb2-16"><a href=""></a><span class="co"># Install TensorFlow (run once)</span></span>
<span id="cb2-17"><a href=""></a><span class="co"># install_tensorflow()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="load-and-prepare-mnist-data">2. Load and Prepare MNIST Data</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href=""></a><span class="co"># Load MNIST dataset</span></span>
<span id="cb3-2"><a href=""></a>mnist <span class="ot">&lt;-</span> <span class="fu">dataset_mnist</span>()</span>
<span id="cb3-3"><a href=""></a>x_train <span class="ot">&lt;-</span> mnist<span class="sc">$</span>train<span class="sc">$</span>x</span>
<span id="cb3-4"><a href=""></a>y_train <span class="ot">&lt;-</span> mnist<span class="sc">$</span>train<span class="sc">$</span>y</span>
<span id="cb3-5"><a href=""></a>x_test <span class="ot">&lt;-</span> mnist<span class="sc">$</span>test<span class="sc">$</span>x</span>
<span id="cb3-6"><a href=""></a>y_test <span class="ot">&lt;-</span> mnist<span class="sc">$</span>test<span class="sc">$</span>y</span>
<span id="cb3-7"><a href=""></a></span>
<span id="cb3-8"><a href=""></a><span class="co"># Normalize to [0,1]</span></span>
<span id="cb3-9"><a href=""></a>x_train <span class="ot">&lt;-</span> x_train <span class="sc">/</span> <span class="dv">255</span></span>
<span id="cb3-10"><a href=""></a>x_test <span class="ot">&lt;-</span> x_test <span class="sc">/</span> <span class="dv">255</span></span>
<span id="cb3-11"><a href=""></a></span>
<span id="cb3-12"><a href=""></a><span class="co"># Reshape for CNN</span></span>
<span id="cb3-13"><a href=""></a>x_train <span class="ot">&lt;-</span> <span class="fu">array_reshape</span>(x_train, <span class="fu">c</span>(<span class="fu">nrow</span>(x_train), <span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>))</span>
<span id="cb3-14"><a href=""></a>x_test <span class="ot">&lt;-</span> <span class="fu">array_reshape</span>(x_test, <span class="fu">c</span>(<span class="fu">nrow</span>(x_test), <span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>))</span>
<span id="cb3-15"><a href=""></a></span>
<span id="cb3-16"><a href=""></a><span class="co"># Convert labels to categorical</span></span>
<span id="cb3-17"><a href=""></a>y_train_cat <span class="ot">&lt;-</span> <span class="fu">to_categorical</span>(y_train, <span class="dv">10</span>)</span>
<span id="cb3-18"><a href=""></a>y_test_cat <span class="ot">&lt;-</span> <span class="fu">to_categorical</span>(y_test, <span class="dv">10</span>)</span>
<span id="cb3-19"><a href=""></a></span>
<span id="cb3-20"><a href=""></a><span class="fu">cat</span>(<span class="st">"Training data shape:"</span>, <span class="fu">dim</span>(x_train), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-21"><a href=""></a><span class="fu">cat</span>(<span class="st">"Test data shape:"</span>, <span class="fu">dim</span>(x_test), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="create-and-train-base-cnn">3. Create and Train Base CNN</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href=""></a>create_base_cnn <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb4-2"><a href=""></a>  model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href=""></a>    <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">32</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="at">activation =</span> <span class="st">'relu'</span>,</span>
<span id="cb4-4"><a href=""></a>                  <span class="at">input_shape =</span> <span class="fu">c</span>(<span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-5"><a href=""></a>    <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-6"><a href=""></a>    <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">64</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="at">activation =</span> <span class="st">'relu'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-7"><a href=""></a>    <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-8"><a href=""></a>    <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-9"><a href=""></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">128</span>, <span class="at">activation =</span> <span class="st">'relu'</span>, <span class="at">name =</span> <span class="st">'feature_layer'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-10"><a href=""></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>, <span class="at">activation =</span> <span class="st">'softmax'</span>, <span class="at">name =</span> <span class="st">'output_layer'</span>)</span>
<span id="cb4-11"><a href=""></a>  </span>
<span id="cb4-12"><a href=""></a>  <span class="fu">return</span>(model)</span>
<span id="cb4-13"><a href=""></a>}</span>
<span id="cb4-14"><a href=""></a></span>
<span id="cb4-15"><a href=""></a><span class="co"># Create and compile base CNN</span></span>
<span id="cb4-16"><a href=""></a>base_cnn <span class="ot">&lt;-</span> <span class="fu">create_base_cnn</span>()</span>
<span id="cb4-17"><a href=""></a>base_cnn <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb4-18"><a href=""></a>  <span class="at">optimizer =</span> <span class="st">'adam'</span>,</span>
<span id="cb4-19"><a href=""></a>  <span class="at">loss =</span> <span class="st">'categorical_crossentropy'</span>,</span>
<span id="cb4-20"><a href=""></a>  <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">'accuracy'</span>)</span>
<span id="cb4-21"><a href=""></a>)</span>
<span id="cb4-22"><a href=""></a></span>
<span id="cb4-23"><a href=""></a><span class="co"># Train the base CNN</span></span>
<span id="cb4-24"><a href=""></a><span class="fu">cat</span>(<span class="st">"Training base CNN...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-25"><a href=""></a>history <span class="ot">&lt;-</span> base_cnn <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb4-26"><a href=""></a>  x_train, y_train_cat,</span>
<span id="cb4-27"><a href=""></a>  <span class="at">epochs =</span> <span class="dv">10</span>,</span>
<span id="cb4-28"><a href=""></a>  <span class="at">batch_size =</span> <span class="dv">128</span>,</span>
<span id="cb4-29"><a href=""></a>  <span class="at">validation_data =</span> <span class="fu">list</span>(x_test, y_test_cat),</span>
<span id="cb4-30"><a href=""></a>  <span class="at">verbose =</span> <span class="dv">1</span></span>
<span id="cb4-31"><a href=""></a>)</span>
<span id="cb4-32"><a href=""></a></span>
<span id="cb4-33"><a href=""></a></span>
<span id="cb4-34"><a href=""></a>base_accuracy <span class="ot">&lt;-</span> base_cnn <span class="sc">%&gt;%</span> <span class="fu">evaluate</span>(x_test, y_test_cat, <span class="at">verbose =</span> <span class="dv">0</span>)</span>
<span id="cb4-35"><a href=""></a><span class="fu">cat</span>(<span class="st">"Base CNN accuracy:"</span>, base_accuracy[<span class="st">"accuracy"</span>], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="extract-intermediate-features-z-and-predictions-ŷ">4. Extract Intermediate Features (Z) and Predictions (ŷ)</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href=""></a><span class="co"># Create feature extractor (Z layer)</span></span>
<span id="cb5-2"><a href=""></a>z_extractor <span class="ot">&lt;-</span> <span class="fu">keras_model</span>(</span>
<span id="cb5-3"><a href=""></a>  <span class="at">inputs =</span> base_cnn<span class="sc">$</span>input,</span>
<span id="cb5-4"><a href=""></a>  <span class="at">outputs =</span> <span class="fu">get_layer</span>(base_cnn, <span class="st">'feature_layer'</span>)<span class="sc">$</span>output</span>
<span id="cb5-5"><a href=""></a>)</span>
<span id="cb5-6"><a href=""></a></span>
<span id="cb5-7"><a href=""></a><span class="co"># Create logits extractor (before softmax)</span></span>
<span id="cb5-8"><a href=""></a>logits_model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-9"><a href=""></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">32</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="at">activation =</span> <span class="st">'relu'</span>,</span>
<span id="cb5-10"><a href=""></a>                <span class="at">input_shape =</span> <span class="fu">c</span>(<span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-11"><a href=""></a>  <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-12"><a href=""></a>  <span class="fu">layer_conv_2d</span>(<span class="at">filters =</span> <span class="dv">64</span>, <span class="at">kernel_size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="at">activation =</span> <span class="st">'relu'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-13"><a href=""></a>  <span class="fu">layer_max_pooling_2d</span>(<span class="at">pool_size =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-14"><a href=""></a>  <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-15"><a href=""></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">128</span>, <span class="at">activation =</span> <span class="st">'relu'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-16"><a href=""></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">10</span>, <span class="at">activation =</span> <span class="st">'linear'</span>)  <span class="co"># No softmax for logits</span></span>
<span id="cb5-17"><a href=""></a></span>
<span id="cb5-18"><a href=""></a><span class="co"># Copy weights from base_cnn to logits_model</span></span>
<span id="cb5-19"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(base_cnn<span class="sc">$</span>layers)) {</span>
<span id="cb5-20"><a href=""></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">get_weights</span>(base_cnn<span class="sc">$</span>layers[[i]])) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb5-21"><a href=""></a>    <span class="cf">if</span> (i <span class="sc">&lt;=</span> <span class="fu">length</span>(logits_model<span class="sc">$</span>layers)) {</span>
<span id="cb5-22"><a href=""></a>      <span class="fu">set_weights</span>(logits_model<span class="sc">$</span>layers[[i]], <span class="fu">get_weights</span>(base_cnn<span class="sc">$</span>layers[[i]]))</span>
<span id="cb5-23"><a href=""></a>    }</span>
<span id="cb5-24"><a href=""></a>  }</span>
<span id="cb5-25"><a href=""></a>}</span>
<span id="cb5-26"><a href=""></a></span>
<span id="cb5-27"><a href=""></a><span class="co"># Extract features and logits</span></span>
<span id="cb5-28"><a href=""></a><span class="fu">cat</span>(<span class="st">"Extracting features...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-29"><a href=""></a>z_train <span class="ot">&lt;-</span> <span class="fu">predict</span>(z_extractor, x_train)</span>
<span id="cb5-30"><a href=""></a>z_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(z_extractor, x_test)</span>
<span id="cb5-31"><a href=""></a>y_hat_train <span class="ot">&lt;-</span> <span class="fu">predict</span>(logits_model, x_train)</span>
<span id="cb5-32"><a href=""></a>y_hat_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(logits_model, x_test)</span>
<span id="cb5-33"><a href=""></a></span>
<span id="cb5-34"><a href=""></a><span class="fu">cat</span>(<span class="st">"Z features shape:"</span>, <span class="fu">dim</span>(z_train), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-35"><a href=""></a><span class="fu">cat</span>(<span class="st">"Y hat shape:"</span>, <span class="fu">dim</span>(y_hat_train), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="implement-srae-model-and-loss-function">5. Implement SRAE Model and Loss Function</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href=""></a><span class="co"># Custom SRAE loss function</span></span>
<span id="cb6-2"><a href=""></a><span class="co"># This version fixes TensorFlow/Keras compatibility issues</span></span>
<span id="cb6-3"><a href=""></a></span>
<span id="cb6-4"><a href=""></a><span class="co"># Simplified and fixed SRAE loss function</span></span>
<span id="cb6-5"><a href=""></a>srae_loss <span class="ot">&lt;-</span> <span class="cf">function</span>(z_true, y_hat_true, e, z_reconstructed, y_pred, </span>
<span id="cb6-6"><a href=""></a>                     <span class="at">beta =</span> <span class="fl">1.0</span>, <span class="at">q =</span> <span class="fl">1.0</span>, <span class="at">eta =</span> <span class="fl">1.0</span>) {</span>
<span id="cb6-7"><a href=""></a>  </span>
<span id="cb6-8"><a href=""></a>  <span class="co"># Term 1: Faithfulness loss</span></span>
<span id="cb6-9"><a href=""></a>  faithfulness_loss <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">reduce_mean</span>(tf<span class="sc">$</span><span class="fu">square</span>(y_pred <span class="sc">-</span> y_hat_true))</span>
<span id="cb6-10"><a href=""></a>  </span>
<span id="cb6-11"><a href=""></a>  <span class="co"># Term 2: Sparse reconstruction loss with log penalty</span></span>
<span id="cb6-12"><a href=""></a>  reconstruction_errors <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">square</span>(z_reconstructed <span class="sc">-</span> z_true)</span>
<span id="cb6-13"><a href=""></a>  reconstruction_errors_per_dim <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">reduce_mean</span>(reconstruction_errors, <span class="at">axis =</span> <span class="dv">0</span>L)</span>
<span id="cb6-14"><a href=""></a>  sparse_reconstruction_loss <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">reduce_mean</span>(</span>
<span id="cb6-15"><a href=""></a>    tf<span class="sc">$</span>math<span class="sc">$</span><span class="fu">log</span>(<span class="fl">1.0</span> <span class="sc">+</span> q <span class="sc">*</span> reconstruction_errors_per_dim)</span>
<span id="cb6-16"><a href=""></a>  )</span>
<span id="cb6-17"><a href=""></a>  </span>
<span id="cb6-18"><a href=""></a>  <span class="co"># Term 3: Orthogonality loss (simplified version)</span></span>
<span id="cb6-19"><a href=""></a>  e_t <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">transpose</span>(e)  </span>
<span id="cb6-20"><a href=""></a>  e_feat_norm <span class="ot">&lt;-</span> tf<span class="sc">$</span>nn<span class="sc">$</span><span class="fu">l2_normalize</span>(e_t, <span class="at">axis =</span> <span class="dv">1</span>L)  </span>
<span id="cb6-21"><a href=""></a>  corr_feats <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">matmul</span>(e_feat_norm, e_feat_norm, <span class="at">transpose_b =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-22"><a href=""></a>  </span>
<span id="cb6-23"><a href=""></a>  num_xfeatures_int <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(num_xfeatures) </span>
<span id="cb6-24"><a href=""></a>  mask <span class="ot">&lt;-</span> <span class="fl">1.0</span> <span class="sc">-</span> tf<span class="sc">$</span><span class="fu">eye</span>(num_xfeatures_int)</span>
<span id="cb6-25"><a href=""></a>  </span>
<span id="cb6-26"><a href=""></a>  orthogonality_loss <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">reduce_mean</span>(tf<span class="sc">$</span><span class="fu">square</span>(corr_feats <span class="sc">*</span> mask))</span>
<span id="cb6-27"><a href=""></a>  </span>
<span id="cb6-28"><a href=""></a>  total_loss <span class="ot">&lt;-</span> faithfulness_loss <span class="sc">+</span> beta <span class="sc">*</span> sparse_reconstruction_loss <span class="sc">+</span> eta <span class="sc">*</span> orthogonality_loss</span>
<span id="cb6-29"><a href=""></a>  </span>
<span id="cb6-30"><a href=""></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb6-31"><a href=""></a>    <span class="at">total =</span> total_loss,</span>
<span id="cb6-32"><a href=""></a>    <span class="at">faithfulness =</span> faithfulness_loss,</span>
<span id="cb6-33"><a href=""></a>    <span class="at">sparse_reconstruction =</span> sparse_reconstruction_loss,</span>
<span id="cb6-34"><a href=""></a>    <span class="at">orthogonality =</span> orthogonality_loss</span>
<span id="cb6-35"><a href=""></a>  ))</span>
<span id="cb6-36"><a href=""></a>}</span>
<span id="cb6-37"><a href=""></a></span>
<span id="cb6-38"><a href=""></a><span class="co"># ---- 5.5 Build the SRAE network -------------------------------------------</span></span>
<span id="cb6-39"><a href=""></a><span class="co"># z_train has shape (n_samples, 128) because the CNN’s 'feature_layer' has 128 units</span></span>
<span id="cb6-40"><a href=""></a>input_dim      <span class="ot">&lt;-</span> <span class="fu">ncol</span>(z_train)      <span class="co"># 128</span></span>
<span id="cb6-41"><a href=""></a>num_xfeatures  <span class="ot">&lt;-</span> <span class="dv">5</span>                  <span class="co"># paper default (can be tuned)</span></span>
<span id="cb6-42"><a href=""></a>num_classes    <span class="ot">&lt;-</span> <span class="dv">10</span>                 <span class="co"># logits for MNIST digits 0‑9</span></span>
<span id="cb6-43"><a href=""></a></span>
<span id="cb6-44"><a href=""></a>create_srae <span class="ot">&lt;-</span> <span class="cf">function</span>(input_dim, <span class="at">num_xfeatures =</span> <span class="dv">5</span>, <span class="at">num_classes =</span> <span class="dv">10</span>) {</span>
<span id="cb6-45"><a href=""></a>  </span>
<span id="cb6-46"><a href=""></a>  z_input <span class="ot">&lt;-</span> <span class="fu">layer_input</span>(<span class="at">shape =</span> input_dim,  <span class="at">name =</span> <span class="st">"z_input"</span>)</span>
<span id="cb6-47"><a href=""></a>  </span>
<span id="cb6-48"><a href=""></a>  <span class="co"># e  : low‑dimensional explanation (X‑features)</span></span>
<span id="cb6-49"><a href=""></a>  e_output <span class="ot">&lt;-</span> z_input <span class="sc">%&gt;%</span> </span>
<span id="cb6-50"><a href=""></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> num_xfeatures,</span>
<span id="cb6-51"><a href=""></a>                <span class="at">activation =</span> <span class="st">"linear"</span>,</span>
<span id="cb6-52"><a href=""></a>                <span class="at">name =</span> <span class="st">"explanation"</span>)</span>
<span id="cb6-53"><a href=""></a>  </span>
<span id="cb6-54"><a href=""></a>  <span class="co"># ŷ  : logit prediction derived **only** from the X‑features</span></span>
<span id="cb6-55"><a href=""></a>  y_pred <span class="ot">&lt;-</span> e_output <span class="sc">%&gt;%</span> </span>
<span id="cb6-56"><a href=""></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> num_classes,</span>
<span id="cb6-57"><a href=""></a>                <span class="at">activation =</span> <span class="st">"linear"</span>,</span>
<span id="cb6-58"><a href=""></a>                <span class="at">name =</span> <span class="st">"prediction"</span>)</span>
<span id="cb6-59"><a href=""></a>  </span>
<span id="cb6-60"><a href=""></a>  <span class="co"># ẑ  : reconstruction of the original latent vector</span></span>
<span id="cb6-61"><a href=""></a>  z_recon <span class="ot">&lt;-</span> e_output <span class="sc">%&gt;%</span> </span>
<span id="cb6-62"><a href=""></a>    <span class="fu">layer_dense</span>(<span class="at">units =</span> input_dim,</span>
<span id="cb6-63"><a href=""></a>                <span class="at">activation =</span> <span class="st">"linear"</span>,</span>
<span id="cb6-64"><a href=""></a>                <span class="at">name =</span> <span class="st">"z_reconstructed"</span>)</span>
<span id="cb6-65"><a href=""></a>  </span>
<span id="cb6-66"><a href=""></a>  <span class="fu">keras_model</span>(<span class="at">inputs  =</span> z_input,</span>
<span id="cb6-67"><a href=""></a>              <span class="at">outputs =</span> <span class="fu">list</span>(e_output, z_recon, y_pred))</span>
<span id="cb6-68"><a href=""></a>}</span>
<span id="cb6-69"><a href=""></a></span>
<span id="cb6-70"><a href=""></a>srae_model <span class="ot">&lt;-</span> <span class="fu">create_srae</span>(input_dim, num_xfeatures, num_classes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="custom-training-loop-for-srae">6. Custom Training Loop for SRAE</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href=""></a><span class="co"># Custom training function for SRAE</span></span>
<span id="cb7-2"><a href=""></a>train_srae <span class="ot">&lt;-</span> <span class="cf">function</span>(model, z_train, y_hat_train, z_test, y_hat_test,</span>
<span id="cb7-3"><a href=""></a>                      <span class="at">epochs =</span> <span class="dv">100</span>, <span class="at">batch_size =</span> <span class="dv">256</span>, </span>
<span id="cb7-4"><a href=""></a>                      <span class="at">beta =</span> <span class="fl">1.0</span>, <span class="at">q =</span> <span class="fl">1.0</span>, <span class="at">eta =</span> <span class="fl">1.0</span>) {</span>
<span id="cb7-5"><a href=""></a>  </span>
<span id="cb7-6"><a href=""></a>  <span class="co"># Use legacy optimizer as suggested by the warning</span></span>
<span id="cb7-7"><a href=""></a>  optimizer <span class="ot">&lt;-</span> tf<span class="sc">$</span>keras<span class="sc">$</span>optimizers<span class="sc">$</span>legacy<span class="sc">$</span><span class="fu">Adam</span>(<span class="at">learning_rate =</span> <span class="fl">0.001</span>)</span>
<span id="cb7-8"><a href=""></a>  </span>
<span id="cb7-9"><a href=""></a>  <span class="co"># Convert data to TensorFlow tensors</span></span>
<span id="cb7-10"><a href=""></a>  z_train_tensor <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">constant</span>(z_train, <span class="at">dtype =</span> tf<span class="sc">$</span>float32)</span>
<span id="cb7-11"><a href=""></a>  y_hat_train_tensor <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">constant</span>(y_hat_train, <span class="at">dtype =</span> tf<span class="sc">$</span>float32)</span>
<span id="cb7-12"><a href=""></a>  z_test_tensor <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">constant</span>(z_test, <span class="at">dtype =</span> tf<span class="sc">$</span>float32)</span>
<span id="cb7-13"><a href=""></a>  y_hat_test_tensor <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">constant</span>(y_hat_test, <span class="at">dtype =</span> tf<span class="sc">$</span>float32)</span>
<span id="cb7-14"><a href=""></a>  </span>
<span id="cb7-15"><a href=""></a>  <span class="co"># Training history</span></span>
<span id="cb7-16"><a href=""></a>  history <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb7-17"><a href=""></a>    <span class="at">epoch =</span> <span class="fu">c</span>(),</span>
<span id="cb7-18"><a href=""></a>    <span class="at">total_loss =</span> <span class="fu">c</span>(),</span>
<span id="cb7-19"><a href=""></a>    <span class="at">faithfulness_loss =</span> <span class="fu">c</span>(),</span>
<span id="cb7-20"><a href=""></a>    <span class="at">sparse_loss =</span> <span class="fu">c</span>(),</span>
<span id="cb7-21"><a href=""></a>    <span class="at">orthogonality_loss =</span> <span class="fu">c</span>(),</span>
<span id="cb7-22"><a href=""></a>    <span class="at">val_faithfulness =</span> <span class="fu">c</span>()</span>
<span id="cb7-23"><a href=""></a>  )</span>
<span id="cb7-24"><a href=""></a>  </span>
<span id="cb7-25"><a href=""></a>  n_samples <span class="ot">&lt;-</span> <span class="fu">nrow</span>(z_train)</span>
<span id="cb7-26"><a href=""></a>  n_batches <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(n_samples <span class="sc">/</span> batch_size)</span>
<span id="cb7-27"><a href=""></a>  </span>
<span id="cb7-28"><a href=""></a>  <span class="fu">cat</span>(<span class="st">"Starting SRAE training...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-29"><a href=""></a>  </span>
<span id="cb7-30"><a href=""></a>  <span class="co"># Training step function</span></span>
<span id="cb7-31"><a href=""></a>  train_step <span class="ot">&lt;-</span> <span class="cf">function</span>(z_batch, y_hat_batch) {</span>
<span id="cb7-32"><a href=""></a>    <span class="fu">with</span>(tf<span class="sc">$</span><span class="fu">GradientTape</span>() <span class="sc">%as%</span> tape, {</span>
<span id="cb7-33"><a href=""></a>      <span class="co"># Forward pass</span></span>
<span id="cb7-34"><a href=""></a>      outputs <span class="ot">&lt;-</span> <span class="fu">model</span>(z_batch, <span class="at">training =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-35"><a href=""></a>      e <span class="ot">&lt;-</span> outputs[[<span class="dv">1</span>]]  <span class="co"># explanation</span></span>
<span id="cb7-36"><a href=""></a>      z_reconstructed <span class="ot">&lt;-</span> outputs[[<span class="dv">2</span>]]  <span class="co"># reconstruction  </span></span>
<span id="cb7-37"><a href=""></a>      y_pred <span class="ot">&lt;-</span> outputs[[<span class="dv">3</span>]]  <span class="co"># prediction</span></span>
<span id="cb7-38"><a href=""></a>      </span>
<span id="cb7-39"><a href=""></a>      <span class="co"># Compute loss</span></span>
<span id="cb7-40"><a href=""></a>      losses <span class="ot">&lt;-</span> <span class="fu">srae_loss</span>(z_batch, y_hat_batch, </span>
<span id="cb7-41"><a href=""></a>                         e, z_reconstructed, y_pred,</span>
<span id="cb7-42"><a href=""></a>                         <span class="at">beta =</span> beta, <span class="at">q =</span> q, <span class="at">eta =</span> eta)</span>
<span id="cb7-43"><a href=""></a>      total_loss <span class="ot">&lt;-</span> losses<span class="sc">$</span>total</span>
<span id="cb7-44"><a href=""></a>    })</span>
<span id="cb7-45"><a href=""></a>    </span>
<span id="cb7-46"><a href=""></a>    <span class="co"># Compute and apply gradients</span></span>
<span id="cb7-47"><a href=""></a>    gradients <span class="ot">&lt;-</span> tape<span class="sc">$</span><span class="fu">gradient</span>(total_loss, model<span class="sc">$</span>trainable_variables)</span>
<span id="cb7-48"><a href=""></a>    optimizer<span class="sc">$</span><span class="fu">apply_gradients</span>(purrr<span class="sc">::</span><span class="fu">transpose</span>(<span class="fu">list</span>(gradients, model<span class="sc">$</span>trainable_variables)))</span>
<span id="cb7-49"><a href=""></a>    </span>
<span id="cb7-50"><a href=""></a>    <span class="fu">return</span>(losses)</span>
<span id="cb7-51"><a href=""></a>  }</span>
<span id="cb7-52"><a href=""></a>  </span>
<span id="cb7-53"><a href=""></a>  <span class="cf">for</span> (epoch <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>epochs) {</span>
<span id="cb7-54"><a href=""></a>    <span class="co"># Shuffle training data</span></span>
<span id="cb7-55"><a href=""></a>    indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n_samples)</span>
<span id="cb7-56"><a href=""></a>    </span>
<span id="cb7-57"><a href=""></a>    epoch_losses <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">total =</span> <span class="dv">0</span>, <span class="at">faith =</span> <span class="dv">0</span>, <span class="at">sparse =</span> <span class="dv">0</span>, <span class="at">ortho =</span> <span class="dv">0</span>)</span>
<span id="cb7-58"><a href=""></a>    </span>
<span id="cb7-59"><a href=""></a>    <span class="cf">for</span> (batch <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_batches) {</span>
<span id="cb7-60"><a href=""></a>      start_idx <span class="ot">&lt;-</span> (batch <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> batch_size <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb7-61"><a href=""></a>      end_idx <span class="ot">&lt;-</span> <span class="fu">min</span>(batch <span class="sc">*</span> batch_size, n_samples)</span>
<span id="cb7-62"><a href=""></a>      batch_indices <span class="ot">&lt;-</span> indices[start_idx<span class="sc">:</span>end_idx]</span>
<span id="cb7-63"><a href=""></a>      </span>
<span id="cb7-64"><a href=""></a>      <span class="co"># Get batch data</span></span>
<span id="cb7-65"><a href=""></a>      z_batch <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">gather</span>(z_train_tensor, <span class="fu">as.integer</span>(batch_indices <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb7-66"><a href=""></a>      y_hat_batch <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">gather</span>(y_hat_train_tensor, <span class="fu">as.integer</span>(batch_indices <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb7-67"><a href=""></a>      </span>
<span id="cb7-68"><a href=""></a>      <span class="co"># Training step</span></span>
<span id="cb7-69"><a href=""></a>      batch_losses <span class="ot">&lt;-</span> <span class="fu">train_step</span>(z_batch, y_hat_batch)</span>
<span id="cb7-70"><a href=""></a>      </span>
<span id="cb7-71"><a href=""></a>      <span class="co"># Accumulate losses</span></span>
<span id="cb7-72"><a href=""></a>      epoch_losses<span class="sc">$</span>total <span class="ot">&lt;-</span> epoch_losses<span class="sc">$</span>total <span class="sc">+</span> <span class="fu">as.numeric</span>(batch_losses<span class="sc">$</span>total)</span>
<span id="cb7-73"><a href=""></a>      epoch_losses<span class="sc">$</span>faith <span class="ot">&lt;-</span> epoch_losses<span class="sc">$</span>faith <span class="sc">+</span> <span class="fu">as.numeric</span>(batch_losses<span class="sc">$</span>faithfulness)</span>
<span id="cb7-74"><a href=""></a>      epoch_losses<span class="sc">$</span>sparse <span class="ot">&lt;-</span> epoch_losses<span class="sc">$</span>sparse <span class="sc">+</span> <span class="fu">as.numeric</span>(batch_losses<span class="sc">$</span>sparse_reconstruction)</span>
<span id="cb7-75"><a href=""></a>      epoch_losses<span class="sc">$</span>ortho <span class="ot">&lt;-</span> epoch_losses<span class="sc">$</span>ortho <span class="sc">+</span> <span class="fu">as.numeric</span>(batch_losses<span class="sc">$</span>orthogonality)</span>
<span id="cb7-76"><a href=""></a>    }</span>
<span id="cb7-77"><a href=""></a>    </span>
<span id="cb7-78"><a href=""></a>    <span class="co"># Average losses over batches</span></span>
<span id="cb7-79"><a href=""></a>    epoch_losses <span class="ot">&lt;-</span> <span class="fu">lapply</span>(epoch_losses, <span class="cf">function</span>(x) x <span class="sc">/</span> n_batches)</span>
<span id="cb7-80"><a href=""></a>    </span>
<span id="cb7-81"><a href=""></a>    <span class="co"># Validation</span></span>
<span id="cb7-82"><a href=""></a>    val_outputs <span class="ot">&lt;-</span> <span class="fu">model</span>(z_test_tensor, <span class="at">training =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-83"><a href=""></a>    val_faith_loss <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">reduce_mean</span>(tf<span class="sc">$</span><span class="fu">square</span>(val_outputs[[<span class="dv">3</span>]] <span class="sc">-</span> y_hat_test_tensor))</span>
<span id="cb7-84"><a href=""></a>    </span>
<span id="cb7-85"><a href=""></a>    <span class="co"># Store history</span></span>
<span id="cb7-86"><a href=""></a>    history<span class="sc">$</span>epoch <span class="ot">&lt;-</span> <span class="fu">c</span>(history<span class="sc">$</span>epoch, epoch)</span>
<span id="cb7-87"><a href=""></a>    history<span class="sc">$</span>total_loss <span class="ot">&lt;-</span> <span class="fu">c</span>(history<span class="sc">$</span>total_loss, epoch_losses<span class="sc">$</span>total)</span>
<span id="cb7-88"><a href=""></a>    history<span class="sc">$</span>faithfulness_loss <span class="ot">&lt;-</span> <span class="fu">c</span>(history<span class="sc">$</span>faithfulness_loss, epoch_losses<span class="sc">$</span>faith)</span>
<span id="cb7-89"><a href=""></a>    history<span class="sc">$</span>sparse_loss <span class="ot">&lt;-</span> <span class="fu">c</span>(history<span class="sc">$</span>sparse_loss, epoch_losses<span class="sc">$</span>sparse)</span>
<span id="cb7-90"><a href=""></a>    history<span class="sc">$</span>orthogonality_loss <span class="ot">&lt;-</span> <span class="fu">c</span>(history<span class="sc">$</span>orthogonality_loss, epoch_losses<span class="sc">$</span>ortho)</span>
<span id="cb7-91"><a href=""></a>    history<span class="sc">$</span>val_faithfulness <span class="ot">&lt;-</span> <span class="fu">c</span>(history<span class="sc">$</span>val_faithfulness, <span class="fu">as.numeric</span>(val_faith_loss))</span>
<span id="cb7-92"><a href=""></a>    </span>
<span id="cb7-93"><a href=""></a>    <span class="co"># Print progress</span></span>
<span id="cb7-94"><a href=""></a>    <span class="cf">if</span> (epoch <span class="sc">%%</span> <span class="dv">10</span> <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb7-95"><a href=""></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Epoch %d/%d - Total Loss: %.4f, Faith: %.4f, Sparse: %.4f, Ortho: %.4f, Val Faith: %.4f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb7-96"><a href=""></a>                  epoch, epochs, epoch_losses<span class="sc">$</span>total, epoch_losses<span class="sc">$</span>faith, </span>
<span id="cb7-97"><a href=""></a>                  epoch_losses<span class="sc">$</span>sparse, epoch_losses<span class="sc">$</span>ortho, <span class="fu">as.numeric</span>(val_faith_loss)))</span>
<span id="cb7-98"><a href=""></a>    }</span>
<span id="cb7-99"><a href=""></a>  }</span>
<span id="cb7-100"><a href=""></a>  </span>
<span id="cb7-101"><a href=""></a>  <span class="fu">return</span>(history)</span>
<span id="cb7-102"><a href=""></a>}</span>
<span id="cb7-103"><a href=""></a></span>
<span id="cb7-104"><a href=""></a><span class="co"># Train SRAE with fixed version</span></span>
<span id="cb7-105"><a href=""></a>training_history <span class="ot">&lt;-</span> <span class="fu">train_srae</span>(</span>
<span id="cb7-106"><a href=""></a>  srae_model, z_train, y_hat_train, z_test, y_hat_test,</span>
<span id="cb7-107"><a href=""></a>  <span class="at">epochs =</span> <span class="dv">50</span>, <span class="at">batch_size =</span> <span class="dv">256</span>,</span>
<span id="cb7-108"><a href=""></a>  <span class="at">beta =</span> <span class="fl">1.0</span>, <span class="at">q =</span> <span class="fl">1.0</span>, <span class="at">eta =</span> <span class="dv">1</span></span>
<span id="cb7-109"><a href=""></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="analyze-x-features-for-different-digits">7. Analyze X-Features for Different Digits</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href=""></a><span class="co"># Function to analyze X-features for specific digits</span></span>
<span id="cb8-2"><a href=""></a>analyze_digit_features <span class="ot">&lt;-</span> <span class="cf">function</span>(model, digit, x_data, y_data, z_data, <span class="at">n_samples =</span> <span class="dv">10</span>) {</span>
<span id="cb8-3"><a href=""></a>  </span>
<span id="cb8-4"><a href=""></a>  <span class="co"># Get indices for specific digit</span></span>
<span id="cb8-5"><a href=""></a>  digit_indices <span class="ot">&lt;-</span> <span class="fu">which</span>(y_data <span class="sc">==</span> digit)</span>
<span id="cb8-6"><a href=""></a>  sample_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(digit_indices, <span class="fu">min</span>(n_samples, <span class="fu">length</span>(digit_indices)))</span>
<span id="cb8-7"><a href=""></a>  </span>
<span id="cb8-8"><a href=""></a>  <span class="co"># Extract features for samples</span></span>
<span id="cb8-9"><a href=""></a>  z_samples <span class="ot">&lt;-</span> z_data[sample_indices, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb8-10"><a href=""></a>  </span>
<span id="cb8-11"><a href=""></a>  <span class="co"># Get X-features</span></span>
<span id="cb8-12"><a href=""></a>  outputs <span class="ot">&lt;-</span> <span class="fu">model</span>(<span class="fu">k_constant</span>(z_samples))</span>
<span id="cb8-13"><a href=""></a>  x_features <span class="ot">&lt;-</span> <span class="fu">as.array</span>(outputs[[<span class="dv">1</span>]])  <span class="co"># [[1]] is the 'explanation' output</span></span>
<span id="cb8-14"><a href=""></a>  </span>
<span id="cb8-15"><a href=""></a>  <span class="co"># Compute mean and std for each X-feature</span></span>
<span id="cb8-16"><a href=""></a>  feature_stats <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb8-17"><a href=""></a>    <span class="at">digit =</span> digit,</span>
<span id="cb8-18"><a href=""></a>    <span class="at">x_feature =</span> <span class="fu">paste0</span>(<span class="st">"X"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>),</span>
<span id="cb8-19"><a href=""></a>    <span class="at">mean_activation =</span> <span class="fu">colMeans</span>(x_features),</span>
<span id="cb8-20"><a href=""></a>    <span class="at">std_activation =</span> <span class="fu">apply</span>(x_features, <span class="dv">2</span>, sd),</span>
<span id="cb8-21"><a href=""></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb8-22"><a href=""></a>  )</span>
<span id="cb8-23"><a href=""></a>  </span>
<span id="cb8-24"><a href=""></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb8-25"><a href=""></a>    <span class="at">stats =</span> feature_stats,</span>
<span id="cb8-26"><a href=""></a>    <span class="at">individual_features =</span> x_features,</span>
<span id="cb8-27"><a href=""></a>    <span class="at">sample_indices =</span> sample_indices</span>
<span id="cb8-28"><a href=""></a>  ))</span>
<span id="cb8-29"><a href=""></a>}</span>
<span id="cb8-30"><a href=""></a></span>
<span id="cb8-31"><a href=""></a><span class="co"># Analyze all digits</span></span>
<span id="cb8-32"><a href=""></a><span class="fu">cat</span>(<span class="st">"Analyzing X-features for all digits...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb8-33"><a href=""></a>all_digit_analysis <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb8-34"><a href=""></a></span>
<span id="cb8-35"><a href=""></a><span class="cf">for</span> (digit <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>) {</span>
<span id="cb8-36"><a href=""></a>  analysis <span class="ot">&lt;-</span> <span class="fu">analyze_digit_features</span>(srae_model, digit, x_test, y_test, z_test)</span>
<span id="cb8-37"><a href=""></a>  all_digit_analysis[[<span class="fu">as.character</span>(digit)]] <span class="ot">&lt;-</span> analysis</span>
<span id="cb8-38"><a href=""></a>  </span>
<span id="cb8-39"><a href=""></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Digit %d - Mean X-feature activations:</span><span class="sc">\n</span><span class="st">"</span>, digit))</span>
<span id="cb8-40"><a href=""></a>  <span class="fu">print</span>(<span class="fu">round</span>(analysis<span class="sc">$</span>stats<span class="sc">$</span>mean_activation, <span class="dv">4</span>))</span>
<span id="cb8-41"><a href=""></a>}</span>
<span id="cb8-42"><a href=""></a></span>
<span id="cb8-43"><a href=""></a><span class="co"># Combine results for visualization</span></span>
<span id="cb8-44"><a href=""></a>feature_summary <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(all_digit_analysis, <span class="cf">function</span>(x) x<span class="sc">$</span>stats))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="visualize-x-feature-activation-patterns">8. Visualize X-Feature Activation Patterns</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href=""></a><span class="co"># Create X-feature activation heatmaps and bar plots</span></span>
<span id="cb9-2"><a href=""></a>plot_xfeature_patterns <span class="ot">&lt;-</span> <span class="cf">function</span>(feature_summary) {</span>
<span id="cb9-3"><a href=""></a>  </span>
<span id="cb9-4"><a href=""></a>  <span class="co"># Heatmap of X-features by digit</span></span>
<span id="cb9-5"><a href=""></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(feature_summary, <span class="fu">aes</span>(<span class="at">x =</span> x_feature, <span class="at">y =</span> <span class="fu">factor</span>(digit), <span class="at">fill =</span> mean_activation)) <span class="sc">+</span></span>
<span id="cb9-6"><a href=""></a>    <span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb9-7"><a href=""></a>    <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>, </span>
<span id="cb9-8"><a href=""></a>                        <span class="at">midpoint =</span> <span class="dv">0</span>, <span class="at">name =</span> <span class="st">"Activation"</span>) <span class="sc">+</span></span>
<span id="cb9-9"><a href=""></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"X-Feature Activation Heatmap by Digit"</span>,</span>
<span id="cb9-10"><a href=""></a>         <span class="at">x =</span> <span class="st">"X-Feature"</span>, <span class="at">y =</span> <span class="st">"Digit"</span>) <span class="sc">+</span></span>
<span id="cb9-11"><a href=""></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb9-12"><a href=""></a>    <span class="fu">theme</span>(</span>
<span id="cb9-13"><a href=""></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb9-14"><a href=""></a>      <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb9-15"><a href=""></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb9-16"><a href=""></a>      <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb9-17"><a href=""></a>    )</span>
<span id="cb9-18"><a href=""></a>  </span>
<span id="cb9-19"><a href=""></a>  <span class="co"># Bar plot for each digit</span></span>
<span id="cb9-20"><a href=""></a>  p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(feature_summary, <span class="fu">aes</span>(<span class="at">x =</span> x_feature, <span class="at">y =</span> mean_activation, <span class="at">fill =</span> x_feature)) <span class="sc">+</span></span>
<span id="cb9-21"><a href=""></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb9-22"><a href=""></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">paste</span>(<span class="st">"Digit"</span>, digit), <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb9-23"><a href=""></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">type =</span> <span class="st">"qual"</span>, <span class="at">palette =</span> <span class="st">"Set3"</span>) <span class="sc">+</span></span>
<span id="cb9-24"><a href=""></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"X-Feature Activations by Digit"</span>,</span>
<span id="cb9-25"><a href=""></a>         <span class="at">x =</span> <span class="st">"X-Feature"</span>, <span class="at">y =</span> <span class="st">"Mean Activation"</span>) <span class="sc">+</span></span>
<span id="cb9-26"><a href=""></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb9-27"><a href=""></a>    <span class="fu">theme</span>(</span>
<span id="cb9-28"><a href=""></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb9-29"><a href=""></a>      <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb9-30"><a href=""></a>      <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb9-31"><a href=""></a>    )</span>
<span id="cb9-32"><a href=""></a>  </span>
<span id="cb9-33"><a href=""></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">heatmap =</span> p1, <span class="at">barplot =</span> p2))</span>
<span id="cb9-34"><a href=""></a>}</span>
<span id="cb9-35"><a href=""></a></span>
<span id="cb9-36"><a href=""></a><span class="co"># Create and display the basic plots</span></span>
<span id="cb9-37"><a href=""></a>plots <span class="ot">&lt;-</span> <span class="fu">plot_xfeature_patterns</span>(feature_summary)</span>
<span id="cb9-38"><a href=""></a></span>
<span id="cb9-39"><a href=""></a><span class="fu">cat</span>(<span class="st">"Displaying X-Feature Heatmap...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-40"><a href=""></a><span class="fu">print</span>(plots<span class="sc">$</span>heatmap)</span>
<span id="cb9-41"><a href=""></a></span>
<span id="cb9-42"><a href=""></a><span class="fu">cat</span>(<span class="st">"Displaying X-Feature Bar Plots...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-43"><a href=""></a><span class="fu">print</span>(plots<span class="sc">$</span>barplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="enhanced-heatmap-analysis">9. Enhanced Heatmap Analysis</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href=""></a><span class="co"># Create enhanced heatmaps with clustering</span></span>
<span id="cb10-2"><a href=""></a><span class="fu">library</span>(reshape2)</span>
<span id="cb10-3"><a href=""></a><span class="fu">library</span>(viridis)</span>
<span id="cb10-4"><a href=""></a><span class="fu">library</span>(pheatmap)</span>
<span id="cb10-5"><a href=""></a></span>
<span id="cb10-6"><a href=""></a><span class="co"># Create matrix for heatmap visualization</span></span>
<span id="cb10-7"><a href=""></a>feature_matrix <span class="ot">&lt;-</span> feature_summary <span class="sc">%&gt;%</span></span>
<span id="cb10-8"><a href=""></a>  <span class="fu">select</span>(digit, x_feature, mean_activation) <span class="sc">%&gt;%</span></span>
<span id="cb10-9"><a href=""></a>  reshape2<span class="sc">::</span><span class="fu">dcast</span>(digit <span class="sc">~</span> x_feature, <span class="at">value.var =</span> <span class="st">"mean_activation"</span>)</span>
<span id="cb10-10"><a href=""></a></span>
<span id="cb10-11"><a href=""></a><span class="fu">rownames</span>(feature_matrix) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Digit"</span>, feature_matrix<span class="sc">$</span>digit)</span>
<span id="cb10-12"><a href=""></a>feature_matrix<span class="sc">$</span>digit <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb10-13"><a href=""></a></span>
<span id="cb10-14"><a href=""></a><span class="co"># Enhanced heatmap with clustering</span></span>
<span id="cb10-15"><a href=""></a><span class="cf">if</span> (<span class="fu">require</span>(pheatmap)) {</span>
<span id="cb10-16"><a href=""></a>  <span class="fu">cat</span>(<span class="st">"Creating enhanced heatmap with clustering...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb10-17"><a href=""></a>  <span class="fu">pheatmap</span>(</span>
<span id="cb10-18"><a href=""></a>    <span class="fu">as.matrix</span>(feature_matrix),</span>
<span id="cb10-19"><a href=""></a>    <span class="at">main =</span> <span class="st">"X-Feature Activation Heatmap (Clustered)"</span>,</span>
<span id="cb10-20"><a href=""></a>    <span class="at">color =</span> viridis<span class="sc">::</span><span class="fu">viridis</span>(<span class="dv">100</span>),</span>
<span id="cb10-21"><a href=""></a>    <span class="at">cluster_rows =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-22"><a href=""></a>    <span class="at">cluster_cols =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-23"><a href=""></a>    <span class="at">display_numbers =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-24"><a href=""></a>    <span class="at">number_format =</span> <span class="st">"%.3f"</span>,</span>
<span id="cb10-25"><a href=""></a>    <span class="at">fontsize_number =</span> <span class="dv">8</span>,</span>
<span id="cb10-26"><a href=""></a>    <span class="at">cellwidth =</span> <span class="dv">40</span>,</span>
<span id="cb10-27"><a href=""></a>    <span class="at">cellheight =</span> <span class="dv">40</span></span>
<span id="cb10-28"><a href=""></a>  )</span>
<span id="cb10-29"><a href=""></a>}</span>
<span id="cb10-30"><a href=""></a></span>
<span id="cb10-31"><a href=""></a><span class="co"># Digit similarity heatmap based on X-features</span></span>
<span id="cb10-32"><a href=""></a>digit_correlation <span class="ot">&lt;-</span> <span class="fu">cor</span>(<span class="fu">t</span>(<span class="fu">as.matrix</span>(feature_matrix)))</span>
<span id="cb10-33"><a href=""></a><span class="fu">pheatmap</span>(</span>
<span id="cb10-34"><a href=""></a>  digit_correlation,</span>
<span id="cb10-35"><a href=""></a>  <span class="at">main =</span> <span class="st">"Digit Similarity Based on X-Features"</span>,</span>
<span id="cb10-36"><a href=""></a>  <span class="at">color =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"white"</span>, <span class="st">"red"</span>))(<span class="dv">100</span>),</span>
<span id="cb10-37"><a href=""></a>  <span class="at">display_numbers =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-38"><a href=""></a>  <span class="at">number_format =</span> <span class="st">"%.2f"</span>,</span>
<span id="cb10-39"><a href=""></a>  <span class="at">fontsize_number =</span> <span class="dv">8</span>,</span>
<span id="cb10-40"><a href=""></a>  <span class="at">cellwidth =</span> <span class="dv">30</span>,</span>
<span id="cb10-41"><a href=""></a>  <span class="at">cellheight =</span> <span class="dv">30</span></span>
<span id="cb10-42"><a href=""></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="paper-style-x-feature-visualization">10. Paper-Style X-Feature Visualization</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href=""></a><span class="co"># EXCITATIONBP IMPLEMENTATION: Proper feature visualization (BETA)</span></span>
<span id="cb11-2"><a href=""></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb11-3"><a href=""></a></span>
<span id="cb11-4"><a href=""></a>create_excitationbp_viz <span class="ot">&lt;-</span> <span class="cf">function</span>(model, x_samples, y_samples, z_samples) {</span>
<span id="cb11-5"><a href=""></a>  </span>
<span id="cb11-6"><a href=""></a>  <span class="co"># Get X-features from SRAE model</span></span>
<span id="cb11-7"><a href=""></a>  outputs <span class="ot">&lt;-</span> <span class="fu">model</span>(<span class="fu">k_constant</span>(z_samples))</span>
<span id="cb11-8"><a href=""></a>  x_features <span class="ot">&lt;-</span> <span class="fu">as.array</span>(outputs[[<span class="dv">1</span>]])  <span class="co"># [[1]] is the 'explanation' output</span></span>
<span id="cb11-9"><a href=""></a>  </span>
<span id="cb11-10"><a href=""></a>  <span class="co"># Select digits to visualize</span></span>
<span id="cb11-11"><a href=""></a>  digits_to_show <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>)</span>
<span id="cb11-12"><a href=""></a>  </span>
<span id="cb11-13"><a href=""></a>  <span class="co"># Select one example per digit</span></span>
<span id="cb11-14"><a href=""></a>  selected_examples <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb11-15"><a href=""></a>  <span class="cf">for</span> (digit <span class="cf">in</span> digits_to_show) {</span>
<span id="cb11-16"><a href=""></a>    digit_indices <span class="ot">&lt;-</span> <span class="fu">which</span>(y_samples <span class="sc">==</span> digit)</span>
<span id="cb11-17"><a href=""></a>    <span class="cf">if</span> (<span class="fu">length</span>(digit_indices) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb11-18"><a href=""></a>      idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(digit_indices, <span class="dv">1</span>)</span>
<span id="cb11-19"><a href=""></a>      selected_examples[[<span class="fu">as.character</span>(digit)]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb11-20"><a href=""></a>        <span class="at">image =</span> x_samples[idx, , , <span class="dv">1</span>],</span>
<span id="cb11-21"><a href=""></a>        <span class="at">x_features =</span> x_features_all[idx, ],</span>
<span id="cb11-22"><a href=""></a>        <span class="at">z_features =</span> z_samples[idx, ],</span>
<span id="cb11-23"><a href=""></a>        <span class="at">digit =</span> digit,</span>
<span id="cb11-24"><a href=""></a>        <span class="at">idx =</span> idx</span>
<span id="cb11-25"><a href=""></a>      )</span>
<span id="cb11-26"><a href=""></a>    }</span>
<span id="cb11-27"><a href=""></a>  }</span>
<span id="cb11-28"><a href=""></a>  </span>
<span id="cb11-29"><a href=""></a>  <span class="co"># ExcitationBP implementation for X-features</span></span>
<span id="cb11-30"><a href=""></a>  excitation_bp <span class="ot">&lt;-</span> <span class="cf">function</span>(z_input, x_feature_idx) {</span>
<span id="cb11-31"><a href=""></a>    </span>
<span id="cb11-32"><a href=""></a>    <span class="co"># Convert Z input to tensor</span></span>
<span id="cb11-33"><a href=""></a>    z_tensor <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">constant</span>(<span class="fu">matrix</span>(z_input, <span class="at">nrow =</span> <span class="dv">1</span>), <span class="at">dtype =</span> tf<span class="sc">$</span>float32)</span>
<span id="cb11-34"><a href=""></a>    </span>
<span id="cb11-35"><a href=""></a>    <span class="co"># Forward pass through SRAE to get X-feature activation</span></span>
<span id="cb11-36"><a href=""></a>    <span class="fu">with</span>(tf<span class="sc">$</span><span class="fu">GradientTape</span>(<span class="at">persistent =</span> <span class="cn">TRUE</span>) <span class="sc">%as%</span> tape, {</span>
<span id="cb11-37"><a href=""></a>      tape<span class="sc">$</span><span class="fu">watch</span>(z_tensor)</span>
<span id="cb11-38"><a href=""></a>      </span>
<span id="cb11-39"><a href=""></a>      <span class="co"># Get model outputs</span></span>
<span id="cb11-40"><a href=""></a>      model_outputs <span class="ot">&lt;-</span> <span class="fu">model</span>(z_tensor)</span>
<span id="cb11-41"><a href=""></a>      x_features <span class="ot">&lt;-</span> model_outputs[[<span class="dv">1</span>]]  <span class="co"># explanation features</span></span>
<span id="cb11-42"><a href=""></a>      z_reconstructed <span class="ot">&lt;-</span> model_outputs[[<span class="dv">2</span>]]  <span class="co"># reconstructed features</span></span>
<span id="cb11-43"><a href=""></a>      </span>
<span id="cb11-44"><a href=""></a>      <span class="co"># Target: activation of specific X-feature</span></span>
<span id="cb11-45"><a href=""></a>      target_activation <span class="ot">&lt;-</span> x_features[<span class="dv">1</span>, x_feature_idx]</span>
<span id="cb11-46"><a href=""></a>    })</span>
<span id="cb11-47"><a href=""></a>    </span>
<span id="cb11-48"><a href=""></a>    <span class="co"># Compute gradients (standard backprop)</span></span>
<span id="cb11-49"><a href=""></a>    gradients <span class="ot">&lt;-</span> tape<span class="sc">$</span><span class="fu">gradient</span>(target_activation, z_tensor)</span>
<span id="cb11-50"><a href=""></a>    gradients_array <span class="ot">&lt;-</span> <span class="fu">as.array</span>(gradients)</span>
<span id="cb11-51"><a href=""></a>    </span>
<span id="cb11-52"><a href=""></a>    <span class="co"># ExcitationBP: Keep only positive contributions</span></span>
<span id="cb11-53"><a href=""></a>    <span class="co"># This shows what parts of Z positively contribute to the X-feature</span></span>
<span id="cb11-54"><a href=""></a>    positive_gradients <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="dv">0</span>, gradients_array)</span>
<span id="cb11-55"><a href=""></a>    </span>
<span id="cb11-56"><a href=""></a>    <span class="co"># Weight by the magnitude of Z features (input * gradient)</span></span>
<span id="cb11-57"><a href=""></a>    excitation_scores <span class="ot">&lt;-</span> z_input <span class="sc">*</span> positive_gradients</span>
<span id="cb11-58"><a href=""></a>    </span>
<span id="cb11-59"><a href=""></a>    <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb11-60"><a href=""></a>      <span class="at">gradients =</span> gradients_array,</span>
<span id="cb11-61"><a href=""></a>      <span class="at">positive_gradients =</span> positive_gradients,</span>
<span id="cb11-62"><a href=""></a>      <span class="at">excitation_scores =</span> excitation_scores,</span>
<span id="cb11-63"><a href=""></a>      <span class="at">activation =</span> <span class="fu">as.numeric</span>(target_activation)</span>
<span id="cb11-64"><a href=""></a>    ))</span>
<span id="cb11-65"><a href=""></a>  }</span>
<span id="cb11-66"><a href=""></a>  </span>
<span id="cb11-67"><a href=""></a>  <span class="co"># Convert Z-space excitation back to image space visualization</span></span>
<span id="cb11-68"><a href=""></a>  z_to_image_excitation <span class="ot">&lt;-</span> <span class="cf">function</span>(z_excitation, original_image) {</span>
<span id="cb11-69"><a href=""></a>    </span>
<span id="cb11-70"><a href=""></a>    <span class="co"># Method 1: Create spatial mapping of Z features to image regions</span></span>
<span id="cb11-71"><a href=""></a>    <span class="co"># Each Z feature corresponds to a spatial region in the image</span></span>
<span id="cb11-72"><a href=""></a>    </span>
<span id="cb11-73"><a href=""></a>    excitation_image <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">28</span>, <span class="at">ncol =</span> <span class="dv">28</span>)</span>
<span id="cb11-74"><a href=""></a>    n_z_features <span class="ot">&lt;-</span> <span class="fu">length</span>(z_excitation)</span>
<span id="cb11-75"><a href=""></a>    </span>
<span id="cb11-76"><a href=""></a>    <span class="co"># Simple spatial mapping: divide image into regions for each Z feature</span></span>
<span id="cb11-77"><a href=""></a>    <span class="cf">if</span> (n_z_features <span class="sc">&gt;=</span> <span class="dv">64</span>) {  <span class="co"># If we have enough Z features</span></span>
<span id="cb11-78"><a href=""></a>      </span>
<span id="cb11-79"><a href=""></a>      <span class="co"># Create 8x8 grid mapping Z features to image regions</span></span>
<span id="cb11-80"><a href=""></a>      z_idx <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb11-81"><a href=""></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">25</span>, <span class="at">by =</span> <span class="dv">4</span>)) {</span>
<span id="cb11-82"><a href=""></a>        <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">25</span>, <span class="at">by =</span> <span class="dv">4</span>)) {</span>
<span id="cb11-83"><a href=""></a>          <span class="cf">if</span> (z_idx <span class="sc">&lt;=</span> n_z_features) {</span>
<span id="cb11-84"><a href=""></a>            <span class="co"># Map Z feature excitation to 4x4 image region</span></span>
<span id="cb11-85"><a href=""></a>            excitation_image[i<span class="sc">:</span>(i<span class="sc">+</span><span class="dv">3</span>), j<span class="sc">:</span>(j<span class="sc">+</span><span class="dv">3</span>)] <span class="ot">&lt;-</span> <span class="fu">abs</span>(z_excitation[z_idx])</span>
<span id="cb11-86"><a href=""></a>            z_idx <span class="ot">&lt;-</span> z_idx <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb11-87"><a href=""></a>          }</span>
<span id="cb11-88"><a href=""></a>        }</span>
<span id="cb11-89"><a href=""></a>      }</span>
<span id="cb11-90"><a href=""></a>      </span>
<span id="cb11-91"><a href=""></a>    } <span class="cf">else</span> {</span>
<span id="cb11-92"><a href=""></a>      <span class="co"># Fallback: distribute Z features across image</span></span>
<span id="cb11-93"><a href=""></a>      <span class="cf">for</span> (z_idx <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(n_z_features, <span class="dv">784</span>)) {</span>
<span id="cb11-94"><a href=""></a>        i <span class="ot">&lt;-</span> ((z_idx <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> <span class="dv">28</span>) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb11-95"><a href=""></a>        j <span class="ot">&lt;-</span> ((z_idx <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%/%</span> <span class="dv">28</span>) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb11-96"><a href=""></a>        <span class="cf">if</span> (i <span class="sc">&lt;=</span> <span class="dv">28</span> <span class="sc">&amp;&amp;</span> j <span class="sc">&lt;=</span> <span class="dv">28</span>) {</span>
<span id="cb11-97"><a href=""></a>          excitation_image[i, j] <span class="ot">&lt;-</span> <span class="fu">abs</span>(z_excitation[z_idx])</span>
<span id="cb11-98"><a href=""></a>        }</span>
<span id="cb11-99"><a href=""></a>      }</span>
<span id="cb11-100"><a href=""></a>    }</span>
<span id="cb11-101"><a href=""></a>    </span>
<span id="cb11-102"><a href=""></a>    <span class="co"># Enhance excitation map with original image structure</span></span>
<span id="cb11-103"><a href=""></a>    <span class="co"># Only show excitation where original image has content</span></span>
<span id="cb11-104"><a href=""></a>    enhanced_excitation <span class="ot">&lt;-</span> excitation_image <span class="sc">*</span> (original_image <span class="sc">&gt;</span> <span class="fl">0.1</span>)</span>
<span id="cb11-105"><a href=""></a>    </span>
<span id="cb11-106"><a href=""></a>    <span class="fu">return</span>(enhanced_excitation)</span>
<span id="cb11-107"><a href=""></a>  }</span>
<span id="cb11-108"><a href=""></a>  </span>
<span id="cb11-109"><a href=""></a>  <span class="co"># Generate ExcitationBP visualizations</span></span>
<span id="cb11-110"><a href=""></a>  <span class="fu">cat</span>(<span class="st">"Generating ExcitationBP visualizations for X-features...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-111"><a href=""></a>  </span>
<span id="cb11-112"><a href=""></a>  <span class="co"># Create visualization</span></span>
<span id="cb11-113"><a href=""></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">length</span>(digits_to_show), <span class="dv">6</span>),</span>
<span id="cb11-114"><a href=""></a>      <span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="dv">2</span>, <span class="fl">0.1</span>),</span>
<span id="cb11-115"><a href=""></a>      <span class="at">bg =</span> <span class="st">"black"</span>)</span>
<span id="cb11-116"><a href=""></a>  </span>
<span id="cb11-117"><a href=""></a>  <span class="cf">for</span> (digit <span class="cf">in</span> digits_to_show) {</span>
<span id="cb11-118"><a href=""></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(selected_examples[[<span class="fu">as.character</span>(digit)]])) {</span>
<span id="cb11-119"><a href=""></a>      </span>
<span id="cb11-120"><a href=""></a>      img <span class="ot">&lt;-</span> selected_examples[[<span class="fu">as.character</span>(digit)]]<span class="sc">$</span>image</span>
<span id="cb11-121"><a href=""></a>      x_vals <span class="ot">&lt;-</span> selected_examples[[<span class="fu">as.character</span>(digit)]]<span class="sc">$</span>x_features</span>
<span id="cb11-122"><a href=""></a>      z_vals <span class="ot">&lt;-</span> selected_examples[[<span class="fu">as.character</span>(digit)]]<span class="sc">$</span>z_features</span>
<span id="cb11-123"><a href=""></a>      </span>
<span id="cb11-124"><a href=""></a>      <span class="co"># Column 1: Original digit</span></span>
<span id="cb11-125"><a href=""></a>      <span class="fu">image</span>(<span class="fu">t</span>(img[<span class="dv">28</span><span class="sc">:</span><span class="dv">1</span>, ]), </span>
<span id="cb11-126"><a href=""></a>            <span class="at">col =</span> <span class="fu">gray.colors</span>(<span class="dv">256</span>, <span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">1</span>),</span>
<span id="cb11-127"><a href=""></a>            <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-128"><a href=""></a>            <span class="at">main =</span> <span class="st">"Original Image"</span>,</span>
<span id="cb11-129"><a href=""></a>            <span class="at">col.main =</span> <span class="st">"white"</span>,</span>
<span id="cb11-130"><a href=""></a>            <span class="at">cex.main =</span> <span class="fl">0.8</span>)</span>
<span id="cb11-131"><a href=""></a>      </span>
<span id="cb11-132"><a href=""></a>      <span class="co"># Columns 2-6: ExcitationBP for each X-feature</span></span>
<span id="cb11-133"><a href=""></a>      <span class="cf">for</span> (x_idx <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb11-134"><a href=""></a>        x_val <span class="ot">&lt;-</span> x_vals[x_idx]</span>
<span id="cb11-135"><a href=""></a>        </span>
<span id="cb11-136"><a href=""></a>        <span class="co"># Compute ExcitationBP for this X-feature and this specific input</span></span>
<span id="cb11-137"><a href=""></a>        <span class="fu">tryCatch</span>({</span>
<span id="cb11-138"><a href=""></a>          excitation_result <span class="ot">&lt;-</span> <span class="fu">excitation_bp</span>(z_vals, x_idx)</span>
<span id="cb11-139"><a href=""></a>          </span>
<span id="cb11-140"><a href=""></a>          <span class="co"># Convert Z-space excitation to image-space visualization</span></span>
<span id="cb11-141"><a href=""></a>          excitation_image <span class="ot">&lt;-</span> <span class="fu">z_to_image_excitation</span>(</span>
<span id="cb11-142"><a href=""></a>            excitation_result<span class="sc">$</span>excitation_scores, </span>
<span id="cb11-143"><a href=""></a>            img</span>
<span id="cb11-144"><a href=""></a>          )</span>
<span id="cb11-145"><a href=""></a>          </span>
<span id="cb11-146"><a href=""></a>          <span class="co"># Enhance visualization based on activation strength</span></span>
<span id="cb11-147"><a href=""></a>          <span class="cf">if</span> (x_val <span class="sc">&gt;=</span> <span class="dv">0</span>) {</span>
<span id="cb11-148"><a href=""></a>            <span class="co"># Positive activation: show excitation as bright regions</span></span>
<span id="cb11-149"><a href=""></a>            final_pattern <span class="ot">&lt;-</span> excitation_image <span class="sc">*</span> (<span class="fu">abs</span>(x_val) <span class="sc">/</span> <span class="fu">max</span>(<span class="fu">abs</span>(x_features_all[, x_idx])))</span>
<span id="cb11-150"><a href=""></a>          } <span class="cf">else</span> {</span>
<span id="cb11-151"><a href=""></a>            <span class="co"># Negative activation: show as inverted excitation</span></span>
<span id="cb11-152"><a href=""></a>            final_pattern <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (excitation_image <span class="sc">*</span> (<span class="fu">abs</span>(x_val) <span class="sc">/</span> <span class="fu">max</span>(<span class="fu">abs</span>(x_features_all[, x_idx]))))</span>
<span id="cb11-153"><a href=""></a>          }</span>
<span id="cb11-154"><a href=""></a>          </span>
<span id="cb11-155"><a href=""></a>          <span class="co"># Normalize for display</span></span>
<span id="cb11-156"><a href=""></a>          <span class="cf">if</span> (<span class="fu">max</span>(final_pattern) <span class="sc">&gt;</span> <span class="fu">min</span>(final_pattern)) {</span>
<span id="cb11-157"><a href=""></a>            final_pattern <span class="ot">&lt;-</span> (final_pattern <span class="sc">-</span> <span class="fu">min</span>(final_pattern)) <span class="sc">/</span> </span>
<span id="cb11-158"><a href=""></a>                            (<span class="fu">max</span>(final_pattern) <span class="sc">-</span> <span class="fu">min</span>(final_pattern))</span>
<span id="cb11-159"><a href=""></a>          } <span class="cf">else</span> {</span>
<span id="cb11-160"><a href=""></a>            final_pattern <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fl">0.5</span>, <span class="at">nrow =</span> <span class="dv">28</span>, <span class="at">ncol =</span> <span class="dv">28</span>)</span>
<span id="cb11-161"><a href=""></a>          }</span>
<span id="cb11-162"><a href=""></a>          </span>
<span id="cb11-163"><a href=""></a>        }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb11-164"><a href=""></a>          <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"ExcitationBP error for X-feature"</span>, x_idx, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb11-165"><a href=""></a>          <span class="co"># Fallback pattern</span></span>
<span id="cb11-166"><a href=""></a>          final_pattern <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fl">0.5</span>, <span class="at">nrow =</span> <span class="dv">28</span>, <span class="at">ncol =</span> <span class="dv">28</span>)</span>
<span id="cb11-167"><a href=""></a>        })</span>
<span id="cb11-168"><a href=""></a>        </span>
<span id="cb11-169"><a href=""></a>        <span class="co"># Display ExcitationBP result</span></span>
<span id="cb11-170"><a href=""></a>        <span class="fu">image</span>(<span class="fu">t</span>(final_pattern[<span class="dv">28</span><span class="sc">:</span><span class="dv">1</span>, ]), </span>
<span id="cb11-171"><a href=""></a>              <span class="at">col =</span> <span class="fu">gray.colors</span>(<span class="dv">256</span>, <span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">1</span>),</span>
<span id="cb11-172"><a href=""></a>              <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-173"><a href=""></a>              <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">"X"</span>, x_idx, <span class="st">": "</span>, <span class="fu">sprintf</span>(<span class="st">"%.4f"</span>, x_val)),</span>
<span id="cb11-174"><a href=""></a>              <span class="at">col.main =</span> <span class="st">"white"</span>,</span>
<span id="cb11-175"><a href=""></a>              <span class="at">cex.main =</span> <span class="fl">0.7</span>)</span>
<span id="cb11-176"><a href=""></a>      }</span>
<span id="cb11-177"><a href=""></a>    }</span>
<span id="cb11-178"><a href=""></a>  }</span>
<span id="cb11-179"><a href=""></a>  </span>
<span id="cb11-180"><a href=""></a>  <span class="co"># Reset background</span></span>
<span id="cb11-181"><a href=""></a>  <span class="fu">par</span>(<span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb11-182"><a href=""></a>  </span>
<span id="cb11-183"><a href=""></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">examples =</span> selected_examples))</span>
<span id="cb11-184"><a href=""></a>}</span>
<span id="cb11-185"><a href=""></a></span>
<span id="cb11-186"><a href=""></a><span class="co"># Simpler ExcitationBP using correlation method</span></span>
<span id="cb11-187"><a href=""></a>create_correlation_excitationbp <span class="ot">&lt;-</span> <span class="cf">function</span>(model, x_samples, y_samples, z_samples) {</span>
<span id="cb11-188"><a href=""></a>  </span>
<span id="cb11-189"><a href=""></a>  <span class="co"># This approach computes correlation between each X-feature and input pixels</span></span>
<span id="cb11-190"><a href=""></a>  <span class="co"># across the entire dataset - a simplified form of ExcitationBP</span></span>
<span id="cb11-191"><a href=""></a>  </span>
<span id="cb11-192"><a href=""></a>  outputs <span class="ot">&lt;-</span> <span class="fu">model</span>(<span class="fu">k_constant</span>(z_samples))</span>
<span id="cb11-193"><a href=""></a>  x_features_all <span class="ot">&lt;-</span> <span class="fu">as.array</span>(outputs[[<span class="dv">1</span>]])</span>
<span id="cb11-194"><a href=""></a>  </span>
<span id="cb11-195"><a href=""></a>  <span class="co"># Compute correlation maps for each X-feature</span></span>
<span id="cb11-196"><a href=""></a>  <span class="fu">cat</span>(<span class="st">"Computing X-feature correlation maps (simplified ExcitationBP)...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-197"><a href=""></a>  correlation_maps <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb11-198"><a href=""></a>  </span>
<span id="cb11-199"><a href=""></a>  <span class="cf">for</span> (x_idx <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb11-200"><a href=""></a>    correlation_map <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">28</span>, <span class="at">ncol =</span> <span class="dv">28</span>)</span>
<span id="cb11-201"><a href=""></a>    x_activations <span class="ot">&lt;-</span> x_features_all[, x_idx]</span>
<span id="cb11-202"><a href=""></a>    </span>
<span id="cb11-203"><a href=""></a>    <span class="co"># Use subset for efficiency</span></span>
<span id="cb11-204"><a href=""></a>    n_samples <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="dv">2000</span>, <span class="fu">nrow</span>(x_samples))</span>
<span id="cb11-205"><a href=""></a>    sample_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(x_samples), n_samples)</span>
<span id="cb11-206"><a href=""></a>    </span>
<span id="cb11-207"><a href=""></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">28</span>) {</span>
<span id="cb11-208"><a href=""></a>      <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">28</span>) {</span>
<span id="cb11-209"><a href=""></a>        pixel_values <span class="ot">&lt;-</span> x_samples[sample_indices, i, j, <span class="dv">1</span>]</span>
<span id="cb11-210"><a href=""></a>        feature_values <span class="ot">&lt;-</span> x_activations[sample_indices]</span>
<span id="cb11-211"><a href=""></a>        </span>
<span id="cb11-212"><a href=""></a>        <span class="cf">if</span> (<span class="fu">sd</span>(pixel_values) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">sd</span>(feature_values) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb11-213"><a href=""></a>          correlation_map[i, j] <span class="ot">&lt;-</span> <span class="fu">cor</span>(pixel_values, feature_values)</span>
<span id="cb11-214"><a href=""></a>        }</span>
<span id="cb11-215"><a href=""></a>      }</span>
<span id="cb11-216"><a href=""></a>    }</span>
<span id="cb11-217"><a href=""></a>    </span>
<span id="cb11-218"><a href=""></a>    correlation_maps[[x_idx]] <span class="ot">&lt;-</span> correlation_map</span>
<span id="cb11-219"><a href=""></a>    <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"Computed correlation map for X-feature"</span>, x_idx, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb11-220"><a href=""></a>  }</span>
<span id="cb11-221"><a href=""></a>  </span>
<span id="cb11-222"><a href=""></a>  <span class="co"># Now create input-specific visualizations</span></span>
<span id="cb11-223"><a href=""></a>  digits_to_show <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>)</span>
<span id="cb11-224"><a href=""></a>  </span>
<span id="cb11-225"><a href=""></a>  selected_examples <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb11-226"><a href=""></a>  <span class="cf">for</span> (digit <span class="cf">in</span> digits_to_show) {</span>
<span id="cb11-227"><a href=""></a>    digit_indices <span class="ot">&lt;-</span> <span class="fu">which</span>(y_samples <span class="sc">==</span> digit)</span>
<span id="cb11-228"><a href=""></a>    <span class="cf">if</span> (<span class="fu">length</span>(digit_indices) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb11-229"><a href=""></a>      idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(digit_indices, <span class="dv">1</span>)</span>
<span id="cb11-230"><a href=""></a>      selected_examples[[<span class="fu">as.character</span>(digit)]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb11-231"><a href=""></a>        <span class="at">image =</span> x_samples[idx, , , <span class="dv">1</span>],</span>
<span id="cb11-232"><a href=""></a>        <span class="at">x_features =</span> x_features_all[idx, ],</span>
<span id="cb11-233"><a href=""></a>        <span class="at">digit =</span> digit</span>
<span id="cb11-234"><a href=""></a>      )</span>
<span id="cb11-235"><a href=""></a>    }</span>
<span id="cb11-236"><a href=""></a>  }</span>
<span id="cb11-237"><a href=""></a>  </span>
<span id="cb11-238"><a href=""></a>  <span class="co"># Create visualization</span></span>
<span id="cb11-239"><a href=""></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="fu">length</span>(digits_to_show), <span class="dv">6</span>),</span>
<span id="cb11-240"><a href=""></a>      <span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="dv">2</span>, <span class="fl">0.1</span>),</span>
<span id="cb11-241"><a href=""></a>      <span class="at">bg =</span> <span class="st">"black"</span>)</span>
<span id="cb11-242"><a href=""></a>  </span>
<span id="cb11-243"><a href=""></a>  <span class="cf">for</span> (digit <span class="cf">in</span> digits_to_show) {</span>
<span id="cb11-244"><a href=""></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(selected_examples[[<span class="fu">as.character</span>(digit)]])) {</span>
<span id="cb11-245"><a href=""></a>      </span>
<span id="cb11-246"><a href=""></a>      img <span class="ot">&lt;-</span> selected_examples[[<span class="fu">as.character</span>(digit)]]<span class="sc">$</span>image</span>
<span id="cb11-247"><a href=""></a>      x_vals <span class="ot">&lt;-</span> selected_examples[[<span class="fu">as.character</span>(digit)]]<span class="sc">$</span>x_features</span>
<span id="cb11-248"><a href=""></a>      </span>
<span id="cb11-249"><a href=""></a>      <span class="co"># Original image</span></span>
<span id="cb11-250"><a href=""></a>      <span class="fu">image</span>(<span class="fu">t</span>(img[<span class="dv">28</span><span class="sc">:</span><span class="dv">1</span>, ]), </span>
<span id="cb11-251"><a href=""></a>            <span class="at">col =</span> <span class="fu">gray.colors</span>(<span class="dv">256</span>, <span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">1</span>),</span>
<span id="cb11-252"><a href=""></a>            <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-253"><a href=""></a>            <span class="at">main =</span> <span class="st">"Original Image"</span>,</span>
<span id="cb11-254"><a href=""></a>            <span class="at">col.main =</span> <span class="st">"white"</span>,</span>
<span id="cb11-255"><a href=""></a>            <span class="at">cex.main =</span> <span class="fl">0.8</span>)</span>
<span id="cb11-256"><a href=""></a>      </span>
<span id="cb11-257"><a href=""></a>      <span class="co"># ExcitationBP-style visualizations</span></span>
<span id="cb11-258"><a href=""></a>      <span class="cf">for</span> (x_idx <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb11-259"><a href=""></a>        x_val <span class="ot">&lt;-</span> x_vals[x_idx]</span>
<span id="cb11-260"><a href=""></a>        </span>
<span id="cb11-261"><a href=""></a>        <span class="co"># Get correlation map for this X-feature</span></span>
<span id="cb11-262"><a href=""></a>        correlation_map <span class="ot">&lt;-</span> correlation_maps[[x_idx]]</span>
<span id="cb11-263"><a href=""></a>        </span>
<span id="cb11-264"><a href=""></a>        <span class="co"># Weight by actual activation and input image</span></span>
<span id="cb11-265"><a href=""></a>        input_weighted_excitation <span class="ot">&lt;-</span> correlation_map <span class="sc">*</span> img <span class="sc">*</span> <span class="fu">sign</span>(x_val)</span>
<span id="cb11-266"><a href=""></a>        </span>
<span id="cb11-267"><a href=""></a>        <span class="co"># Scale by activation strength</span></span>
<span id="cb11-268"><a href=""></a>        max_activation <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(x_features_all[, x_idx]))</span>
<span id="cb11-269"><a href=""></a>        <span class="cf">if</span> (max_activation <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb11-270"><a href=""></a>          activation_strength <span class="ot">&lt;-</span> <span class="fu">abs</span>(x_val) <span class="sc">/</span> max_activation</span>
<span id="cb11-271"><a href=""></a>          final_pattern <span class="ot">&lt;-</span> input_weighted_excitation <span class="sc">*</span> activation_strength</span>
<span id="cb11-272"><a href=""></a>        } <span class="cf">else</span> {</span>
<span id="cb11-273"><a href=""></a>          final_pattern <span class="ot">&lt;-</span> input_weighted_excitation <span class="sc">*</span> <span class="fl">0.1</span></span>
<span id="cb11-274"><a href=""></a>        }</span>
<span id="cb11-275"><a href=""></a>        </span>
<span id="cb11-276"><a href=""></a>        <span class="co"># Normalize for display</span></span>
<span id="cb11-277"><a href=""></a>        <span class="cf">if</span> (<span class="fu">max</span>(final_pattern) <span class="sc">&gt;</span> <span class="fu">min</span>(final_pattern)) {</span>
<span id="cb11-278"><a href=""></a>          final_pattern <span class="ot">&lt;-</span> (final_pattern <span class="sc">-</span> <span class="fu">min</span>(final_pattern)) <span class="sc">/</span> </span>
<span id="cb11-279"><a href=""></a>                          (<span class="fu">max</span>(final_pattern) <span class="sc">-</span> <span class="fu">min</span>(final_pattern))</span>
<span id="cb11-280"><a href=""></a>        } <span class="cf">else</span> {</span>
<span id="cb11-281"><a href=""></a>          final_pattern <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fl">0.5</span>, <span class="at">nrow =</span> <span class="dv">28</span>, <span class="at">ncol =</span> <span class="dv">28</span>)</span>
<span id="cb11-282"><a href=""></a>        }</span>
<span id="cb11-283"><a href=""></a>        </span>
<span id="cb11-284"><a href=""></a>        <span class="co"># Display</span></span>
<span id="cb11-285"><a href=""></a>        <span class="fu">image</span>(<span class="fu">t</span>(final_pattern[<span class="dv">28</span><span class="sc">:</span><span class="dv">1</span>, ]), </span>
<span id="cb11-286"><a href=""></a>              <span class="at">col =</span> <span class="fu">gray.colors</span>(<span class="dv">256</span>, <span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">1</span>),</span>
<span id="cb11-287"><a href=""></a>              <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-288"><a href=""></a>              <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">"X"</span>, x_idx, <span class="st">": "</span>, <span class="fu">sprintf</span>(<span class="st">"%.4f"</span>, x_val)),</span>
<span id="cb11-289"><a href=""></a>              <span class="at">col.main =</span> <span class="st">"white"</span>,</span>
<span id="cb11-290"><a href=""></a>              <span class="at">cex.main =</span> <span class="fl">0.7</span>)</span>
<span id="cb11-291"><a href=""></a>      }</span>
<span id="cb11-292"><a href=""></a>    }</span>
<span id="cb11-293"><a href=""></a>  }</span>
<span id="cb11-294"><a href=""></a>  </span>
<span id="cb11-295"><a href=""></a>  <span class="fu">par</span>(<span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb11-296"><a href=""></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">examples =</span> selected_examples, <span class="at">correlation_maps =</span> correlation_maps))</span>
<span id="cb11-297"><a href=""></a>}</span>
<span id="cb11-298"><a href=""></a></span>
<span id="cb11-299"><a href=""></a><span class="co"># Run ExcitationBP visualization</span></span>
<span id="cb11-300"><a href=""></a><span class="fu">cat</span>(<span class="st">"Creating ExcitationBP-based X-feature visualization...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-301"><a href=""></a></span>
<span id="cb11-302"><a href=""></a><span class="co"># Try the correlation-based method first (more stable)</span></span>
<span id="cb11-303"><a href=""></a>x_viz <span class="ot">&lt;-</span> x_test</span>
<span id="cb11-304"><a href=""></a>y_viz <span class="ot">&lt;-</span> y_test</span>
<span id="cb11-305"><a href=""></a>z_viz <span class="ot">&lt;-</span> z_test</span>
<span id="cb11-306"><a href=""></a>paper_viz_results <span class="ot">&lt;-</span> <span class="fu">create_correlation_excitationbp</span>(srae_model, x_viz, y_viz, z_viz)</span>
<span id="cb11-307"><a href=""></a></span>
<span id="cb11-308"><a href=""></a><span class="fu">cat</span>(<span class="st">"ExcitationBP visualization complete!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-309"><a href=""></a><span class="fu">cat</span>(<span class="st">"Now showing input-specific excitation patterns for each X-feature</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="analysis-and-interpretation">11. Analysis and Interpretation</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href=""></a><span class="co"># Analyze the X-feature patterns for insights</span></span>
<span id="cb12-2"><a href=""></a>analyze_xfeature_insights <span class="ot">&lt;-</span> <span class="cf">function</span>(paper_viz_results, feature_summary) {</span>
<span id="cb12-3"><a href=""></a>  </span>
<span id="cb12-4"><a href=""></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== X-FEATURE ANALYSIS INSIGHTS ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-5"><a href=""></a>  </span>
<span id="cb12-6"><a href=""></a>  <span class="co"># Find dominant X-features for each digit</span></span>
<span id="cb12-7"><a href=""></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Dominant X-features by digit:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-8"><a href=""></a>  <span class="cf">for</span> (digit <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>) {</span>
<span id="cb12-9"><a href=""></a>    digit_features <span class="ot">&lt;-</span> feature_summary[feature_summary<span class="sc">$</span>digit <span class="sc">==</span> digit, ]</span>
<span id="cb12-10"><a href=""></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(digit_features) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb12-11"><a href=""></a>      top_feature_idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(<span class="fu">abs</span>(digit_features<span class="sc">$</span>mean_activation))</span>
<span id="cb12-12"><a href=""></a>      top_feature <span class="ot">&lt;-</span> digit_features<span class="sc">$</span>x_feature[top_feature_idx]</span>
<span id="cb12-13"><a href=""></a>      top_value <span class="ot">&lt;-</span> digit_features<span class="sc">$</span>mean_activation[top_feature_idx]</span>
<span id="cb12-14"><a href=""></a>      </span>
<span id="cb12-15"><a href=""></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Digit %d: %s (%.3f)</span><span class="sc">\n</span><span class="st">"</span>, digit, top_feature, top_value))</span>
<span id="cb12-16"><a href=""></a>    }</span>
<span id="cb12-17"><a href=""></a>  }</span>
<span id="cb12-18"><a href=""></a>  </span>
<span id="cb12-19"><a href=""></a>  <span class="co"># Analyze X-feature specialization</span></span>
<span id="cb12-20"><a href=""></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">X-feature specialization analysis:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-21"><a href=""></a>  <span class="cf">for</span> (x_feat <span class="cf">in</span> <span class="fu">paste0</span>(<span class="st">"X"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)) {</span>
<span id="cb12-22"><a href=""></a>    feat_data <span class="ot">&lt;-</span> feature_summary[feature_summary<span class="sc">$</span>x_feature <span class="sc">==</span> x_feat, ]</span>
<span id="cb12-23"><a href=""></a>    max_digit <span class="ot">&lt;-</span> feat_data<span class="sc">$</span>digit[<span class="fu">which.max</span>(<span class="fu">abs</span>(feat_data<span class="sc">$</span>mean_activation))]</span>
<span id="cb12-24"><a href=""></a>    max_value <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(feat_data<span class="sc">$</span>mean_activation))</span>
<span id="cb12-25"><a href=""></a>    </span>
<span id="cb12-26"><a href=""></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"%s: Most activated by Digit %d (%.3f)</span><span class="sc">\n</span><span class="st">"</span>, x_feat, max_digit, max_value))</span>
<span id="cb12-27"><a href=""></a>  }</span>
<span id="cb12-28"><a href=""></a>  </span>
<span id="cb12-29"><a href=""></a>  <span class="co"># Compute feature diversity (how specialized each X-feature is)</span></span>
<span id="cb12-30"><a href=""></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">X-feature diversity (lower = more specialized):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-31"><a href=""></a>  <span class="cf">for</span> (x_feat <span class="cf">in</span> <span class="fu">paste0</span>(<span class="st">"X"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)) {</span>
<span id="cb12-32"><a href=""></a>    feat_values <span class="ot">&lt;-</span> feature_summary[feature_summary<span class="sc">$</span>x_feature <span class="sc">==</span> x_feat, <span class="st">"mean_activation"</span>]</span>
<span id="cb12-33"><a href=""></a>    diversity <span class="ot">&lt;-</span> <span class="fu">sd</span>(<span class="fu">abs</span>(feat_values)) <span class="sc">/</span> <span class="fu">mean</span>(<span class="fu">abs</span>(feat_values))</span>
<span id="cb12-34"><a href=""></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"%s: %.3f</span><span class="sc">\n</span><span class="st">"</span>, x_feat, diversity))</span>
<span id="cb12-35"><a href=""></a>  }</span>
<span id="cb12-36"><a href=""></a>  </span>
<span id="cb12-37"><a href=""></a>  <span class="fu">return</span>(<span class="fu">invisible</span>())</span>
<span id="cb12-38"><a href=""></a>}</span>
<span id="cb12-39"><a href=""></a></span>
<span id="cb12-40"><a href=""></a><span class="co"># Run the analysis</span></span>
<span id="cb12-41"><a href=""></a><span class="fu">analyze_xfeature_insights</span>(paper_viz_results, feature_summary)</span>
<span id="cb12-42"><a href=""></a></span>
<span id="cb12-43"><a href=""></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== VISUALIZATION SUMMARY ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-44"><a href=""></a><span class="fu">cat</span>(<span class="st">"Generated visualizations:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-45"><a href=""></a><span class="fu">cat</span>(<span class="st">"1. X-Feature activation heatmaps (Section 8)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-46"><a href=""></a><span class="fu">cat</span>(<span class="st">"2. Enhanced clustered heatmaps (Section 9)</span><span class="sc">\n</span><span class="st">"</span>) </span>
<span id="cb12-47"><a href=""></a><span class="fu">cat</span>(<span class="st">"3. Paper-style X-feature patterns (Section 10)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-48"><a href=""></a><span class="fu">cat</span>(<span class="st">"4. Analysis and insights (Section 11)</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="evaluate-model-performance">12. Evaluate Model Performance</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href=""></a><span class="co"># Evaluate faithfulness (how well SRAE predicts original CNN output)</span></span>
<span id="cb13-2"><a href=""></a>evaluate_faithfulness <span class="ot">&lt;-</span> <span class="cf">function</span>(model, z_test, y_hat_test) {</span>
<span id="cb13-3"><a href=""></a>  </span>
<span id="cb13-4"><a href=""></a>  outputs <span class="ot">&lt;-</span> <span class="fu">model</span>(<span class="fu">k_constant</span>(z_test))</span>
<span id="cb13-5"><a href=""></a>  predicted_logits <span class="ot">&lt;-</span> <span class="fu">as.array</span>(outputs<span class="sc">$</span>prediction)</span>
<span id="cb13-6"><a href=""></a>  </span>
<span id="cb13-7"><a href=""></a>  <span class="co"># Mean squared error</span></span>
<span id="cb13-8"><a href=""></a>  mse <span class="ot">&lt;-</span> <span class="fu">mean</span>((predicted_logits <span class="sc">-</span> y_hat_test)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-9"><a href=""></a>  </span>
<span id="cb13-10"><a href=""></a>  <span class="co"># Classification accuracy</span></span>
<span id="cb13-11"><a href=""></a>  predicted_classes <span class="ot">&lt;-</span> <span class="fu">max.col</span>(predicted_logits) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb13-12"><a href=""></a>  original_classes <span class="ot">&lt;-</span> <span class="fu">max.col</span>(y_hat_test) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb13-13"><a href=""></a>  accuracy <span class="ot">&lt;-</span> <span class="fu">mean</span>(predicted_classes <span class="sc">==</span> original_classes)</span>
<span id="cb13-14"><a href=""></a>  </span>
<span id="cb13-15"><a href=""></a>  <span class="fu">cat</span>(<span class="st">"SRAE Evaluation:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-16"><a href=""></a>  <span class="fu">cat</span>(<span class="st">"Faithfulness (MSE):"</span>, <span class="fu">round</span>(mse, <span class="dv">6</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-17"><a href=""></a>  <span class="fu">cat</span>(<span class="st">"Classification Accuracy:"</span>, <span class="fu">round</span>(accuracy, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-18"><a href=""></a>  </span>
<span id="cb13-19"><a href=""></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mse =</span> mse, <span class="at">accuracy =</span> accuracy))</span>
<span id="cb13-20"><a href=""></a>}</span>
<span id="cb13-21"><a href=""></a></span>
<span id="cb13-22"><a href=""></a>faithfulness_results <span class="ot">&lt;-</span> <span class="fu">evaluate_faithfulness</span>(srae_model, z_test, y_hat_test)</span>
<span id="cb13-23"><a href=""></a></span>
<span id="cb13-24"><a href=""></a><span class="co"># Print summary insights</span></span>
<span id="cb13-25"><a href=""></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== SUMMARY INSIGHTS ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-26"><a href=""></a><span class="fu">cat</span>(<span class="st">"The X-features represent different visual patterns:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-27"><a href=""></a></span>
<span id="cb13-28"><a href=""></a><span class="co"># Find which X-features are most important for each digit</span></span>
<span id="cb13-29"><a href=""></a><span class="cf">for</span> (digit <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>) {</span>
<span id="cb13-30"><a href=""></a>  features <span class="ot">&lt;-</span> all_digit_analysis[[<span class="fu">as.character</span>(digit)]]<span class="sc">$</span>stats<span class="sc">$</span>mean_activation</span>
<span id="cb13-31"><a href=""></a>  top_feature <span class="ot">&lt;-</span> <span class="fu">which.max</span>(<span class="fu">abs</span>(features))</span>
<span id="cb13-32"><a href=""></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Digit %d: Most activated by X%d (%.4f)</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb13-33"><a href=""></a>              digit, top_feature, features[top_feature]))</span>
<span id="cb13-34"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="source-code-python---excitationbp" class="slide level2">
<h2>Source code (Python) - ExcitationBP</h2>
<h3 id="plot_multiple_cmwp.py">plot_multiple_cMWP.py</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href=""></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb14-2"><a href=""></a><span class="co"># plot_multiple_cMWP.py</span></span>
<span id="cb14-3"><a href=""></a></span>
<span id="cb14-4"><a href=""></a><span class="im">import</span> os</span>
<span id="cb14-5"><a href=""></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-6"><a href=""></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb14-7"><a href=""></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb14-8"><a href=""></a><span class="im">from</span> excitationbp <span class="im">import</span> ExcitationBP</span>
<span id="cb14-9"><a href=""></a></span>
<span id="cb14-10"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-11"><a href=""></a><span class="co"># 1) Load the two SavedModels exported from R:</span></span>
<span id="cb14-12"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-13"><a href=""></a>cnn_path  <span class="op">=</span> os.path.join(<span class="st">"saved_models"</span>, <span class="st">"base_cnn_for_excitebp"</span>)</span>
<span id="cb14-14"><a href=""></a>srae_path <span class="op">=</span> os.path.join(<span class="st">"saved_models"</span>, <span class="st">"srae_explainer"</span>)</span>
<span id="cb14-15"><a href=""></a></span>
<span id="cb14-16"><a href=""></a><span class="bu">print</span>(<span class="st">"Loading base CNN from:"</span>, cnn_path)</span>
<span id="cb14-17"><a href=""></a>py_cnn <span class="op">=</span> tf.keras.models.load_model(cnn_path)</span>
<span id="cb14-18"><a href=""></a></span>
<span id="cb14-19"><a href=""></a><span class="bu">print</span>(<span class="st">"Loading SRAE explainer from:"</span>, srae_path)</span>
<span id="cb14-20"><a href=""></a>py_srae <span class="op">=</span> tf.keras.models.load_model(srae_path, <span class="bu">compile</span><span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-21"><a href=""></a></span>
<span id="cb14-22"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-23"><a href=""></a><span class="co"># 2) Print layer names so we can verify how to stitch:</span></span>
<span id="cb14-24"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-25"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- CNN layers ---"</span>)</span>
<span id="cb14-26"><a href=""></a><span class="cf">for</span> layer <span class="kw">in</span> py_cnn.layers:</span>
<span id="cb14-27"><a href=""></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>layer<span class="sc">.</span>name<span class="sc">:30s}</span><span class="ss">  </span><span class="sc">{</span>layer<span class="sc">.</span>output_shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-28"><a href=""></a></span>
<span id="cb14-29"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- SRAE layers ---"</span>)</span>
<span id="cb14-30"><a href=""></a><span class="cf">for</span> layer <span class="kw">in</span> py_srae.layers:</span>
<span id="cb14-31"><a href=""></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>layer<span class="sc">.</span>name<span class="sc">:30s}</span><span class="ss">  </span><span class="sc">{</span>layer<span class="sc">.</span>input_shape<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>layer<span class="sc">.</span>output_shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-32"><a href=""></a></span>
<span id="cb14-33"><a href=""></a><span class="co"># Sanity check:</span></span>
<span id="cb14-34"><a href=""></a><span class="cf">assert</span> py_cnn.get_layer(<span class="st">"feature_layer"</span>).output_shape[<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> <span class="dv">128</span></span>
<span id="cb14-35"><a href=""></a><span class="cf">assert</span> py_srae.get_layer(<span class="st">"explanation"</span>).input_shape[<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> <span class="dv">128</span></span>
<span id="cb14-36"><a href=""></a></span>
<span id="cb14-37"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-38"><a href=""></a><span class="co"># 3) “Stitch” the SRAE’s ‘explanation’ Dense onto the CNN:</span></span>
<span id="cb14-39"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-40"><a href=""></a><span class="co">#</span></span>
<span id="cb14-41"><a href=""></a><span class="co">#    We copy just the weights of the original `explanation` layer</span></span>
<span id="cb14-42"><a href=""></a><span class="co">#    so that our fused model uses a true Dense, not a Lambda. This</span></span>
<span id="cb14-43"><a href=""></a><span class="co">#    ensures `ebp.excite(…, "explanation", i)` will find exactly</span></span>
<span id="cb14-44"><a href=""></a><span class="co">#    one layer named "explanation" to hook into.</span></span>
<span id="cb14-45"><a href=""></a><span class="co">#</span></span>
<span id="cb14-46"><a href=""></a>orig_ex_layer <span class="op">=</span> py_srae.get_layer(<span class="st">"explanation"</span>)</span>
<span id="cb14-47"><a href=""></a>new_ex_layer <span class="op">=</span> tf.keras.layers.Dense(</span>
<span id="cb14-48"><a href=""></a>    units      <span class="op">=</span> orig_ex_layer.units,</span>
<span id="cb14-49"><a href=""></a>    activation <span class="op">=</span> orig_ex_layer.activation,</span>
<span id="cb14-50"><a href=""></a>    use_bias   <span class="op">=</span> orig_ex_layer.use_bias,</span>
<span id="cb14-51"><a href=""></a>    name       <span class="op">=</span> <span class="st">"explanation"</span></span>
<span id="cb14-52"><a href=""></a>)</span>
<span id="cb14-53"><a href=""></a><span class="co"># Build &amp; transfer weights:</span></span>
<span id="cb14-54"><a href=""></a>new_ex_layer.build((<span class="va">None</span>, <span class="dv">128</span>))</span>
<span id="cb14-55"><a href=""></a>new_ex_layer.set_weights(orig_ex_layer.get_weights())</span>
<span id="cb14-56"><a href=""></a></span>
<span id="cb14-57"><a href=""></a><span class="co"># Build fused model: image → base_CNN → feature_layer(128) → new_explanation(5)</span></span>
<span id="cb14-58"><a href=""></a>image_input    <span class="op">=</span> py_cnn.<span class="bu">input</span>                                   <span class="co"># shape=(None,28,28,1)</span></span>
<span id="cb14-59"><a href=""></a>feature_tensor <span class="op">=</span> py_cnn.get_layer(<span class="st">"feature_layer"</span>).output       <span class="co"># shape=(None,128)</span></span>
<span id="cb14-60"><a href=""></a>explanation_tensor <span class="op">=</span> new_ex_layer(feature_tensor)               <span class="co"># shape=(None,5)</span></span>
<span id="cb14-61"><a href=""></a></span>
<span id="cb14-62"><a href=""></a>full_model <span class="op">=</span> tf.keras.Model(</span>
<span id="cb14-63"><a href=""></a>    inputs  <span class="op">=</span> image_input,</span>
<span id="cb14-64"><a href=""></a>    outputs <span class="op">=</span> explanation_tensor,</span>
<span id="cb14-65"><a href=""></a>    name    <span class="op">=</span> <span class="st">"cnn_srae_fused"</span></span>
<span id="cb14-66"><a href=""></a>)</span>
<span id="cb14-67"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Full fused model summary:"</span>)</span>
<span id="cb14-68"><a href=""></a>full_model.summary()</span>
<span id="cb14-69"><a href=""></a></span>
<span id="cb14-70"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-71"><a href=""></a><span class="co"># 4) Instantiate ExcitationBP on the fused model:</span></span>
<span id="cb14-72"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-73"><a href=""></a>ebp <span class="op">=</span> ExcitationBP(full_model)</span>
<span id="cb14-74"><a href=""></a></span>
<span id="cb14-75"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-76"><a href=""></a><span class="co"># 5) Load MNIST and select examples:</span></span>
<span id="cb14-77"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-78"><a href=""></a>(x_train, y_train), (x_test, y_test) <span class="op">=</span> tf.keras.datasets.mnist.load_data()</span>
<span id="cb14-79"><a href=""></a>x_test <span class="op">=</span> x_test.astype(<span class="st">"float32"</span>) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb14-80"><a href=""></a>x_test <span class="op">=</span> np.expand_dims(x_test, axis<span class="op">=-</span><span class="dv">1</span>)  <span class="co"># shape = (N, 28, 28, 1)</span></span>
<span id="cb14-81"><a href=""></a></span>
<span id="cb14-82"><a href=""></a><span class="co"># (a) first five examples of “4”</span></span>
<span id="cb14-83"><a href=""></a>four_indices <span class="op">=</span> np.where(y_test <span class="op">==</span> <span class="dv">4</span>)[<span class="dv">0</span>]</span>
<span id="cb14-84"><a href=""></a>sel4 <span class="op">=</span> four_indices[:<span class="dv">5</span>]</span>
<span id="cb14-85"><a href=""></a></span>
<span id="cb14-86"><a href=""></a><span class="co"># (b) one example each of [2,3,6,7,8,9]</span></span>
<span id="cb14-87"><a href=""></a>digits_b <span class="op">=</span> [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>]</span>
<span id="cb14-88"><a href=""></a>sel_b <span class="op">=</span> []</span>
<span id="cb14-89"><a href=""></a><span class="cf">for</span> d <span class="kw">in</span> digits_b:</span>
<span id="cb14-90"><a href=""></a>    idx_list <span class="op">=</span> np.where(y_test <span class="op">==</span> d)[<span class="dv">0</span>]</span>
<span id="cb14-91"><a href=""></a>    sel_b.append(idx_list[<span class="dv">0</span>])</span>
<span id="cb14-92"><a href=""></a></span>
<span id="cb14-93"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Plot (a): indices of the first five 4’s:"</span>, sel4.tolist())</span>
<span id="cb14-94"><a href=""></a><span class="bu">print</span>(<span class="st">"Plot (b): indices of one example each of [2,3,6,7,8,9]:"</span>, sel_b)</span>
<span id="cb14-95"><a href=""></a></span>
<span id="cb14-96"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-97"><a href=""></a><span class="co"># 6) Helper to compute all c-MWP maps for a single index:</span></span>
<span id="cb14-98"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-99"><a href=""></a><span class="kw">def</span> compute_cmwp_for_index(idx):</span>
<span id="cb14-100"><a href=""></a>    <span class="co">"""</span></span>
<span id="cb14-101"><a href=""></a><span class="co">    Given a single MNIST index `idx`, returns:</span></span>
<span id="cb14-102"><a href=""></a><span class="co">      - orig_img:  (28×28) array</span></span>
<span id="cb14-103"><a href=""></a><span class="co">      - x_feats:   length‐5 array of X‐feature activations</span></span>
<span id="cb14-104"><a href=""></a><span class="co">      - cmwp_maps: list of five (28×28) heatmaps (one per X‐feature)</span></span>
<span id="cb14-105"><a href=""></a><span class="co">    """</span></span>
<span id="cb14-106"><a href=""></a>    <span class="co"># 1) Grab the (1,28,28,1) input, run it through the fused model</span></span>
<span id="cb14-107"><a href=""></a>    img <span class="op">=</span> x_test[idx : idx <span class="op">+</span> <span class="dv">1</span>, ...]                          <span class="co"># shape=(1,28,28,1)</span></span>
<span id="cb14-108"><a href=""></a>    x_feats <span class="op">=</span> full_model.predict(img, verbose<span class="op">=</span><span class="dv">0</span>).reshape(<span class="op">-</span><span class="dv">1</span>)  <span class="co"># shape=(5,)</span></span>
<span id="cb14-109"><a href=""></a></span>
<span id="cb14-110"><a href=""></a>    <span class="co"># 2) Compute c-MWP for each X‐feature i in [0..4]</span></span>
<span id="cb14-111"><a href=""></a>    cmwp_maps <span class="op">=</span> []</span>
<span id="cb14-112"><a href=""></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(x_feats)):</span>
<span id="cb14-113"><a href=""></a>        hm_tensor <span class="op">=</span> ebp.excite(img, <span class="st">"explanation"</span>, i)</span>
<span id="cb14-114"><a href=""></a>        hm <span class="op">=</span> hm_tensor.numpy().squeeze()  <span class="co"># shape=(28,28)</span></span>
<span id="cb14-115"><a href=""></a>        cmwp_maps.append(hm)</span>
<span id="cb14-116"><a href=""></a>    <span class="cf">return</span> img.squeeze(), x_feats, cmwp_maps</span>
<span id="cb14-117"><a href=""></a></span>
<span id="cb14-118"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-119"><a href=""></a><span class="co"># 7) Plot (a): “first five 4’s” in a 5×6 grid:</span></span>
<span id="cb14-120"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-121"><a href=""></a>num_xfeat <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb14-122"><a href=""></a>n_rows_a  <span class="op">=</span> <span class="bu">len</span>(sel4)</span>
<span id="cb14-123"><a href=""></a>n_cols    <span class="op">=</span> num_xfeat <span class="op">+</span> <span class="dv">1</span>  <span class="co"># one column for the original, plus five heatmaps</span></span>
<span id="cb14-124"><a href=""></a></span>
<span id="cb14-125"><a href=""></a>plt.figure(figsize<span class="op">=</span>(n_cols <span class="op">*</span> <span class="dv">2</span>, n_rows_a <span class="op">*</span> <span class="dv">2</span>))</span>
<span id="cb14-126"><a href=""></a>plt.suptitle(<span class="st">"Plot (a): c-MWP heatmaps for the first five 4’s"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, y<span class="op">=</span><span class="fl">0.92</span>)</span>
<span id="cb14-127"><a href=""></a></span>
<span id="cb14-128"><a href=""></a><span class="cf">for</span> row_i, idx <span class="kw">in</span> <span class="bu">enumerate</span>(sel4):</span>
<span id="cb14-129"><a href=""></a>    orig_img, x_feats, maps <span class="op">=</span> compute_cmwp_for_index(idx)</span>
<span id="cb14-130"><a href=""></a></span>
<span id="cb14-131"><a href=""></a>    <span class="co"># ─── Column 0: Original MNIST “4” ──────────────────────</span></span>
<span id="cb14-132"><a href=""></a>    ax <span class="op">=</span> plt.subplot(n_rows_a, n_cols, row_i <span class="op">*</span> n_cols <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb14-133"><a href=""></a>    <span class="co"># Just show orig_img directly (no [::-1,:], no origin='lower'):</span></span>
<span id="cb14-134"><a href=""></a>    plt.imshow(orig_img, cmap<span class="op">=</span><span class="st">"gray"</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-135"><a href=""></a>    ax.set_xticks([])<span class="op">;</span> ax.set_yticks([])</span>
<span id="cb14-136"><a href=""></a>    ax.set_title(<span class="ss">f"Original Digit"</span>, color<span class="op">=</span><span class="st">"white"</span>, backgroundcolor<span class="op">=</span><span class="st">"black"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb14-137"><a href=""></a></span>
<span id="cb14-138"><a href=""></a>    <span class="co"># ─── Columns 1..5: c-MWP heatmaps for X₁…X₅ ─────────────</span></span>
<span id="cb14-139"><a href=""></a>    <span class="cf">for</span> feat_i <span class="kw">in</span> <span class="bu">range</span>(num_xfeat):</span>
<span id="cb14-140"><a href=""></a>        hm <span class="op">=</span> maps[feat_i]</span>
<span id="cb14-141"><a href=""></a>        title_str <span class="op">=</span> <span class="ss">f"X</span><span class="sc">{</span>feat_i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>x_feats[feat_i]<span class="sc">:.4f}</span><span class="ss">"</span></span>
<span id="cb14-142"><a href=""></a></span>
<span id="cb14-143"><a href=""></a>        ax <span class="op">=</span> plt.subplot(n_rows_a, n_cols, row_i <span class="op">*</span> n_cols <span class="op">+</span> (feat_i <span class="op">+</span> <span class="dv">2</span>))</span>
<span id="cb14-144"><a href=""></a>        <span class="co"># Show hm as‐is (no [::-1,:], no origin='lower'):</span></span>
<span id="cb14-145"><a href=""></a>        plt.imshow(hm, cmap<span class="op">=</span><span class="st">"viridis"</span>, vmin<span class="op">=</span>hm.<span class="bu">min</span>(), vmax<span class="op">=</span>hm.<span class="bu">max</span>())</span>
<span id="cb14-146"><a href=""></a>        ax.set_xticks([])<span class="op">;</span> ax.set_yticks([])</span>
<span id="cb14-147"><a href=""></a>        ax.set_title(title_str, color<span class="op">=</span><span class="st">"white"</span>, backgroundcolor<span class="op">=</span><span class="st">"black"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb14-148"><a href=""></a></span>
<span id="cb14-149"><a href=""></a>plt.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.90</span>])</span>
<span id="cb14-150"><a href=""></a>os.makedirs(<span class="st">"figures"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-151"><a href=""></a>out_a <span class="op">=</span> os.path.join(<span class="st">"figures"</span>, <span class="st">"plot_a_first_fives_4s.png"</span>)</span>
<span id="cb14-152"><a href=""></a>plt.savefig(out_a, dpi<span class="op">=</span><span class="dv">150</span>, bbox_inches<span class="op">=</span><span class="st">"tight"</span>)</span>
<span id="cb14-153"><a href=""></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Saved Plot (a) to </span><span class="sc">{</span>out_a<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-154"><a href=""></a>plt.close()</span>
<span id="cb14-155"><a href=""></a></span>
<span id="cb14-156"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-157"><a href=""></a><span class="co"># 8) Plot (b): digits [2,3,6,7,8,9] in a 6×6 grid:</span></span>
<span id="cb14-158"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb14-159"><a href=""></a>n_rows_b <span class="op">=</span> <span class="bu">len</span>(sel_b)</span>
<span id="cb14-160"><a href=""></a>plt.figure(figsize<span class="op">=</span>(n_cols <span class="op">*</span> <span class="dv">2</span>, n_rows_b <span class="op">*</span> <span class="dv">2</span>))</span>
<span id="cb14-161"><a href=""></a>plt.suptitle(<span class="st">"Plot (b): c-MWP heatmaps for digits [2,3,6,7,8,9]"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, y<span class="op">=</span><span class="fl">0.92</span>)</span>
<span id="cb14-162"><a href=""></a></span>
<span id="cb14-163"><a href=""></a><span class="cf">for</span> row_i, idx <span class="kw">in</span> <span class="bu">enumerate</span>(sel_b):</span>
<span id="cb14-164"><a href=""></a>    orig_img, x_feats, maps <span class="op">=</span> compute_cmwp_for_index(idx)</span>
<span id="cb14-165"><a href=""></a>    digit_label <span class="op">=</span> <span class="bu">int</span>(y_test[idx])</span>
<span id="cb14-166"><a href=""></a></span>
<span id="cb14-167"><a href=""></a>    <span class="co"># ─── Column 0: Original MNIST digit ─────────────────────</span></span>
<span id="cb14-168"><a href=""></a>    ax <span class="op">=</span> plt.subplot(n_rows_b, n_cols, row_i <span class="op">*</span> n_cols <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb14-169"><a href=""></a>    plt.imshow(orig_img, cmap<span class="op">=</span><span class="st">"gray"</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>)  <span class="co"># no flips</span></span>
<span id="cb14-170"><a href=""></a>    ax.set_xticks([])<span class="op">;</span> ax.set_yticks([])</span>
<span id="cb14-171"><a href=""></a>    ax.set_title(<span class="ss">f"Idx=</span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>digit_label<span class="sc">}</span><span class="ss">"</span>, color<span class="op">=</span><span class="st">"white"</span>, backgroundcolor<span class="op">=</span><span class="st">"black"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb14-172"><a href=""></a></span>
<span id="cb14-173"><a href=""></a>    <span class="co"># ─── Columns 1..5: c-MWP heatmaps for X₁…X₅ ─────────────</span></span>
<span id="cb14-174"><a href=""></a>    <span class="cf">for</span> feat_i <span class="kw">in</span> <span class="bu">range</span>(num_xfeat):</span>
<span id="cb14-175"><a href=""></a>        hm <span class="op">=</span> maps[feat_i]</span>
<span id="cb14-176"><a href=""></a>        title_str <span class="op">=</span> <span class="ss">f"X</span><span class="sc">{</span>feat_i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>x_feats[feat_i]<span class="sc">:.4f}</span><span class="ss">"</span></span>
<span id="cb14-177"><a href=""></a></span>
<span id="cb14-178"><a href=""></a>        ax <span class="op">=</span> plt.subplot(n_rows_b, n_cols, row_i <span class="op">*</span> n_cols <span class="op">+</span> (feat_i <span class="op">+</span> <span class="dv">2</span>))</span>
<span id="cb14-179"><a href=""></a>        plt.imshow(hm, cmap<span class="op">=</span><span class="st">"viridis"</span>, vmin<span class="op">=</span>hm.<span class="bu">min</span>(), vmax<span class="op">=</span>hm.<span class="bu">max</span>())</span>
<span id="cb14-180"><a href=""></a>        ax.set_xticks([])<span class="op">;</span> ax.set_yticks([])</span>
<span id="cb14-181"><a href=""></a>        ax.set_title(title_str, color<span class="op">=</span><span class="st">"white"</span>, backgroundcolor<span class="op">=</span><span class="st">"black"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb14-182"><a href=""></a></span>
<span id="cb14-183"><a href=""></a>plt.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.90</span>])</span>
<span id="cb14-184"><a href=""></a>out_b <span class="op">=</span> os.path.join(<span class="st">"figures"</span>, <span class="st">"plot_b_digits_236789.png"</span>)</span>
<span id="cb14-185"><a href=""></a>plt.savefig(out_b, dpi<span class="op">=</span><span class="dv">150</span>, bbox_inches<span class="op">=</span><span class="st">"tight"</span>)</span>
<span id="cb14-186"><a href=""></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Saved Plot (b) to </span><span class="sc">{</span>out_b<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-187"><a href=""></a>plt.close()</span>
<span id="cb14-188"><a href=""></a></span>
<span id="cb14-189"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">All plots generated.</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="plot_each_digit_first5.py">plot_each_digit_first5.py</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href=""></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb15-2"><a href=""></a><span class="co"># plot_each_digit_first5.py</span></span>
<span id="cb15-3"><a href=""></a></span>
<span id="cb15-4"><a href=""></a><span class="im">import</span> os</span>
<span id="cb15-5"><a href=""></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-6"><a href=""></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb15-7"><a href=""></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb15-8"><a href=""></a><span class="im">from</span> excitationbp <span class="im">import</span> ExcitationBP</span>
<span id="cb15-9"><a href=""></a></span>
<span id="cb15-10"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb15-11"><a href=""></a><span class="co"># 1) Load the CNN‐up‐to‐Dense(128) and SRAE “explanation” models, then stitch them</span></span>
<span id="cb15-12"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb15-13"><a href=""></a>cnn_path  <span class="op">=</span> os.path.join(<span class="st">"saved_models"</span>, <span class="st">"base_cnn_for_excitebp"</span>)</span>
<span id="cb15-14"><a href=""></a>srae_path <span class="op">=</span> os.path.join(<span class="st">"saved_models"</span>, <span class="st">"srae_explainer"</span>)</span>
<span id="cb15-15"><a href=""></a></span>
<span id="cb15-16"><a href=""></a><span class="bu">print</span>(<span class="st">"Loading base CNN from:"</span>, cnn_path)</span>
<span id="cb15-17"><a href=""></a>py_cnn <span class="op">=</span> tf.keras.models.load_model(cnn_path)</span>
<span id="cb15-18"><a href=""></a></span>
<span id="cb15-19"><a href=""></a><span class="bu">print</span>(<span class="st">"Loading SRAE explainer from:"</span>, srae_path)</span>
<span id="cb15-20"><a href=""></a>py_srae <span class="op">=</span> tf.keras.models.load_model(srae_path, <span class="bu">compile</span><span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-21"><a href=""></a></span>
<span id="cb15-22"><a href=""></a><span class="co"># Verify layer names</span></span>
<span id="cb15-23"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- CNN layers ---"</span>)</span>
<span id="cb15-24"><a href=""></a><span class="cf">for</span> layer <span class="kw">in</span> py_cnn.layers:</span>
<span id="cb15-25"><a href=""></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>layer<span class="sc">.</span>name<span class="sc">:30s}</span><span class="ss">  </span><span class="sc">{</span>layer<span class="sc">.</span>output_shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-26"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- SRAE layers ---"</span>)</span>
<span id="cb15-27"><a href=""></a><span class="cf">for</span> layer <span class="kw">in</span> py_srae.layers:</span>
<span id="cb15-28"><a href=""></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>layer<span class="sc">.</span>name<span class="sc">:30s}</span><span class="ss">  </span><span class="sc">{</span>layer<span class="sc">.</span>input_shape<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>layer<span class="sc">.</span>output_shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-29"><a href=""></a></span>
<span id="cb15-30"><a href=""></a><span class="co"># We expect py_cnn.get_layer("feature_layer").output_shape[-1] == 128</span></span>
<span id="cb15-31"><a href=""></a><span class="cf">assert</span> py_cnn.get_layer(<span class="st">"feature_layer"</span>).output_shape[<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> <span class="dv">128</span></span>
<span id="cb15-32"><a href=""></a><span class="co"># We expect py_srae.get_layer("explanation").input_shape[-1] == 128</span></span>
<span id="cb15-33"><a href=""></a><span class="cf">assert</span> py_srae.get_layer(<span class="st">"explanation"</span>).input_shape[<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> <span class="dv">128</span></span>
<span id="cb15-34"><a href=""></a></span>
<span id="cb15-35"><a href=""></a><span class="co"># Build a brand‐new Dense( “explanation” ) layer so that</span></span>
<span id="cb15-36"><a href=""></a><span class="co"># it has a real layer name “explanation” (not a Lambda).</span></span>
<span id="cb15-37"><a href=""></a>orig_expl <span class="op">=</span> py_srae.get_layer(<span class="st">"explanation"</span>)</span>
<span id="cb15-38"><a href=""></a>new_expl  <span class="op">=</span> tf.keras.layers.Dense(</span>
<span id="cb15-39"><a href=""></a>    units      <span class="op">=</span> orig_expl.units,</span>
<span id="cb15-40"><a href=""></a>    activation <span class="op">=</span> orig_expl.activation,</span>
<span id="cb15-41"><a href=""></a>    use_bias   <span class="op">=</span> orig_expl.use_bias,</span>
<span id="cb15-42"><a href=""></a>    name       <span class="op">=</span> <span class="st">"explanation"</span></span>
<span id="cb15-43"><a href=""></a>)</span>
<span id="cb15-44"><a href=""></a>new_expl.build((<span class="va">None</span>, <span class="dv">128</span>))</span>
<span id="cb15-45"><a href=""></a>new_expl.set_weights(orig_expl.get_weights())</span>
<span id="cb15-46"><a href=""></a></span>
<span id="cb15-47"><a href=""></a><span class="co"># Stitch it onto the CNN’s “feature_layer”</span></span>
<span id="cb15-48"><a href=""></a>image_input       <span class="op">=</span> py_cnn.<span class="bu">input</span></span>
<span id="cb15-49"><a href=""></a>feature_tensor    <span class="op">=</span> py_cnn.get_layer(<span class="st">"feature_layer"</span>).output</span>
<span id="cb15-50"><a href=""></a>explanation_tensor <span class="op">=</span> new_expl(feature_tensor)</span>
<span id="cb15-51"><a href=""></a></span>
<span id="cb15-52"><a href=""></a>full_model <span class="op">=</span> tf.keras.Model(</span>
<span id="cb15-53"><a href=""></a>    inputs  <span class="op">=</span> image_input,</span>
<span id="cb15-54"><a href=""></a>    outputs <span class="op">=</span> explanation_tensor,</span>
<span id="cb15-55"><a href=""></a>    name    <span class="op">=</span> <span class="st">"cnn_srae_fused"</span></span>
<span id="cb15-56"><a href=""></a>)</span>
<span id="cb15-57"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Full fused model summary:"</span>)</span>
<span id="cb15-58"><a href=""></a>full_model.summary()</span>
<span id="cb15-59"><a href=""></a></span>
<span id="cb15-60"><a href=""></a><span class="co"># Wrap with ExcitationBP</span></span>
<span id="cb15-61"><a href=""></a>ebp <span class="op">=</span> ExcitationBP(full_model)</span>
<span id="cb15-62"><a href=""></a></span>
<span id="cb15-63"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb15-64"><a href=""></a><span class="co"># 2) Load MNIST test set</span></span>
<span id="cb15-65"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb15-66"><a href=""></a>(_, _), (x_test, y_test) <span class="op">=</span> tf.keras.datasets.mnist.load_data()</span>
<span id="cb15-67"><a href=""></a>x_test <span class="op">=</span> x_test.astype(<span class="st">"float32"</span>) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb15-68"><a href=""></a>x_test <span class="op">=</span> np.expand_dims(x_test, axis<span class="op">=-</span><span class="dv">1</span>)  <span class="co"># shape = (N,28,28,1)</span></span>
<span id="cb15-69"><a href=""></a></span>
<span id="cb15-70"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb15-71"><a href=""></a><span class="co"># 3) For each digit in [0,1,2,3,5,6,7,8,9], pick the first five indices:</span></span>
<span id="cb15-72"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb15-73"><a href=""></a>digits_to_plot <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>]</span>
<span id="cb15-74"><a href=""></a>first5_dict <span class="op">=</span> {}</span>
<span id="cb15-75"><a href=""></a></span>
<span id="cb15-76"><a href=""></a><span class="cf">for</span> d <span class="kw">in</span> digits_to_plot:</span>
<span id="cb15-77"><a href=""></a>    idxs <span class="op">=</span> np.where(y_test <span class="op">==</span> d)[<span class="dv">0</span>]</span>
<span id="cb15-78"><a href=""></a>    <span class="cf">if</span> <span class="bu">len</span>(idxs) <span class="op">&lt;</span> <span class="dv">5</span>:</span>
<span id="cb15-79"><a href=""></a>        <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="ss">f"Found fewer than 5 examples of digit </span><span class="sc">{</span>d<span class="sc">}</span><span class="ss"> in test set!"</span>)</span>
<span id="cb15-80"><a href=""></a>    first5_dict[d] <span class="op">=</span> idxs[:<span class="dv">5</span>]</span>
<span id="cb15-81"><a href=""></a></span>
<span id="cb15-82"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Will create one figure per digit (first 5 examples each)."</span>)</span>
<span id="cb15-83"><a href=""></a><span class="cf">for</span> d <span class="kw">in</span> digits_to_plot:</span>
<span id="cb15-84"><a href=""></a>    <span class="bu">print</span>(<span class="ss">f"  Digit </span><span class="sc">{</span>d<span class="sc">}</span><span class="ss">: indices </span><span class="sc">{</span>first5_dict[d]<span class="sc">.</span>tolist()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-85"><a href=""></a></span>
<span id="cb15-86"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb15-87"><a href=""></a><span class="co"># 4) Helper: given a single test‐index, compute:</span></span>
<span id="cb15-88"><a href=""></a><span class="co">#      (a) orig_img   = 28×28 array</span></span>
<span id="cb15-89"><a href=""></a><span class="co">#      (b) x_feats    = length‐5 np.ndarray of explanation activations</span></span>
<span id="cb15-90"><a href=""></a><span class="co">#      (c) cmwp_maps  = list of five (28×28) c-MWP heatmaps</span></span>
<span id="cb15-91"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb15-92"><a href=""></a><span class="kw">def</span> compute_cmwp_for_index(idx):</span>
<span id="cb15-93"><a href=""></a>    <span class="co"># “inp” shape = (1,28,28,1)</span></span>
<span id="cb15-94"><a href=""></a>    inp <span class="op">=</span> x_test[idx : idx <span class="op">+</span> <span class="dv">1</span>, ...]</span>
<span id="cb15-95"><a href=""></a>    <span class="co"># (1×5) → reshape to (5,) for X₁…X₅ activations</span></span>
<span id="cb15-96"><a href=""></a>    x_feats <span class="op">=</span> full_model.predict(inp, verbose<span class="op">=</span><span class="dv">0</span>).reshape(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb15-97"><a href=""></a>    cmwp_maps <span class="op">=</span> []</span>
<span id="cb15-98"><a href=""></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(x_feats)):</span>
<span id="cb15-99"><a href=""></a>        hm_t  <span class="op">=</span> ebp.excite(inp, <span class="st">"explanation"</span>, i)</span>
<span id="cb15-100"><a href=""></a>        hm_np <span class="op">=</span> hm_t.numpy().squeeze()  <span class="co"># → (28,28)</span></span>
<span id="cb15-101"><a href=""></a>        cmwp_maps.append(hm_np)</span>
<span id="cb15-102"><a href=""></a>    orig_img <span class="op">=</span> inp.squeeze()  <span class="co"># (28,28)</span></span>
<span id="cb15-103"><a href=""></a>    <span class="cf">return</span> orig_img, x_feats, cmwp_maps</span>
<span id="cb15-104"><a href=""></a></span>
<span id="cb15-105"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb15-106"><a href=""></a><span class="co"># 5) Loop over each digit, build a separate figure, and save it:</span></span>
<span id="cb15-107"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb15-108"><a href=""></a>os.makedirs(<span class="st">"figures"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-109"><a href=""></a></span>
<span id="cb15-110"><a href=""></a><span class="cf">for</span> d <span class="kw">in</span> digits_to_plot:</span>
<span id="cb15-111"><a href=""></a>    five_indices <span class="op">=</span> first5_dict[d]</span>
<span id="cb15-112"><a href=""></a></span>
<span id="cb15-113"><a href=""></a>    <span class="co"># Build a new figure: 5 rows × 6 columns</span></span>
<span id="cb15-114"><a href=""></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span> <span class="op">*</span> <span class="fl">2.0</span>, <span class="dv">5</span> <span class="op">*</span> <span class="fl">2.0</span>))</span>
<span id="cb15-115"><a href=""></a>    plt.suptitle(</span>
<span id="cb15-116"><a href=""></a>        <span class="ss">f"c-MWP heatmaps for the first five '</span><span class="sc">{</span>d<span class="sc">}</span><span class="ss">'s"</span>,</span>
<span id="cb15-117"><a href=""></a>        fontsize <span class="op">=</span> <span class="dv">16</span>,</span>
<span id="cb15-118"><a href=""></a>        y        <span class="op">=</span> <span class="fl">0.92</span></span>
<span id="cb15-119"><a href=""></a>    )</span>
<span id="cb15-120"><a href=""></a></span>
<span id="cb15-121"><a href=""></a>    <span class="co"># For each of the five examples of digit d:</span></span>
<span id="cb15-122"><a href=""></a>    <span class="cf">for</span> row_i, idx <span class="kw">in</span> <span class="bu">enumerate</span>(five_indices):</span>
<span id="cb15-123"><a href=""></a>        orig_img, x_feats, cmwp_maps <span class="op">=</span> compute_cmwp_for_index(idx)</span>
<span id="cb15-124"><a href=""></a></span>
<span id="cb15-125"><a href=""></a>        <span class="co"># ─── Column 0 (Original Digit) ─────────────────────────</span></span>
<span id="cb15-126"><a href=""></a>        ax <span class="op">=</span> plt.subplot(<span class="dv">5</span>, <span class="dv">6</span>, row_i <span class="op">*</span> <span class="dv">6</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb15-127"><a href=""></a>        plt.imshow(orig_img, cmap<span class="op">=</span><span class="st">"gray"</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-128"><a href=""></a>        ax.set_xticks([])<span class="op">;</span> ax.set_yticks([])</span>
<span id="cb15-129"><a href=""></a>        <span class="co"># Title = “Original Digit” (no index)</span></span>
<span id="cb15-130"><a href=""></a>        ax.set_title(<span class="st">"Original Digit"</span>,</span>
<span id="cb15-131"><a href=""></a>                     color<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb15-132"><a href=""></a>                     backgroundcolor<span class="op">=</span><span class="st">"black"</span>,</span>
<span id="cb15-133"><a href=""></a>                     fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb15-134"><a href=""></a></span>
<span id="cb15-135"><a href=""></a>        <span class="co"># ─── Columns 1…5 (c-MWP for X₁…X₅) ───────────────────────</span></span>
<span id="cb15-136"><a href=""></a>        <span class="cf">for</span> feat_i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb15-137"><a href=""></a>            hm   <span class="op">=</span> cmwp_maps[feat_i]</span>
<span id="cb15-138"><a href=""></a>            val  <span class="op">=</span> x_feats[feat_i]</span>
<span id="cb15-139"><a href=""></a>            title_str <span class="op">=</span> <span class="ss">f"X</span><span class="sc">{</span>feat_i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>val<span class="sc">:.3f}</span><span class="ss">"</span></span>
<span id="cb15-140"><a href=""></a></span>
<span id="cb15-141"><a href=""></a>            ax <span class="op">=</span> plt.subplot(<span class="dv">5</span>, <span class="dv">6</span>, row_i <span class="op">*</span> <span class="dv">6</span> <span class="op">+</span> (feat_i <span class="op">+</span> <span class="dv">2</span>))</span>
<span id="cb15-142"><a href=""></a>            plt.imshow(hm, cmap<span class="op">=</span><span class="st">"viridis"</span>, vmin<span class="op">=</span>hm.<span class="bu">min</span>(), vmax<span class="op">=</span>hm.<span class="bu">max</span>())</span>
<span id="cb15-143"><a href=""></a>            ax.set_xticks([])<span class="op">;</span> ax.set_yticks([])</span>
<span id="cb15-144"><a href=""></a>            ax.set_title(title_str,</span>
<span id="cb15-145"><a href=""></a>                         color<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb15-146"><a href=""></a>                         backgroundcolor<span class="op">=</span><span class="st">"black"</span>,</span>
<span id="cb15-147"><a href=""></a>                         fontsize<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb15-148"><a href=""></a></span>
<span id="cb15-149"><a href=""></a>    plt.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.90</span>])</span>
<span id="cb15-150"><a href=""></a>    save_name <span class="op">=</span> <span class="ss">f"plot_digit_</span><span class="sc">{</span>d<span class="sc">}</span><span class="ss">_first5.png"</span></span>
<span id="cb15-151"><a href=""></a>    save_path <span class="op">=</span> os.path.join(<span class="st">"figures"</span>, save_name)</span>
<span id="cb15-152"><a href=""></a>    plt.savefig(save_path, dpi<span class="op">=</span><span class="dv">150</span>, bbox_inches<span class="op">=</span><span class="st">"tight"</span>)</span>
<span id="cb15-153"><a href=""></a>    <span class="bu">print</span>(<span class="ss">f"Saved figure for digit </span><span class="sc">{</span>d<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>save_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-154"><a href=""></a>    plt.close()</span>
<span id="cb15-155"><a href=""></a></span>
<span id="cb15-156"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">All done. You should now have nine separate PNGs in ./figures/:</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb15-157"><a href=""></a>      <span class="st">"  plot_digit_0_first5.png</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb15-158"><a href=""></a>      <span class="st">"  plot_digit_1_first5.png</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb15-159"><a href=""></a>      <span class="st">"  plot_digit_2_first5.png</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb15-160"><a href=""></a>      <span class="st">"  plot_digit_3_first5.png</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb15-161"><a href=""></a>      <span class="st">"  plot_digit_5_first5.png</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb15-162"><a href=""></a>      <span class="st">"  plot_digit_6_first5.png</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb15-163"><a href=""></a>      <span class="st">"  plot_digit_7_first5.png</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb15-164"><a href=""></a>      <span class="st">"  plot_digit_8_first5.png</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb15-165"><a href=""></a>      <span class="st">"  plot_digit_9_first5.png</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="average_cmwp_per_digit.py">average_cmwp_per_digit.py</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href=""></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb16-2"><a href=""></a><span class="co"># average_cmwp_per_digit.py</span></span>
<span id="cb16-3"><a href=""></a></span>
<span id="cb16-4"><a href=""></a><span class="im">import</span> os</span>
<span id="cb16-5"><a href=""></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-6"><a href=""></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb16-7"><a href=""></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-8"><a href=""></a><span class="im">from</span> excitationbp <span class="im">import</span> ExcitationBP</span>
<span id="cb16-9"><a href=""></a></span>
<span id="cb16-10"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb16-11"><a href=""></a><span class="co"># 1) Load &amp; stitch the CNN + SRAE so that “explanation” is a real Dense layer.</span></span>
<span id="cb16-12"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb16-13"><a href=""></a>cnn_path  <span class="op">=</span> os.path.join(<span class="st">"saved_models"</span>, <span class="st">"base_cnn_for_excitebp"</span>)</span>
<span id="cb16-14"><a href=""></a>srae_path <span class="op">=</span> os.path.join(<span class="st">"saved_models"</span>, <span class="st">"srae_explainer"</span>)</span>
<span id="cb16-15"><a href=""></a></span>
<span id="cb16-16"><a href=""></a><span class="bu">print</span>(<span class="st">"Loading base CNN from:"</span>, cnn_path)</span>
<span id="cb16-17"><a href=""></a>py_cnn <span class="op">=</span> tf.keras.models.load_model(cnn_path)</span>
<span id="cb16-18"><a href=""></a></span>
<span id="cb16-19"><a href=""></a><span class="bu">print</span>(<span class="st">"Loading SRAE explainer from:"</span>, srae_path)</span>
<span id="cb16-20"><a href=""></a>py_srae <span class="op">=</span> tf.keras.models.load_model(srae_path, <span class="bu">compile</span><span class="op">=</span><span class="va">False</span>)</span>
<span id="cb16-21"><a href=""></a></span>
<span id="cb16-22"><a href=""></a><span class="co"># If “explanation” was exported as a Lambda, replace it with a real Dense</span></span>
<span id="cb16-23"><a href=""></a>orig_expl <span class="op">=</span> py_srae.get_layer(<span class="st">"explanation"</span>)</span>
<span id="cb16-24"><a href=""></a>new_expl <span class="op">=</span> tf.keras.layers.Dense(</span>
<span id="cb16-25"><a href=""></a>    units      <span class="op">=</span> orig_expl.units,</span>
<span id="cb16-26"><a href=""></a>    activation <span class="op">=</span> orig_expl.activation,</span>
<span id="cb16-27"><a href=""></a>    use_bias   <span class="op">=</span> orig_expl.use_bias,</span>
<span id="cb16-28"><a href=""></a>    name       <span class="op">=</span> <span class="st">"explanation"</span></span>
<span id="cb16-29"><a href=""></a>)</span>
<span id="cb16-30"><a href=""></a><span class="co"># Build &amp; copy weights</span></span>
<span id="cb16-31"><a href=""></a>new_expl.build(input_shape<span class="op">=</span>(<span class="va">None</span>, orig_expl.input_shape[<span class="op">-</span><span class="dv">1</span>]))</span>
<span id="cb16-32"><a href=""></a>new_expl.set_weights(orig_expl.get_weights())</span>
<span id="cb16-33"><a href=""></a></span>
<span id="cb16-34"><a href=""></a><span class="co"># Re‐stitch onto the CNN’s feature_layer output</span></span>
<span id="cb16-35"><a href=""></a>image_input        <span class="op">=</span> py_cnn.<span class="bu">input</span>                              <span class="co"># (None,28,28,1)</span></span>
<span id="cb16-36"><a href=""></a>feature_tensor     <span class="op">=</span> py_cnn.get_layer(<span class="st">"feature_layer"</span>).output  <span class="co"># (None,128)</span></span>
<span id="cb16-37"><a href=""></a>explanation_tensor <span class="op">=</span> new_expl(feature_tensor)                  <span class="co"># (None,5)</span></span>
<span id="cb16-38"><a href=""></a></span>
<span id="cb16-39"><a href=""></a>full_model <span class="op">=</span> tf.keras.Model(</span>
<span id="cb16-40"><a href=""></a>    inputs  <span class="op">=</span> image_input,</span>
<span id="cb16-41"><a href=""></a>    outputs <span class="op">=</span> explanation_tensor,</span>
<span id="cb16-42"><a href=""></a>    name    <span class="op">=</span> <span class="st">"cnn_srae_fused"</span></span>
<span id="cb16-43"><a href=""></a>)</span>
<span id="cb16-44"><a href=""></a></span>
<span id="cb16-45"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Full fused model summary:"</span>)</span>
<span id="cb16-46"><a href=""></a>full_model.summary()</span>
<span id="cb16-47"><a href=""></a></span>
<span id="cb16-48"><a href=""></a><span class="co"># Wrap in ExcitationBP</span></span>
<span id="cb16-49"><a href=""></a>ebp <span class="op">=</span> ExcitationBP(full_model)</span>
<span id="cb16-50"><a href=""></a></span>
<span id="cb16-51"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb16-52"><a href=""></a><span class="co"># 2) Load MNIST test set and group indices by digit</span></span>
<span id="cb16-53"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb16-54"><a href=""></a>(_, _), (x_test, y_test) <span class="op">=</span> tf.keras.datasets.mnist.load_data()</span>
<span id="cb16-55"><a href=""></a></span>
<span id="cb16-56"><a href=""></a>x_test <span class="op">=</span> x_test.astype(<span class="st">"float32"</span>) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb16-57"><a href=""></a>x_test <span class="op">=</span> np.expand_dims(x_test, axis<span class="op">=-</span><span class="dv">1</span>)   <span class="co"># shape = (10000,28,28,1)</span></span>
<span id="cb16-58"><a href=""></a>y_test <span class="op">=</span> y_test.astype(<span class="st">"int"</span>)</span>
<span id="cb16-59"><a href=""></a></span>
<span id="cb16-60"><a href=""></a>N_total <span class="op">=</span> x_test.shape[<span class="dv">0</span>]</span>
<span id="cb16-61"><a href=""></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Loaded MNIST test set: </span><span class="sc">{</span>N_total<span class="sc">}</span><span class="ss"> images."</span>)</span>
<span id="cb16-62"><a href=""></a></span>
<span id="cb16-63"><a href=""></a>digit_indices <span class="op">=</span> {d: np.where(y_test <span class="op">==</span> d)[<span class="dv">0</span>] <span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>)}</span>
<span id="cb16-64"><a href=""></a><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb16-65"><a href=""></a>    <span class="bu">print</span>(<span class="ss">f"  → Digit </span><span class="sc">{</span>d<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(digit_indices[d])<span class="sc">}</span><span class="ss"> examples"</span>)</span>
<span id="cb16-66"><a href=""></a></span>
<span id="cb16-67"><a href=""></a><span class="co"># Prepare accumulators: avg_maps[digit][feature_index] = (28×28) float64</span></span>
<span id="cb16-68"><a href=""></a>avg_maps <span class="op">=</span> [</span>
<span id="cb16-69"><a href=""></a>    [np.zeros((<span class="dv">28</span>, <span class="dv">28</span>), dtype<span class="op">=</span>np.float64) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>)]</span>
<span id="cb16-70"><a href=""></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>)</span>
<span id="cb16-71"><a href=""></a>]</span>
<span id="cb16-72"><a href=""></a>counts <span class="op">=</span> [<span class="bu">len</span>(digit_indices[d]) <span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>)]</span>
<span id="cb16-73"><a href=""></a></span>
<span id="cb16-74"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb16-75"><a href=""></a><span class="co"># 3) Accumulate c-MWP heatmaps per (digit, feature), then divide by count</span></span>
<span id="cb16-76"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb16-77"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Accumulating c-MWP maps, grouped by digit and feature…"</span>)</span>
<span id="cb16-78"><a href=""></a><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb16-79"><a href=""></a>    idxs <span class="op">=</span> digit_indices[d]</span>
<span id="cb16-80"><a href=""></a>    c <span class="op">=</span> <span class="bu">len</span>(idxs)</span>
<span id="cb16-81"><a href=""></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  → Digit </span><span class="sc">{</span>d<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss"> images…"</span>)</span>
<span id="cb16-82"><a href=""></a>    <span class="cf">for</span> (k, n) <span class="kw">in</span> <span class="bu">enumerate</span>(idxs):</span>
<span id="cb16-83"><a href=""></a>        inp <span class="op">=</span> x_test[n : n <span class="op">+</span> <span class="dv">1</span>, ...]  <span class="co"># shape = (1,28,28,1)</span></span>
<span id="cb16-84"><a href=""></a>        <span class="co"># Compute c-MWP for each of the 5 X-features</span></span>
<span id="cb16-85"><a href=""></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb16-86"><a href=""></a>            hm <span class="op">=</span> ebp.excite(inp, <span class="st">"explanation"</span>, i).numpy().squeeze()</span>
<span id="cb16-87"><a href=""></a>            avg_maps[d][i] <span class="op">+=</span> hm</span>
<span id="cb16-88"><a href=""></a></span>
<span id="cb16-89"><a href=""></a>        <span class="cf">if</span> (k <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="dv">2000</span> <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> (k <span class="op">+</span> <span class="dv">1</span>) <span class="op">==</span> c:</span>
<span id="cb16-90"><a href=""></a>            <span class="bu">print</span>(<span class="ss">f"      • processed </span><span class="sc">{</span>k<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss"> for digit </span><span class="sc">{</span>d<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-91"><a href=""></a></span>
<span id="cb16-92"><a href=""></a>    <span class="co"># Convert sums into averages</span></span>
<span id="cb16-93"><a href=""></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb16-94"><a href=""></a>        avg_maps[d][i] <span class="op">/=</span> <span class="bu">float</span>(c)</span>
<span id="cb16-95"><a href=""></a></span>
<span id="cb16-96"><a href=""></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Finished building per-digit averages (10×5 maps)."</span>)</span>
<span id="cb16-97"><a href=""></a></span>
<span id="cb16-98"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb16-99"><a href=""></a><span class="co"># 4) Plot the 10×5 grid of average heatmaps (wider figure, title at top)</span></span>
<span id="cb16-100"><a href=""></a><span class="co"># ─────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb16-101"><a href=""></a>os.makedirs(<span class="st">"figures"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-102"><a href=""></a></span>
<span id="cb16-103"><a href=""></a>fig, axes <span class="op">=</span> plt.subplots(</span>
<span id="cb16-104"><a href=""></a>    nrows    <span class="op">=</span> <span class="dv">10</span>,</span>
<span id="cb16-105"><a href=""></a>    ncols    <span class="op">=</span> <span class="dv">5</span>,</span>
<span id="cb16-106"><a href=""></a>    figsize  <span class="op">=</span> (<span class="dv">16</span>, <span class="dv">24</span>),           <span class="co"># Increased width to accommodate the legend</span></span>
<span id="cb16-107"><a href=""></a>    constrained_layout <span class="op">=</span> <span class="va">True</span></span>
<span id="cb16-108"><a href=""></a>)</span>
<span id="cb16-109"><a href=""></a>fig.suptitle(</span>
<span id="cb16-110"><a href=""></a>    <span class="st">"Average c-MWP Heatmaps per Digit (rows=0–9) &amp; Feature (cols=X₁–X₅)"</span>,</span>
<span id="cb16-111"><a href=""></a>    fontsize <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb16-112"><a href=""></a>    y        <span class="op">=</span> <span class="fl">0.99</span>                <span class="co"># Push the title to the very top</span></span>
<span id="cb16-113"><a href=""></a>)</span>
<span id="cb16-114"><a href=""></a></span>
<span id="cb16-115"><a href=""></a><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb16-116"><a href=""></a>    <span class="co"># Compute row-specific vmin/vmax over X₁..X₅ for visibility</span></span>
<span id="cb16-117"><a href=""></a>    row_min <span class="op">=</span> <span class="bu">min</span>(np.<span class="bu">min</span>(avg_maps[d][i]) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>))</span>
<span id="cb16-118"><a href=""></a>    row_max <span class="op">=</span> <span class="bu">max</span>(np.<span class="bu">max</span>(avg_maps[d][i]) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>))</span>
<span id="cb16-119"><a href=""></a></span>
<span id="cb16-120"><a href=""></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb16-121"><a href=""></a>        ax <span class="op">=</span> axes[d, i]</span>
<span id="cb16-122"><a href=""></a>        im <span class="op">=</span> ax.imshow(</span>
<span id="cb16-123"><a href=""></a>            avg_maps[d][i],</span>
<span id="cb16-124"><a href=""></a>            cmap <span class="op">=</span> <span class="st">"viridis"</span>,</span>
<span id="cb16-125"><a href=""></a>            vmin <span class="op">=</span> row_min,</span>
<span id="cb16-126"><a href=""></a>            vmax <span class="op">=</span> row_max</span>
<span id="cb16-127"><a href=""></a>        )</span>
<span id="cb16-128"><a href=""></a>        ax.set_xticks([])</span>
<span id="cb16-129"><a href=""></a>        ax.set_yticks([])</span>
<span id="cb16-130"><a href=""></a></span>
<span id="cb16-131"><a href=""></a>        <span class="cf">if</span> d <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb16-132"><a href=""></a>            ax.set_title(<span class="ss">f"X</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">14</span>, color<span class="op">=</span><span class="st">"white"</span>, backgroundcolor<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb16-133"><a href=""></a>        <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb16-134"><a href=""></a>            ax.set_ylabel(</span>
<span id="cb16-135"><a href=""></a>                <span class="ss">f"Digit </span><span class="sc">{</span>d<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb16-136"><a href=""></a>                fontsize <span class="op">=</span> <span class="dv">14</span>,</span>
<span id="cb16-137"><a href=""></a>                color    <span class="op">=</span> <span class="st">"white"</span>,</span>
<span id="cb16-138"><a href=""></a>                backgroundcolor <span class="op">=</span> <span class="st">"black"</span>,</span>
<span id="cb16-139"><a href=""></a>                rotation <span class="op">=</span> <span class="dv">0</span>,</span>
<span id="cb16-140"><a href=""></a>                labelpad <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb16-141"><a href=""></a>            )</span>
<span id="cb16-142"><a href=""></a></span>
<span id="cb16-143"><a href=""></a><span class="co"># Add a single, tall colorbar on the right</span></span>
<span id="cb16-144"><a href=""></a>cax <span class="op">=</span> fig.add_axes([<span class="fl">0.94</span>, <span class="fl">0.05</span>, <span class="fl">0.015</span>, <span class="fl">0.9</span>])  <span class="co"># [left, bottom, width, height]</span></span>
<span id="cb16-145"><a href=""></a>cbar <span class="op">=</span> plt.colorbar(im, cax<span class="op">=</span>cax, orientation<span class="op">=</span><span class="st">"vertical"</span>)</span>
<span id="cb16-146"><a href=""></a>cbar.set_label(<span class="st">"Avg c-MWP"</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb16-147"><a href=""></a>cbar.ax.tick_params(labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb16-148"><a href=""></a></span>
<span id="cb16-149"><a href=""></a>out_path <span class="op">=</span> os.path.join(<span class="st">"figures"</span>, <span class="st">"average_cmwp_per_digit_wide.png"</span>)</span>
<span id="cb16-150"><a href=""></a>plt.savefig(out_path, dpi<span class="op">=</span><span class="dv">180</span>, bbox_inches<span class="op">=</span><span class="st">"tight"</span>)</span>
<span id="cb16-151"><a href=""></a>plt.close(fig)</span>
<span id="cb16-152"><a href=""></a></span>
<span id="cb16-153"><a href=""></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Saved the wide 10×5 grid → </span><span class="sc">{</span>out_path<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-auto-generated-content">
<div class="footer footer-default">

</div>
</div>
</section></section>
    </div>
  </div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="index_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="index_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="index_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="index_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="index_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="index_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="index_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="index_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="index_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="index_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        // For code content inside modals, clipBoardJS needs to be initialized with a container option
        // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp('/' + window.location.host + '/');
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    <script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","openEffect":"zoom","selector":".lightbox","loop":false,"descPosition":"bottom"});
    (function() {
      let previousOnload = window.onload;
      window.onload = () => {
        if (previousOnload) {
          previousOnload();
        }
        lightboxQuarto.on('slide_before_load', (data) => {
          const { slideIndex, slideNode, slideConfig, player, trigger } = data;
          const href = trigger.getAttribute('href');
          if (href !== null) {
            const imgEl = window.document.querySelector(`a[href="${href}"] img`);
            if (imgEl !== null) {
              const srcAttr = imgEl.getAttribute("src");
              if (srcAttr && srcAttr.startsWith("data:")) {
                slideConfig.href = srcAttr;
              }
            }
          } 
        });
      
        lightboxQuarto.on('slide_after_load', (data) => {
          const { slideIndex, slideNode, slideConfig, player, trigger } = data;
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(slideNode);
          }
        });
      
      };
      
    })();
              </script>
    

</body></html>